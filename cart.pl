#!/usr/bin/perl

# "Dansie Shopping Cart"
$version = "3.73";
# A Perl Shopping Cart
# By Dansie Website Design
# Copyright ï¿½ Dec 10, 1997-2009
# www.dansie.net
# cart@dansie.net
# May not be used without purchasing a license. Do not attempt to run this
# script on a site other than which it was licensed for. 

# Script licensed to: Joseph Bautista
# Script licensed for use on only one (1) of these domains: sorbentsystems.com

# Modification of this script other than:
# 1. Adjusting the perl path in the first line above.
# 2. Or setting the $vars variable below.
# May void your license without refund, your right to technical support and subject you to legal action.

# In some cases the first line above may need to be set to: #!/usr/local/bin/perl
# Or: #!/usr/bin/perl5

# Set this $vars variable to the system path location of your vars.dat file if this
# script can't auto detect it's location or if you wish to rename or relocate
# the vars.dat file. See section 7 in the ReadMe for details.
# http://www.dansie.net/cart_readme.html

$vars = "";

#####################################################################
### END OF ALL VARIABLES. DO NOT ATTEMPT TO RUN THIS SCRIPT ON A  ###
### SITE OTHER THAN WHICH IT WAS LICENSED FOR. DO NOT MODIFY THE  ###
### SCRIPT EXCEPT FOR THE $vars VARIABLE OR PERL PATH ABOVE.      ###
### MODIFYING THE SCRIPT MAY TERMINATE YOUR LICENSE WITHOUT       ###
### REFUND, YOUR RIGHT TO TECHNICAL SUPPORT AND SUBJECT YOU TO    ###
### LEGAL ACTION.                                                 ###
#####################################################################

 if ( (!$vars) && ($ENV{'REMOTE_ADDR'} eq "127.0.0.1") ) { $vars = "C:/Dansie/Dansie_Cart/cgi-bin/vars.dat"; } $flock = 1; if (!$ENV{'DOCUMENT_ROOT'}) { $flock = 0; } if ($ENV{'PATH'}) { $flock = 0; } $delimiter = "|"; $delimiter2 = "\\" . "$delimiter"; $product_delimiter = ','; $custom_description_delimiter = "::"; $merchant_security = 1; $old_multi_item_form = 0; $diagnostics = 0; $allow_htpasswd_write = 1; $allow_passwords_with_ssl_pl_check_draft = 0; $mod_perl_no_headers = 0; if ($mod_perl_no_headers) { use CGI qw(:standard); } $state_length = 25; $maxlength_name = 70; $maxlength_company = 70; $maxlength_address = 70; $maxlength_city = 70; $maxlength_zip = 20; $maxlength_country = 40; $maxlength_phone = 30; $maxlength_email = 50; $shipping_calculated_on_subtotal_before_coupon_discounts = 1; $vars_variable_set = "$vars"; if (!$vars && $ENV{'OS'} !~ /Windows_NT/i && $ENV{'DOCUMENT_ROOT'} ) { $vars = "$0"; $vars =~ s/\\/\//g; $vars =~ /^(.+)(\/)(.+)$/; $vars = "$1/vars.dat"; $script_root2 = "$ENV{'SCRIPT_NAME'}"; $script_root2 = reverse($script_root2); until ($script_root2 !~ /\//) { chop($script_root2); } $script_root2 = reverse($script_root2); $script_root2 = "$script_root/$script_root2"; if (!-e"$vars") { $vars = `pwd`; chop($vars); $script_root = "$vars"; $vars .= "/vars.dat"; $script_root2 = "$ENV{'SCRIPT_NAME'}"; $script_root2 = reverse($script_root2); until ($script_root2 !~ /\//) { chop($script_root2); } $script_root2 = reverse($script_root2); $script_root2 = "$script_root/$script_root2"; } if (!-e"$vars") { $script_root = $ENV{'SCRIPT_NAME'}; $script_root2 = "$ENV{'DOCUMENT_ROOT'}$ENV{'SCRIPT_NAME'}"; $a = ""; until ($a eq "/" || $script_root eq "") { $a = chop($script_root); } $script_root = "$ENV{'DOCUMENT_ROOT'}$script_root"; $vars = "$script_root/vars.dat"; } if (!-e"$vars") { $script_root = $ENV{'SCRIPT_FILENAME'}; $script_root2 = $ENV{'SCRIPT_FILENAME'}; $a = ""; until ($a eq "/" || $script_root eq "") { $a = chop($script_root); } $vars = "$script_root/vars.dat"; } } if (!$vars && $ENV{'OS'} =~ /Windows_NT/i ) { if ($ENV{'PATH_TRANSLATED'}) { $script_root = $ENV{'PATH_TRANSLATED'}; $script_root2 = $ENV{'PATH_TRANSLATED'}; } if ($ENV{'DOCUMENT_ROOT'}) { $temp = "$ENV{'DOCUMENT_ROOT'}"; while ($temp =~ /[\\|\/]$/) { chop($temp); } if (!-e "$temp$ENV{'SCRIPT_NAME'}") { $a = ""; until ($a eq "/" || $a eq "\\" || $temp eq "") { $a = chop($temp); } } $script_root = "$temp$ENV{'SCRIPT_NAME'}"; $script_root2 = "$temp$ENV{'SCRIPT_NAME'}"; } $script_root =~ s/\\/\//g; $script_root2 =~ s/\\/\//g; $a = ""; until ($a eq "/" || $script_root eq "") { $a = chop($script_root); } $vars = "$script_root/vars.dat"; } if ( ((!-e "$vars") || (!$vars)) && (!$ENV{'OS'}) ) { if ($ENV{'DOCUMENT_ROOT'}) { $vars = `pwd`; } chop($vars); $script_root = "$vars"; $vars .= "/vars.dat"; $script_root2 = "$ENV{'SCRIPT_NAME'}"; $script_root2 = reverse($script_root2); until ($script_root2 !~ /\//) { chop($script_root2); } $script_root2 = reverse($script_root2); $script_root2 = "$script_root/$script_root2"; } if ((!-e "$vars") && !$ENV{'DOCUMENT_ROOT'} && !$ENV{'OS'} ) { $script_root = "$ENV{'PATH'}"; while ( $script_root =~ /;/ ) { chop($script_root); } $script_root .= "$ENV{'SCRIPT_NAME'}"; $script_root2 = "$script_root"; $script_root =~ s/\\/\//g; $script_root2 =~ s/\\/\//g; $a = ""; until ($a eq "/" || $script_root eq "") { $a = chop($script_root); } $vars = "$script_root/vars.dat"; } if ( ( (!-e "$vars") || (!$vars) ) && (!$ENV{'OS'}) ) { $vars = `pwd`; chop($vars); $script_root = "$vars"; $vars .= "/vars.dat"; $script_root2 = "$ENV{'SCRIPT_NAME'}"; $script_root2 = reverse($script_root2); until ($script_root2 !~ /\//) { chop($script_root2); } $script_root2 = reverse($script_root2); $script_root2 = "$script_root/$script_root2"; } if ( ((!-e "$script_root2") && (!-e "$vars")) || (( $script_root2 !~ /cart/i ) && (!-e "$vars"))  ) { if (!$script_root2) { $script_root2 = "$vars"; $a = ""; until ($a eq "/" || $script_root2 eq "") { $a = chop($script_root2); } } &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but the cart script can't auto detect it's system path at: <B>\"$script_root2\"</B> because your host has unusual environment variables.</H3></CENTER><BR>"; print "<UL><LI>First, Make sure that your <B>vars.dat</B> file is in the same directory as the cart.pl script. <LI>You may need to set one variable manually at the top of the cart.pl script. See the <B>ReadMe</B> section 7 for detailed instructions.</UL><BR>"; print "<B>Ways to determine your system paths:</B><BR>"; print "<UL><LI>The system path found in the location window at the top of your FTP browser may give you the system path of the <B>cart.pl</B> script.<BR>"; print "<LI>Your <A HREF=\"http://$ENV{'HTTP_HOST'}$ENV{'SCRIPT_NAME'}?env\">System's Environment Variables</A> may be of help determining your system paths.<BR>"; print "<LI>Try the cart script's <A HREF=\"http://$ENV{'HTTP_HOST'}$ENV{'SCRIPT_NAME'}?path\">path detection tool</A>.<BR>"; print "<LI>If you still can't figure it out, ask your host what the system path to the <B>cart.pl</B> script would be.</UL><BR>"; &footer; } &cant_find_vars; $br_sub = "kd9f3"; if ( $ENV{'CONTENT_TYPE'} !~ /multipart\/form\-data/i ) { &parse_form_data; } &merchant; if ( $version !~ /(Mall Version)/ ) { $FORM{'merchant'} = ""; } open(VARS,"$vars"); if ($flock) { flock(VARS, 2); } @vars = <VARS>; if ($flock) { flock(VARS, 8); } close(VARS); if ( $vars[0] =~ /Location:/ ) { &redirect_mall_merchant; } foreach $line (@vars) { chop($line); if ($line =~ /\n$/) { chop($line); } if ($line =~ /\r$/) { chop($line); } if ($line =~ /\s$/) { chop($line); } $line =~ s/(.+)(-->)( )(.+)/$1$2$4/; $line =~ s/'/`/g; $line =~ s/\\`/'/g; } while ( $vars_variable_set =~ /\/$/ ) { chop($vars_variable_set); } $vars_size = @vars; if ($vars_size < 90 || $vars_size > 250) { if ( ($vars_variable_set) && (-d "$vars_variable_set") ) { &header; print "<H3>Dansie Shopping Cart configuration warning!<BR>If you want to define the \$vars variable near the top of the cart.pl script, make sure that the system path you set ends with \"vars.dat\".<BR>Example:<BR>$vars_variable_set/vars.dat</H3>"; &diagnostics; &footer; } else { &header; print "<H3>Dansie Shopping Cart configuration warning!<BR>Your vars.dat file appears to be corrupt. Check to make sure that you only have one line break per variable line. No more and no less. Also, upload the vars.dat file in ASCII format via FTP and not binary format. You can get a new vars.dat file in the latest <A HREF=\"http://www.dansie.net/cart_readme.html\">ReadMe package</A>.</H3>"; &diagnostics; &footer; } } if ( $vars[0] !~ /^\#\#\# HOST VARIABLES \#\#\# \(DO NOT REMOVE OR ALTER THIS LINE\)/i ) { &header; print "<H3>Dansie Shopping Cart configuration warning!<BR>Your vars.dat file appears to be corrupt. Check to make sure that you only edit the vars.dat file with a plain text editor, not an HTML editor. Also, upload the vars.dat file in ASCII format via FTP and not binary format. You can get a new vars.dat file in the latest <A HREF=\"http://www.dansie.net/cart_readme.html\">ReadMe package</A>.</H3>"; &diagnostics; &footer; } $n = 0; $n2 = 0; $vn = 0; foreach $line (@vars) { if (!$skip_to_next_section) { if ( ($line =~ /^\#\#\#/) ) { push(@vars2,"$line"); $n2++; $vn = 0; } elsif ( ($line =~ /-->/) ) { $line =~ /^(\d{1,2})(\D)(.*)/; $line_number = $1; if ($vars[$n+1] =~ /-->/) { $vars[$n+1] =~ /^(\d{1,2})(\D)(.*)/; $next_line_number = $1; $missing_line_breaks = ($next_line_number - ($line_number + 1) ); } $line_number2 = $line_number + 1; if ($line =~ /($line_number)(.*)(-->)(.*)($line_number2)(.*)(-->)(.*)/) { $line = "$1$2$3$4"; $line2 = "$5$6$7$8"; } push(@vars2,"$line"); $n2++; $vn++; if ($line2) { push(@vars2,"$line2"); $n2++; $vn++; $line2 = ""; $missing_line_breaks--; } if ($missing_line_breaks) { for($i=0;$i<$missing_line_breaks;$i++) { push(@vars2,""); $n2++; $vn++; } } } else { if ($n2>0) { $vars2[$n2-1] = "$vars2[$n2-1] $line"; if (!$line) { $skip_to_next_section = 1; } } } } elsif ($line =~ /^\#\#\#/) { $skip_to_next_section = 0; push(@vars2,"$line"); $n2++; $vn = 0; } $n++; } (@vars) = (@vars2); $a = ""; shift(@vars); until ( $a =~ /^\#\#\#/ ) { $a = shift(@vars); if ( $a !~ /^\#\#\#/ ) { push(@host_vars,$a); } } $a = ""; until ( $a =~ /^\#\#\#/ ) { $a = shift(@vars); if ( $a !~ /^\#\#\#/ ) { push(@personal_vars,$a); } } $a = ""; until ( $a =~ /^\#\#\#/ ) { $a = shift(@vars); if ( $a !~ /^\#\#\#/ ) { push(@cambist_vars,$a); } } $a = ""; until ( $a =~ /^\#\#\#/ ) { $a = shift(@vars); if ( $a !~ /^\#\#\#/ ) { push(@database_vars,$a); } } if ( ($host_vars[0] !~ /http/i) && ($host_vars[0] !~ /https/i) ) { @host_vars = ("$host_vars[4]","$host_vars[5]","$host_vars[6]","$host_vars[8]","$host_vars[9]","$host_vars[0]","$host_vars[1]","$host_vars[2]","$host_vars[3]","$host_vars[10]","$host_vars[7]"); } if ( $FORM{'merchant'} && $merchant_security ) { open(VARS,"$default_master_vars"); if ($flock) { flock(VARS, 2); } @default_master_vars = <VARS>; if ($flock) { flock(VARS, 8); } close(VARS); ($trash,$temp) = split(/--\>/,"$host_vars[0]"); ($trash,$temp2) = split(/--\>/,"$default_master_vars[1]"); if ( $temp =~ /\n$/ ) { chop($temp); } if ( $temp2 =~ /\n$/ ) { chop($temp2); } if ( $temp =~ /^(http)(s)(.+)$/ ) { $temp = "$1$3"; if ( $temp eq "$temp2" ) { $do_not_use_master_hv1 = 1; } } $host_vars[0] = $default_master_vars[1] if (!$do_not_use_master_hv1); $host_vars[5] = $default_master_vars[6]; $host_vars[6] = $default_master_vars[7]; while ($host_vars[0] =~ /(\n|\r|\s)$/) { chop($host_vars[0]); } while ($host_vars[5] =~ /(\n|\r|\s)$/) { chop($host_vars[5]); } while ($host_vars[6] =~ /(\n|\r|\s)$/) { chop($host_vars[6]); } $host_vars[7] = ""; $host_vars[8] = ""; $host_vars[9] = ""; ($trash,$temp) = split(/--\>/,"$database_vars[0]"); if ($temp) { $vars_path_temp = $vars; $vars_path_temp =~ s/(.+)(\/)(.+)/$1$2/g; if ( $temp !~ /^($vars_path_temp)/) { $database_vars[0] = ""; } } if ( $personal_vars[79-1] =~ /^(79 Referral ID -->)(.*)/ && $2 eq "" ) { foreach (@default_master_vars) { if ( $_ =~ /^(79 Referral ID -->)(.+)/ ) { $personal_vars[79-1] = "79 Referral ID -->$2"; last; } } } if ( $personal_vars[79-1] !~ /^(79 Referral ID -->)/ ) { foreach (@default_master_vars) { if ( $_ =~ /^(79 Referral ID -->)(.+)/ ) { $merchant_lacks_pv79 = "$2"; last; } } } } ($trash,$path3) = split(/-->/,shift(@host_vars)); if ( ($ENV{'HTTP_HOST'} eq "www.dansie.net") && $FORM{'merchant'} ) { $path3 = "http://www.dansie.net/cgi-bin/scripts/cart.pl"; } ($trash,$path4) = split(/-->/,shift(@host_vars)); if ( $path4 !~ /\/{2}(.+)\/{1}/ ) { $path4 = "$path4/"; } ($trash,$base_img_url) = split(/-->/,shift(@host_vars)); $base_img_url =~ s/(.*)(\/)$/$1/; ($trash,$image) = split(/-->/,shift(@host_vars)); ($trash,$wp) = split(/-->/,shift(@host_vars)); ($trash,$mailprog) = split(/-->/,shift(@host_vars)); if ( $mailprog =~ /^(no_f_switch)($delimiter2)(.+)$/i ) { ($trash,$trash,$mailprog) = split(/$delimiter2/,$mailprog); $no_f_switch = 1; } if ( $mailprog =~ /^(socket)($delimiter2)(.+)$/i ) { ($trash,$socket_smtp_server,$socket_return_path) = split(/$delimiter2/,$mailprog); } elsif ( $mailprog =~ /$delimiter2/ ) { ($mailprog,$blat_server) = split(/$delimiter2/,$mailprog); $blat_server = " -server " . "$blat_server"; } if (!$mailprog) { @common_sendmail_paths = ("/usr/sbin/sendmail", "/usr/lib/sendmail", "/usr/bin/sendmail", "/bin/sendmail", "/var/qmail/bin/qmail-inject", "/usr/home/stormer/bin/sendmail", "/bin/cgimail", "C:/winnt/system32/windmail.exe", "C:/winnt/system32/blat.exe", "c:/windmail/windmail.exe", 'C:\httpd\windmail\windmail.exe', 'C:\httpd\Blat\Blat.exe'); foreach (@common_sendmail_paths) { if (-e "$_") { $mailprog = "$_"; last; } } } if ( ($ENV{'HTTP_HOST'} eq "www.dansie.net") && $FORM{'merchant'} ) { $mailprog = "/usr/sbin/sendmail"; } ($trash,$date_command) = split(/-->/,shift(@host_vars)); if ( ($ENV{'HTTP_HOST'} eq "www.dansie.net") && $FORM{'merchant'} ) { $date_command = "/bin/date"; } $temp = $date_command; while ($temp =~ / /) { chop($temp); } if (!-e "$temp") { $date_command = ""; } ($trash,$path1) = split(/-->/,shift(@host_vars)); $path1 =~ s/\\/\//g; if (!$path1) { $path1_is_blank = 1; } if ( (!$path1) ) { $path1 = "$vars"; $a = ""; until ($a eq "/" || $path1 eq "") { $a = chop($path1); } $path1_backup = "$path1/carts"; $path1 = "$path1/temp"; if (-e "$path1_backup") { $path1 = "$path1_backup"; } } if (!$path1) { $path1 = "$script_root/carts"; } if ($path1 eq $script_root) { &diagnostics; &header; print "<H3>Dansie Shopping Cart configuration warning!<BR>Your \"temp\" directory is the same as the directory your cart.pl script is in!<BR>May I suggest \"$path1/temp\" as the directory for Host Variable #8 ?<BR>Please see the ReadMe about Host Variable #8.</H3>"; &footer; } if ($path1 =~ /^http/i) { &diagnostics; &header; print "<H3>Dansie Shopping Cart configuration message:<BR>Please leave Host Variable #8 in your vars.dat file blank.</H3>"; &footer; } if (!-e "$path1") { &diagnostics; $path1 = &untaint("$path1"); mkdir("$path1",0777); if ( $ENV{'OS'} !~ /Windows_NT/i ) { `chmod 777 $path1`; } } if ( (!-w "$path1") || (!-e "$path1") ) { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but you forgot to create your <b>\"$path1\"</B> directory and set permissions as writable (chmod it 777 on Unix).</H3></CENTER><BR>"; print "You need to create a directory called \"temp\" in the same directory your vars.dat file is located in and set permissions as writable (chmod this directory \"temp\" 777 if you are on a Unix host).<BR><BR>"; &footer; } ($trash,$path2) = split(/-->/,shift(@host_vars)); $path2 =~ s/\\/\//g; if ( (!$path2) ) { $path2 = "$vars"; $a = ""; until ($a eq "/" || $path2 eq "") { $a = chop($path2); } $path2_backup = "$path2/invoice.dat"; $path2 = "$path2/shopperid.dat"; if (-e "$path2_backup") { $path2 = "$path2_backup"; } } if ($path2 =~ /^http/i) { &diagnostics; &header; print "<H3>Dansie Shopping Cart configuration message:<BR>Please leave Host Variable #9 in your vars.dat file blank.</H3>"; &footer; } if (!-e "$path2") { &diagnostics; $path2 = &untaint("$path2"); open(FILE, ">$path2"); print FILE "0"; close(FILE); if ( $ENV{'OS'} !~ /Windows_NT/i ) { `chmod 777 $path2`; } } if ( (!-w "$path2") || (!-e "$path2") ) { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but you forgot to create your <b>\"$path2\"</B> file and set permissions as writable (chmod it 777 on Unix).</H3></CENTER><BR>"; print "The script needs to be able to keep a count file called \"shopperid.dat\" in order to assign shopper ID numbers to your customers. The default location for this is in the same directory your vars.dat file is located in. Create an empty file named \"shopperid.dat\" and upload it with your FTP program into the same directory that your vars.dat file is located in and set permissions on \"shopperid.dat\" as writable (chmod 777 on Unix).<BR><BR>"; &footer; } ($trash,$lang_path) = split(/-->/,shift(@host_vars)); $lang_path =~ s/\\/\//g; &find_lang; ($trash,$target_name) = split(/-->/,shift(@host_vars)); if (!$target_name) { $target_name = ""; } ($trash,$ssl_target_page) = split(/-->/,shift(@host_vars)); while ( $ssl_target_page =~ /\s$/ ) { chop($ssl_target_page); } if ( $ssl_target_page && $ssl_target_page !~ /\/{2}(.+)\/{1}/ ) { $ssl_target_page = "$ssl_target_page/"; } if (!$ssl_target_page) { $ssl_target_page = "$path4"; } ($trash,$merchant_passwords) = split(/-->/,shift(@host_vars)); while ( $merchant_passwords =~ /\s$/ ) { chop($merchant_passwords); } ($trash,$login_ssl_url) = split(/-->/,shift(@host_vars)); while ( $login_ssl_url =~ /\s$/ ) { chop($login_ssl_url); } if (!$login_ssl_url) { $login_ssl_url = "$path3"; } ($trash,$customs) = split(/-->/,shift(@personal_vars)); ($trash,$myemail) = split(/-->/,shift(@personal_vars)); $myemail =~ s/ /\,/g; $myemail =~ s/\,\,/\,/g; $myemail =~ s/\,\,/\,/g; @myemail = split(/\,/,$myemail); ($trash,$ext) = split(/-->/,shift(@personal_vars)); $ext = "." . "$ext"; ($trash,$bizname) = split(/-->/,shift(@personal_vars)); ($trash,$payable) = split(/-->/,shift(@personal_vars)); ($trash,$guarantee) = split(/-->/,shift(@personal_vars)); ($trash,$add1) = split(/-->/,shift(@personal_vars)); ($trash,$add2) = split(/-->/,shift(@personal_vars)); ($trash,$add3) = split(/-->/,shift(@personal_vars)); ($trash,$add4) = split(/-->/,shift(@personal_vars)); ($trash,$add5) = split(/-->/,shift(@personal_vars)); ($trash,$tax_allow) = split(/-->/,shift(@personal_vars)); ($trash,$temp) = split(/-->/,shift(@personal_vars)); @state = split(/\,/,$temp); if (!$state[0]) { $state[0] = "Calif"; } ($trash,$temp) = split(/-->/,shift(@personal_vars)); $temp =~ s/\%//g; @tax = split(/\,/,$temp); if ( $tax_allow == 2 || $tax_allow == 4 ) { @state = $state[0]; @tax = $tax[0]; } if ( !@tax ) { $tax[0] = 1; } while ( @state > @tax ) { push(@tax,"0"); } ($trash,$bgcolor) = split(/-->/,shift(@personal_vars)); if ( $bgcolor =~ /^#(\w\w)(\w\w)(\w\w)/ ) { $temp = "#$1$2$3"; $temp =~ s/O/0/gi; $bgcolor =~ s/^(#\w\w\w\w\w\w)/$temp/; $bgcolor =~ /^#(\w\w)(\w\w)(\w\w)/; $link_bg = "#$1$2$3"; $red =   hex("$1"); $green = hex("$2"); $blue =  hex("$3"); $average_color = int ( ( $red + $green + $blue ) / 3 ); if ( $average_color > (255/2) ) { $link_font = "#000000"; } else { $link_font = "#FFFFFF"; } } else { $link_bg = "#FFFFFF"; $link_font = "#000000" } ($trash,$font2) = split(/-->/,shift(@personal_vars)); ($trash,$font_face2) = split(/-->/,shift(@personal_vars)); ($trash,$font_size2) = split(/-->/,shift(@personal_vars)); ($trash,$font1) = split(/-->/,shift(@personal_vars)); ($trash,$font_face1) = split(/-->/,shift(@personal_vars)); ($trash,$font_size1) = split(/-->/,shift(@personal_vars)); ($trash,$img_borders) = split(/-->/,shift(@personal_vars)); ($trash,$expire) = split(/-->/,shift(@personal_vars)); if (!$expire) { $expire = "1"; } ($trash,$option1) = split(/-->/,shift(@personal_vars)); ($trash,$option2) = split(/-->/,shift(@personal_vars)); ($trash,$option3) = split(/-->/,shift(@personal_vars)); ($trash,$ship_allow) = split(/-->/,shift(@personal_vars)); ($trash,$show_ship) = split(/-->/,shift(@personal_vars)); ($trash,$temp) = split(/-->/,shift(@personal_vars)); @method = split(/\,/,$temp); ($trash,$temp) = split(/-->/,shift(@personal_vars)); @method_init_price = split(/\,/,$temp); ($trash,$temp) = split(/-->/,shift(@personal_vars)); @method_price = split(/\,/,$temp); ($trash,$wt) = split(/-->/,shift(@personal_vars)); ($trash,$map_domain) = split(/-->/,shift(@personal_vars)); ($trash,$temp) = split(/-->/,shift(@personal_vars)); @shipping_locations = split(/\,/,$temp); ($trash,$temp) = split(/-->/,shift(@personal_vars)); @shipping_via_amount = split(/$delimiter2/,$temp); ($trash,$symbol) = split(/-->/,shift(@personal_vars)); if ($symbol =~ /$delimiter2/) { ($symbol,$decimals,$currency_sep) = split(/$delimiter2/,$symbol); } else { if (!$decimals) { $decimals = "2"; } if (!$currency_sep) { $currency_sep = ","; } } if (!$symbol) { $symbol = "\$"; } if ($symbol =~ /\n$/) { chop($symbol); } if ($decimals =~ /\n$/) { chop($decimals); } if ($currency_sep =~ /\n$/) { chop($currency_sep); } if ($decimals < 0) { $decimals = 0; } $decimals2 = $decimals; $decimals = '%9.' . "$decimals" . 'f'; ($trash,$customer_mail) = split(/-->/,shift(@personal_vars)); if (!$customer_mail) { $customer_mail = 0; } ($trash,$address_table_bgcolor) = split(/-->/,shift(@personal_vars)); if (!$address_table_bgcolor) { $address_table_bgcolor = "#FFFFFF"; } ($trash,$ip_or_cookie) = split(/-->/,shift(@personal_vars)); ($trash,$borders2) = split(/-->/,shift(@personal_vars)); if ($borders2<1) { $borders2 = 0; } ($trash,$table_width) = split(/-->/,shift(@personal_vars)); if (!$table_width) { $table_width = "90\%"; } if ( $table_width < 400 && $table_width !~ /\%/ ) { $table_width = $table_width . "\%"; } ($trash,$option4) = split(/-->/,shift(@personal_vars)); if ($option4 =~ /$delimiter2/ ) { ($option4,$icheck_currency) = split(/$delimiter2/,$option4); } if ( @personal_vars < 1 ) { $use_state = 1; } else { ($trash,$use_state) = split(/-->/,shift(@personal_vars)); } if ( @personal_vars < 1 ) { $show_bizname = 1; } else { ($trash,$show_bizname) = split(/-->/,shift(@personal_vars)); } ($trash,$option5) = split(/-->/,shift(@personal_vars)); if ( $symbol ne "\\") { $option5 =~ s/($symbol)//; } ($trash,$comments) = split(/-->/,shift(@personal_vars)); ($trash,$reqired_field_prefs) = split(/-->/,shift(@personal_vars)); ($trash,$force_no_script) = split(/-->/,shift(@personal_vars)); ($trash,$add_and_redirect) = split(/-->/,shift(@personal_vars)); ($trash,$i_check_id) = split(/-->/,shift(@personal_vars)); if ($i_check_id =~ /$delimiter2/ ) { ($i_check_id,$exchange_rate) = split(/$delimiter2/,$i_check_id); } ($trash,$check_wp) = split(/-->/,shift(@personal_vars)); if (!$check_wp) { $check_wp = "$address_table_bgcolor"; } ($trash,$webstore_discount) = split(/-->/,shift(@personal_vars)); ($trash,$signature) = split(/-->/,shift(@personal_vars)); if ( $signature eq "default" ) { $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; $signature = "$biz_temp\|" . "$ssl_target_page" . "\|$myemail[0]"; } ($trash,$paper_font_color) = split(/-->/,shift(@personal_vars)); if ( $paper_font_color =~ /$delimiter2/ ) { ($paper_font_color,$paper_wp) = split(/$delimiter2/,$paper_font_color); } ($trash,$vars_security) = split(/-->/,shift(@personal_vars)); ($trash,$meta_tag) = split(/-->/,shift(@personal_vars)); $meta_temp = "$meta_tag"; while ( $meta_temp ) { $a = chop($meta_temp); if ($a =~ /"/) { $meta_temp2++; } } if ( ($meta_temp2 / 2) != ( int($meta_temp2 / 2) )  ) { $meta_tag = ""; } $meta_tag =~ s/\&lt\;/\</g; $meta_tag =~ s/\&gt\;/\>/g; ($trash,$email_content_type) = split(/-->/,shift(@personal_vars)); if ( !$FORM{merchant} ) { $email_content_type =~ s/\|/\n/g; } ($trash,$email_encoding) = split(/-->/,shift(@personal_vars)); ($trash,$coupon_discount) = split(/-->/,shift(@personal_vars)); ($trash,$check_draft_image) = split(/-->/,shift(@personal_vars)); ($trash,$fix_int_quantity) = split(/-->/,shift(@personal_vars)); ($trash,$option6) = split(/-->/,shift(@personal_vars)); ($trash,$suppress_desc) = split(/-->/,shift(@personal_vars)); ($trash,$add_top_or_bottom) = split(/-->/,shift(@personal_vars)); ($trash,$invoice_prefix) = split(/-->/,shift(@personal_vars)); if ($invoice_prefix =~ / $/) { chop($invoice_prefix); } ($trash,$authorized_referrers) = split(/-->/,shift(@personal_vars)); while ($authorized_referrers =~ /(\n|\r|\s|\,)$/) { chop($authorized_referrers); } $authorized_referrers =~ s/\,\,/\,/; $authorized_referrers =~ s/^\,//; (@authorized_referrers) = split(/\,/,$authorized_referrers); foreach (@authorized_referrers) { $_ =~ s/^ //; $_ =~ s/ $//; $_ =~ s/^(www\.)//; } ($trash,$empty_entire_cart) = split(/-->/,shift(@personal_vars)); ($trash,$minimum_order) = split(/-->/,shift(@personal_vars)); while ($minimum_order =~ /(\n|\r|\s)$/) { chop($minimum_order); } $minimum_order =~ s/\$//g; ($minimum_order,$maximum_order) = split(/\|/,$minimum_order); ($trash,$tracking_file) = split(/-->/,shift(@personal_vars)); while ($tracking_file =~ /(\n|\r|\s|\,)$/) { chop($tracking_file); } if ( $tracking_file =~ /\|/ ) { ($ssl_tracking_dir,$tracking_file) = split(/\|/,"$tracking_file"); } if ( $FORM{'merchant'} && $merchant_security && $tracking_file ) { $tracking_file2 = "$vars"; $a = ""; until ($a eq "/" || $tracking_file2 eq "") { $a = chop($tracking_file2); } if ( $tracking_file !~ /($tracking_file2)/i ) { $tracking_file = "$tracking_file2/tracking.dat"; } $tracking_file =~ s/\.\.\///g; $tracking_file =~ s/\.\.//g; } if ( ($tracking_file) && (-e "$tracking_file") && (!-w "$tracking_file") ) { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but you forgot to create your tracking.dat file at this location: <b>\"$tracking_file\"</B> and set permissions as writable (chmod it 777 on Unix).</H3></CENTER><BR>"; print "The script needs to be able to write to this file in order to do perform the order tracking feature described in Personal Variable #69 of the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=\"ReadMe\">ReadMe</A>. Create this file and upload it with your FTP program and set permissions on it as writable (chmod 777 on Unix). If you do not wish to use this feature, then leave PV#69 in your vars.dat file blank.<BR><BR>"; &footer; } if ( $FORM{'merchant'} ) { $ssl_tracking_dir = ""; } ($trash,$use_company_name_field) = split(/-->/,shift(@personal_vars)); while ($use_company_name_field =~ /(\n|\r|\s|\,)$/) { chop($use_company_name_field); } ($trash,$aux_processor_payment_option) = split(/-->/,shift(@personal_vars)); while ($aux_processor_payment_option =~ /(\n|\r|\s|\,)$/) { chop($aux_processor_payment_option); } ($trash,$email_receipt_tables) = split(/-->/,shift(@personal_vars)); while ($email_receipt_tables =~ /(\n|\r|\s|\,)$/) { chop($email_receipt_tables); } (@email_receipt_tables) = split(/\|/,"$email_receipt_tables"); ($trash,$shipping_weight_total) = split(/-->/,shift(@personal_vars)); ($trash,$state_list) = split(/-->/,shift(@personal_vars)); ($trash,$country_list) = split(/-->/,shift(@personal_vars)); while ($country_list =~ /(\n|\r|\s|\,)$/) { chop($country_list); } ($trash,$sales_tax_state_verification) = split(/-->/,shift(@personal_vars)); while ($sales_tax_state_verification =~ /(\n|\r|\s|\,)$/) { chop($sales_tax_state_verification); } ($sales_tax_state_verification,$assess_tax_on_shipping_or_billing_state) = split(/\|/,"$sales_tax_state_verification"); if ($assess_tax_on_shipping_or_billing_state ne "shipping" && $assess_tax_on_shipping_or_billing_state ne "billing") { $assess_tax_on_shipping_or_billing_state = "shipping"; } ($trash,$htpasswd) = split(/-->/,shift(@personal_vars)); while ($htpasswd =~ /(\n|\r|\s|\,)$/) { chop($htpasswd); } if ( ( $FORM{'merchant'} && !$merchant_security ) || ( !$FORM{'merchant'} && $merchant_security ) || ( !$FORM{'merchant'} && !$merchant_security ) ) { if ( $htpasswd && ( (!-w "$htpasswd") || (!-e "$htpasswd") ) ) { &diagnostics; &header; print "<CENTER><H3>It appears you have set Personal Variable #77 so that you can have random passwords appended to to your .htpasswd file. Make sure to create your <b>\"$htpasswd\"</B> file and set writable permissions. For more details on this, see \"Sell Passwords\" in section 14 of the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=ReadMe>ReadMe</A>.</H3></CENTER><BR>"; &footer; } } else { $htpasswd = ""; } ($trash,$deny_email_domains) = split(/-->/,shift(@personal_vars)); while ($deny_email_domains =~ /(\n|\r|\s|\,)$/) { chop($deny_email_domains); } @deny_email_domains = split(/\,/,"$deny_email_domains"); ($trash,$referral_id) = split(/-->/,shift(@personal_vars)); if ($merchant_lacks_pv79) { $referral_id = $merchant_lacks_pv79; } while ($referral_id =~ /(\n|\r|\s|\,)$/) { chop($referral_id); } $referral_id =~ s/\s//g; ($trash,$pending_file) = split(/-->/,shift(@personal_vars)); while ($pending_file =~ /(\n|\r|\s|\,)$/) { chop($pending_file); } if ( $FORM{'merchant'} && $merchant_security && $pending_file ) { $pending_file2 = "$vars"; $a = ""; until ($a eq "/" || $pending_file2 eq "") { $a = chop($pending_file2); } if ( $pending_file !~ /($pending_file2)/i ) { $pending_file = "$pending_file2/tracking.dat"; } $pending_file =~ s/\.\.\///g; $pending_file =~ s/\.\.//g; } if ( ($pending_file) && (-e "$pending_file") && (!-w "$pending_file") ) { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but you forgot to create your pending.dat file at this location: <b>\"$pending_file\"</B> and set permissions as writable (chmod it 777 on Unix).</H3></CENTER><BR>"; print "The script needs to be able to write to this file in order to do perform the order tracking feature described in Personal Variable #80 of the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=\"ReadMe\">ReadMe</A>. Create this file and upload it with your FTP program and set permissions on it as writable (chmod 777 on Unix). If you do not wish to use this feature, then leave PV#80 in your vars.dat file blank.<BR><BR>"; &footer; } ($trash,$aux_processor2_payment_option) = split(/-->/,shift(@personal_vars)); while ($aux_processor2_payment_option =~ /(\n|\r|\s|\,)$/) { chop($aux_processor2_payment_option); } ($trash,$suppress_address_in_customer_email_receipt) = split(/-->/,shift(@personal_vars)); while ($suppress_address_in_customer_email_receipt =~ /(\n|\r|\s)$/) { chop($suppress_address_in_customer_email_receipt); } ($trash,$billing_address_only_for_credit_cards) = split(/-->/,shift(@personal_vars)); while ($billing_address_only_for_credit_cards =~ /(\n|\r|\s)$/) { chop($billing_address_only_for_credit_cards); } ($trash,$temp) = split(/-->/,shift(@personal_vars)); while ($temp =~ /(\n|\r|\s|\,)$/) { chop($temp); } if ( $trash !~ /^(84)/ || $temp eq "1" ) { $shipping_roundup = 1; } elsif ( $temp eq "2" ) { $shipping_roundup = 1; $shipping_roundup2 = 1; } ($trash,$remove_button_status) = split(/-->/,shift(@personal_vars)); while ($remove_button_status =~ /(\n|\r|\s|\,)$/) { chop($remove_button_status); } if ( $trash !~ /^(85)/ ) { $remove_button_status = 1; } if ($remove_button_status == 2) { $change_remove_buttons = "side_by_side"; } else { $change_remove_buttons = "stacked"; } ($trash,$require_tos_agreement) = split(/-->/,shift(@personal_vars)); while ($require_tos_agreement =~ /(\n|\r|\s|\,)$/) { chop($require_tos_agreement); } if ($require_tos_agreement && !$lang[177]) { $lang[177] = 'I have read and agree to be bound by the <A HREF="http://www.YourName.com/" TARGET=_blank>Refund Policy and Terms of Service Agreement</A>.'; } if ($require_tos_agreement && !$lang[178]) { $lang[178] = 'Customer has read and agreed to be bound by the Refund Policy and Terms of Service Agreement as set forth in:|http://www.YourName.com/'; } if ($require_tos_agreement && !$lang[179]) { $lang[179] = 'Sorry, you must first read and agree to be bound by the <A HREF="http://www.YourName.com/" TARGET=_blank>Refund Policy and Terms of Service Agreement</A> before you can place an order. After you have read it, click the back button in your browser and checkmark the checkbox.'; } ($trash,$doctype) = split(/-->/,shift(@personal_vars)); while ($doctype =~ /(\n|\r|\s|\,)$/) { chop($doctype); } $doctype .= "\n"; ($trash,$max_hits_deny_access) = split(/-->/,shift(@personal_vars)); if (!$max_hits_deny_access) { $max_hits_deny_access = 200; } ($trash,$max_size_delete_shoppers_file) = split(/-->/,shift(@personal_vars)); if (!$max_size_delete_shoppers_file) { $max_size_delete_shoppers_file = 200000; } ($trash,$large_image_in_same_window_or_new) = split(/-->/,shift(@personal_vars)); while ($large_image_in_same_window_or_new =~ /(\n|\r|\s|\,)$/) { chop($large_image_in_same_window_or_new); } if ( $large_image_in_same_window_or_new eq "new" ) { $large_image_in_same_window_or_new = "TARGET=_blank"; } else { $large_image_in_same_window_or_new = ""; } ($trash,$path5) = split(/-->/,shift(@cambist_vars)); ($trash,$MerchantID) = split(/-->/,shift(@cambist_vars)); ($trash,$MerchantFont) = split(/-->/,shift(@cambist_vars)); ($trash,$MerchantFontColor) = split(/-->/,shift(@cambist_vars)); ($trash,$MerchantBgrdColor) = split(/-->/,shift(@cambist_vars)); ($trash,$unique_MAU) = split(/-->/,shift(@cambist_vars)); if ($unique_MAU =~ /[^a-zA-Z0-9]/) { &diagnostics; &header; print "<H3>Dansie Shopping Cart configuration message:<BR>Please see Secure Server Variable #6 in the ReadMe. Letters and numbers in SSV#6 only. No special characters of any kind.</H3>"; &footer; } if (!$unique_MAU) { $unique_MAU = "unique_MAU"; } $unique_MAU =~ s/ //g; ($trash,$instant_trans) = split(/-->/,shift(@cambist_vars)); ($trash,$append_datafile) = split(/-->/,shift(@cambist_vars)); $append_datafile =~ s/\\/\//g; if ( $FORM{'merchant'} && $merchant_security && $append_datafile ) { $append_datafile2 = "$vars"; $a = ""; until ($a eq "/" || $append_datafile2 eq "") { $a = chop($append_datafile2); } if ( $append_datafile !~ /($append_datafile2)/i ) { $append_datafile = "$append_datafile2/orders.dat"; } $append_datafile =~ s/\.\.\///g; $append_datafile =~ s/\.\.//g; } if ( ($append_datafile) && ( $append_datafile !~ /\// ) ) { $append_datafile = "$script_root/$append_datafile"; } $temp_path = $append_datafile; if ( $temp_path =~ /(.+)(\s)(.+)/ ) { ($temp_path2,$temp_path) = split(/\s/,$temp_path); } if ( $temp_path =~ /(.+)(\|)(.+)/ ) { ($temp_path2,$temp_path) = split(/\|/,$temp_path); } $a = ""; until ($a eq "/" || $temp_path eq "") { $a = chop($temp_path); } ($trash,$card_types) = split(/-->/,shift(@cambist_vars)); ($trash,$pgp) = split(/-->/,shift(@cambist_vars)); ($trash,$email_cc_numbers) = split(/-->/,shift(@cambist_vars)); while ($email_cc_numbers =~ /\s$/) { chop($email_cc_numbers); } if ( !$email_cc_numbers && !$append_datafile ) { $email_cc_numbers = "$myemail[0]"; } ($trash,$ssl_frames) = split(/-->/,shift(@cambist_vars)); while ($ssl_frames =~ /\s$/) { chop($ssl_frames); } if (!$ssl_frames) { $ssl_target_top = "TARGET=\"_top\""; } ($trash,$pending_order) = split(/-->/,shift(@cambist_vars)); while ($pending_order =~ /\s$/) { chop($pending_order); } if ( ($pending_order) && ($pending_order !~ /(.+)(\@)(.+)(\.)(.+)/) ) { &header; print "<H3>Dansie Shopping Cart configuration warning!<BR>See Secure Server Variable #13 in the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=new>ReadMe</A>. Either put an email address in it or leave it blank.</H3>"; &diagnostics; &footer; } ($trash,$ssl_logo_url) = split(/-->/,shift(@cambist_vars)); while ($ssl_logo_url =~ /(\n|\r|\s)$/) { chop($ssl_logo_url); } ($trash,$database_dir) = split(/-->/,shift(@database_vars)); $database_dir =~ s/\\/\//g; if ( !$database_dir ) { $database_dir = "$vars"; $a = ""; until ($a eq "/" || $database_dir eq "") { $a = chop($database_dir); } } if (!$database_dir) { $database_dir = "$script_root"; } if ($database_dir =~ /^http/i) { &diagnostics; &header; print "<H3>Dansie Shopping Cart configuration message:<BR>Please leave Database Variable #1 in your vars.dat file blank or set it to a system path. Do not put a URL in there. URLs start with either \"http://\" or \"https://\" and system path start with either \"/\" (Unix) or \"c:/\" (Windows NT).</H3>"; &footer; } ($trash,$view_url) = split(/-->/,shift(@database_vars)); if (($view_url) && ($view_url !~ /http/i)) { $view_url = "$base_img_url" . "/" . "$view_url"; } ($trash,$separator) = split(/-->/,shift(@database_vars)); if (!$separator) { $separator = "|"; } if ( $separator eq '\t' || $separator =~ /tab/i ) { $separator = "t"; } $separator = "\\" . "$separator"; ($trash,$options_separator) = split(/-->/,shift(@database_vars)); if (!$options_separator) { $options_separator = "^"; } $options_separator = "\\" . "$options_separator"; if (!$query_separator) { $query_separator = "|"; } $query_separator = "\\" . "$query_separator"; $query_separator2 = $query_separator; $query_separator2 =~ s/^\\//; ($trash,$temp) = split(/-->/,shift(@database_vars)); ($item_align,$image_align,$desc_align,$price_align) = split(/\|/,"$temp"); if (!$item_align) { $item_align = "center"; } if (!$image_align) { $item_align = "center"; } if (!$desc_align) { $item_align = "left"; } if (!$price_align) { $item_align = "center"; } ($trash,$item_cat_pos) = split(/-->/,shift(@database_vars)); ($trash,$stock_pos) = split(/-->/,shift(@database_vars)); ($trash,$name_pos) = split(/-->/,shift(@database_vars)); ($trash,$description_pos) = split(/-->/,shift(@database_vars)); ($trash,$price_pos) = split(/-->/,shift(@database_vars)); ($trash,$sh_pos) = split(/-->/,shift(@database_vars)); ($trash,$image_pos) = split(/-->/,shift(@database_vars)); ($trash,$temp) = split(/-->/,shift(@database_vars)); @additionals = split (/\,/,$temp); ($trash,$image_statement) = split(/-->/,shift(@database_vars)); ($trash,$button) = split(/-->/,shift(@database_vars)); if (!$lang[148]) { $lang[148] = "$button"; } ($trash,$home) = split(/-->/,shift(@database_vars)); ($trash,$items_per_page) = split(/-->/,shift(@database_vars)); if (!$items_per_page) { $items_per_page = 10;} ($trash,$uniform_images) = split(/-->/,shift(@database_vars)); if ($uniform_images) { ($uni_width,$uni_height) = split(/\,/,$uniform_images); if ($uni_width) { $uni_width = "WIDTH=$uni_width"; } if ($uni_height) { $uni_height = "HEIGHT=$uni_height"; } } ($trash,$database_logo) = split(/-->/,shift(@database_vars)); ($trash,$db_select_alignment) = split(/-->/,shift(@database_vars)); if (!$db_select_alignment) { $db_select_alignment = "center"; } ($trash,$db_select_stack_or_across) = split(/-->/,shift(@database_vars)); if (!$db_select_stack_or_across) { $db_select_stack_or_across = "across"; } ($trash,$navigation_bar) = split(/-->/,shift(@database_vars)); if ( $navigation_bar =~ /\n$/ ) { chop($navigation_bar); } $navigation_bar =~ s/\\/\//g; if ( $navigation_bar && $navigation_bar !~ /\// ) { $temp_navigation_bar = "$vars"; $a = ""; until ($a eq "/" || $temp_navigation_bar eq "") { $a = chop($temp_navigation_bar); } $navigation_bar = "$temp_navigation_bar/$navigation_bar"; } ($trash,$database_return_url) = split(/-->/,shift(@database_vars)); ($trash,$navigation_bar_position) = split(/-->/,shift(@database_vars)); if (!$navigation_bar_position) { $navigation_bar_position = "left"; } ($trash,$db_version) = split(/-->/,shift(@database_vars)); ($trash,$db_next_link_method) = split(/-->/,shift(@database_vars)); ($trash,$navigation_bar2) = split(/-->/,shift(@database_vars)); if ( $navigation_bar2 =~ /\n$/ ) { chop($navigation_bar2); } $navigation_bar2 =~ s/\\/\//g; if ( $navigation_bar2 && $navigation_bar2 !~ /\// ) { $temp_navigation_bar2 = "$vars"; $a = ""; until ($a eq "/" || $temp_navigation_bar2 eq "") { $a = chop($temp_navigation_bar2); } $navigation_bar2 = "$temp_navigation_bar2/$navigation_bar2"; } ($trash,$database_button_location) = split(/-->/,shift(@database_vars)); ($trash,$temp) = split(/-->/,shift(@database_vars)); @all_searchable_fields = split (/\,/,$temp); if ( $temp !~ /\,/ && $temp !~ /\d/ ) { @all_searchable_fields = (); } if ( $ENV{'CONTENT_TYPE'} =~ /multipart\/form\-data/i ) { &parse_form_data2; } &diagnostics; if ( $date_command ) { $date_command =~ /(.+)/; $date_command = $1; if ( $date_command !~ /\%/ ) { $date = `$date_command +"%D %T %Z"`; } else { $date = `$date_command`; } chomp($date); if ( eval "require(\"timezone.lib\");" ) { $date = change_timezone($date); } } else { &SetCookieExpDate2; $date = "$Cookie_Exp_Date"; } if ( $mailprog =~ /(blat\.exe)/i ) { $blat = 1; } if ( $mailprog =~ /(windmail\.exe)/i ) { $windmail = 1; } $signio_echeck_url = "https://payflowlink.signio.com/paylinks.dll"; $verisign_telecheck_url = "https://payflowlink.verisign.com/payflowlink.cfm"; $i_check = "https://paybycheck.com/payment.pl"; $i_check = "https://paybycheck.com/"; $ValidCheck = "https://www.ValidCheck.com/PayWizard.asp"; $ValidCheck = "https://www.validpay.com/PayWizard.asp"; $i_checkApprovedURL = "$path3?icheck$unique_MAU"; if ($FORM{'merchant'}) { $i_checkApprovedURL .= "%26" . "merchant" . "%3D" . "$FORM{'merchant'}"; } if ( ($FORM{'return'}) && ($FORM{'return'} !~ /\/{2}(.+)\/{1}/) ) { $FORM{'return'} = "$FORM{'return'}/"; } $atemp = @additionals; if ( $customs < ($atemp+2) ) { $customs = $atemp+2; } if ($ship_allow == 2) { $show_ship = 0; } $borders = 0; $security = 0; $compat = "4.0"; $discount_sep = ":"; if (!$ENV{'REMOTE_HOST'}) { $ENV{'REMOTE_HOST'} = "$ENV{'REMOTE_ADDR'}"; } $mail_ext = "mail"; $use_zipcode_fields = 1; $quantity_digits = 5; $ns3bugtime = .0000115 * 10 * 0; $max_secure_field_array = 20; $max_secure_field_array += 19; if ($email_content_type =~ /^(text\/html)/i) { $html_br = "<BR>"; } if ( $FORM{'merchant'} ) { if ($ssl_target_page eq "$path4") { $cambist_back = "$path3?look\|$FORM{'merchant'}"; } else { $cambist_back = "$ssl_target_page"; } } else { if ($ssl_target_page eq "$path4") { $cambist_back = "$path3"; } else { $cambist_back = "$ssl_target_page"; } } if ( $FORM{'merchant'} ) { $correct_sales_tax_location_back_link = "$path3?look\|$FORM{'merchant'}"; } else { $correct_sales_tax_location_back_link = "$path3"; } $MerchantApprovedURL = "$path3?$unique_MAU"; $MerchantApprovedURL_aux_processor = "$path3?". "aux_processor" . "$unique_MAU"; $MerchantApprovedURL_aux_processor2 = "$path3?". "aux_processor2" . "$unique_MAU"; $MerchantUnApprovedURL = "$path3?failure"; if ( $FORM{'purpose2'} eq "check_transfer" ) { $MerchantApprovedURL = "$path3" . "?check$unique_MAU";   } if ($FORM{'merchant'}) { $MerchantApprovedURL .= "&" . "merchant=$FORM{'merchant'}"; $MerchantApprovedURL_aux_processor .= "&" . "merchant=$FORM{'merchant'}"; $MerchantApprovedURL_aux_processor2 .= "&" . "merchant=$FORM{'merchant'}"; $MerchantUnApprovedURL .= "&" . "merchant=$FORM{'merchant'}"; } $Cookie_Exp_Date = ''; $Cookie_Path = '/'; $Cookie_Domain = ''; $Secure_Cookie = '0'; @Cookie_Encode_Chars = ('\%', '\+', '\;', '\,', '\=', '\&', '\:\:', '\s'); %Cookie_Encode_Chars = ('\%',   '%25', '\+',   '%2B', '\;',   '%3B', '\,',   '%2C', '\=',   '%3D', '\&',   '%26', '\:\:', '%3A%3A', '\s',   '+'); @Cookie_Decode_Chars = ('\+', '\%3A\%3A', '\%26', '\%3D', '\%2C', '\%3B', '\%2B', '\%25'); %Cookie_Decode_Chars = ('\+',       ' ', '\%3A\%3A', '::', '\%26',     '&', '\%3D',     '=', '\%2C',     ',', '\%3B',     ';', '\%2B',     '+', '\%25',     '%'); $cookie_name2 = "shopper_id"; if ( $FORM{'merchant'} ) { $cookie_name2 = "$FORM{'merchant'}_$cookie_name2"; } $require_address = 1; $require_city = 1; $require_state = 1; $require_zip = 1; $require_country = 1; if ( ( $FORM{'return'} =~ /(.+)(\?)(.+)/ ) || ( (!$FORM{'return'}) && $path4 =~ /(.+)(\?)(.+)/ ) ) { $post_get_method = "METHOD=POST"; } else { $post_get_method = "METHOD=GET"; } if ($referral_id) { $referral_id_code = "cgi-bin/referral.pl?id=" . "$referral_id"; } $custom_description_currency_symbol_feature = 1; $all_different_passwords = 0; if ( $diagnostics ) { $temp = ""; foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $temp .= "$name = $value<BR>"; } $lang[114] = "REQUEST_METHOD: $ENV{'REQUEST_METHOD'}<BR>QUERY_STRING: $ENV{'QUERY_STRING'}<BR>POST:<BR>$temp<BR>" . "$lang[114]"; } if ( ($ENV{'HTTP_HOST'} eq "www.dansie.net") && (!$FORM{'merchant'}) && ($path3 eq "http://www.dansie.net/cgi-bin/scripts/cart.pl") ) { if ( $ENV{'HTTP_REFERER'} =~ /^(http:\/\/dansie\.net)/i ) { $special_security_message = ""; } if ( $ENV{'HTTP_REFERER'} =~ /^(http:\/\/www\.dansie\.net)/i ) { $special_security_message = ""; } if ( $ENV{'HTTP_REFERER'} =~ /^(http:\/\/dansiecart\.com)/i ) { $special_security_message = ""; } if ( $ENV{'HTTP_REFERER'} =~ /^(http:\/\/www\.dansiecart\.com)/i ) { $special_security_message = ""; } if ( $ENV{'HTTP_REFERER'} =~ /^(https:\/\/dansie\.securesites\.com)/i ) { $special_security_message = ""; } if ($special_security_message) { $lang[114] = "<TABLE WIDTH=80%><TR><TD><FONT SIZE=+3>This Demo Cart will allow you to POST any item and price to it so you may run tests with <A HREF=\"http://www.dansie.net/cart_form_source.html\" TARGET=form>HTML forms</A> that you create. However, the cart has a security feature where you can prevent people from posting to your cart from other than the domains you specifically authorize. See Personal Variable #66 in the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=readme>ReadMe</A> for details.</FONT></TD></TR></TABLE>"; } } $browser_os_info = "$ENV{'HTTP_USER_AGENT'}"; $browser_os_info =~ s/([^\w|\d|\.])//gi; $email_log="$vars"; $a=""; until ($a eq "/" || $email_log eq "") { $a=chop($email_log); } $email_log1 = "$email_log" . "/email_log.txt"; $email_log2 = "$email_log" . "/email_log.dat"; if (-e "$email_log2") { $email_log = "$email_log2"; } else { $email_log = "$email_log1"; } if (!$lang[180]) { $lang[180] = "This item is on backorder and shipping may be delayed."; } $limited_quantity_inv_summary_last_emailed = "$vars"; $a = ""; until ($a eq "/" || $limited_quantity_inv_summary_last_emailed eq "") { $a = chop($limited_quantity_inv_summary_last_emailed); } $limited_quantity_inv_summary_last_emailed .= "/limited_quantity_inv_summary_last_emailed"; $demo = 0; if ($demo) { if ( $FORM{'purpose'} eq "credit" || $FORM{'purpose'} eq "credit_phone" || $FORM{'purpose'} eq "check" || $FORM{'purpose'} eq "check_transfer" || $FORM{'purpose'} eq "cod" ) { &header; print "$doctype<HTML><HEAD><TITLE>$bizname - Dansie Shopping Cart DEMO</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\"> <CENTER> <FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">This is just a demo version</FONT><BR> <A HREF=\"http://www.dansie.net\">Order Dansie Shopping Cart</A><BR> <A HREF=\"mailto:cart\@dansie.net\">Email: cart\@dansie.net</A><BR> </CENTER> </BODY></HTML>"; exit; } } if (!$map_domain) { $temp = $ENV{'REMOTE_HOST'}; @numbers = split(/\./, $ENV{'REMOTE_HOST'}); $ip_number = pack("C4", @numbers); ($ENV{'REMOTE_HOST'}) = (gethostbyaddr($ip_number, 2))[0]; if (!$ENV{'REMOTE_HOST'}) { $ENV{'REMOTE_HOST'} = $temp; } } if ( $ENV{'QUERY_STRING'} =~ /^db$query_separator/i ) { ($trash,$FORM{'db'},$FORM{'category'},$trash,$trash,$trash,$trash,$FORM{'merchant'},) = split(/$query_separator/,$ENV{'QUERY_STRING'}); if ( $FORM{'category'} eq "All%20Items" ) { $FORM{'category'} = ""; } &database3; exit; } if ( $FORM{'file'} || $FORM{'search_categories'} ) { $FORM{'db'} = "$FORM{'file'}"; $FORM{'category'} = "$FORM{'search_categories'}"; &database3; exit; } if ( $FORM{'db'} ) { &database3; exit; } if ( $ENV{'QUERY_STRING'} =~ /^db=/i ) { &database3; exit; } if ( ($FORM{'add'}) || ($FORM{'add2'}) || ($FORM{'ADD'}) || ($FORM{'Add'}) || ($FORM{'purpose'} eq "add") || ($FORM{'purpose'} eq "ADD") ) { &denial_of_access_log; if ( ($ENV{'HTTP_HOST'} eq "www.dansie.net") && ($FORM{'name'} =~ /(piece of crap)/i)  ) { $FORM{'name'} = "This is a Demo Cart that will allow you to post anything to it for testing purposes."; $FORM{'custom1'} = "This Demo Cart will allow you to POST any item and price to it so you may run tests with HTML forms that you create. However, the cart has a security feature where you can prevent people from posting to your cart from other than the domains you specifically authorize. See Personal Variable #66 in the <A HREF=http://www.dansie.net/cart_readme.html TARGET=_blank>ReadMe</A> for details."; } if ( $FORM{'redirect'} ) { $add_and_redirect = $FORM{'redirect'}; } if ( $FORM{'redirect'} eq "0.00" ) { $add_and_redirect = "0"; } if ( $FORM{'redirect'} eq "no" ) { $add_and_redirect = "0"; } &delete_old_carts; &fix_quantity; $adding_new_item_to_basket = 1; &get_shoppers_items; &authorized_referrers; if ( -e "$path1/$shopper_id$ext" ) { if ( ($ns3bugtime) && ((-M "$path1/$shopper_id$ext" ) < $ns3bugtime) ) { if($add_and_redirect) { &add_and_redirect; } &list_items; exit; } $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); $n = 0; foreach $item (@items) { if ( ($n == 2) && ( $add_top_or_bottom !~ /(bottom)/i ) ) { &add_new_item_to_cart; } print CART "$item"; $n++; } if ( ($n == 2) && ( $add_top_or_bottom !~ /(bottom)/i ) ) { &add_new_item_to_cart; } if ( $add_top_or_bottom =~ /(bottom)/i ) { &add_new_item_to_cart; } close CART; if($add_and_redirect) { &add_and_redirect; } &list_items; exit; } if ( !(-e "$path1/$shopper_id$ext" ) ) { if ($FORM{'referrer'}) { $FORM{'referrer'} .= " - "; } $untainted = &untaint("$path1/$shopper_id$ext"); $untainted2 = &untaint("$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext"); open(CART,">$untainted"); print CART "$date$delimiter$FORM{'referrer'}$invoice_prefix$invoice\n"; print CART "Shipping address info goes here later\n"; &add_new_item_to_cart; close CART; if ( $ip_or_cookie != 2 ) { use File::Copy; copy("$untainted","$untainted2"); } if($add_and_redirect) { &add_and_redirect; } &list_items; exit; } exit; } if ( $FORM{'purpose'} eq "look" || $ENV{'QUERY_STRING'} =~ /^look/i  || ( !$ENV{'QUERY_STRING'} && $ENV{'REQUEST_METHOD'} =~ /get/i )  ) { &denial_of_access_log; &list_items; exit; } if ( $lang[35] && $FORM{'purpose'} eq "$lang[35]" ) { &denial_of_access_log; if (!&GetCookies("$cookie_name2") && ($ip_or_cookie) ) { &cookie_failure; } &get_shoppers_items; if (!$shopper_id) { &list_items; exit; } $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); $n = 0; foreach $item (@items) { if ( $n == $FORM{'item'} ) { &change_quantity; } else { print CART "$item"; } $n++; } close CART; if ( @items <= 3 && $FORM{'quantity'} == 0 ) { $untainted = &untaint("$path1/$shopper_id$ext"); unlink("$untainted"); } &list_items; exit; } if ( $lang[38] && $FORM{'purpose'} eq "$lang[38]" ) { &denial_of_access_log; if (!&GetCookies("$cookie_name2") && ($ip_or_cookie) ) { &cookie_failure; } &get_shoppers_items; if (!$shopper_id) { &list_items; exit; } $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); $n = 0; foreach $item (@items) { unless ( $n == $FORM{'item'} ) { print CART "$item"; } $n++; } close CART; &list_items; exit; } if ( ($FORM{'purpose'} eq "check") && ($option3 == 1) ) { &denial_of_access_log; if (!$shopper_id) { &check_cookie; } &check_tax; if ($paper_font_color) { &paper_font_color; } &header; $purpose_temp = "$lang[1]"; $purpose_temp_title = "$purpose_temp"; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=$image TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[1]</FONT></CENTER>"; $purchase_method2 = "$lang[26]"; &show_invoice; &address_table; print "<BR><CENTER><TABLE WIDTH=\"$table_width\" BORDER=0 CELLPADDING=0 CELLSPACING=0><TR><TD>"; print "<FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[10] </FONT>\n"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"> \"$payable\"</FONT>" if ($payable); print "<BR>\n\n"; print "<FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[11]</FONT><BR><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add1</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add2</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add3</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add4</FONT><BR>" if ( $add4 ); print "\n\n<BR><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$guarantee</FONT><BR>\n\n"; print "<BR><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[12] <A HREF=\"$ssl_target_page\" TARGET=\"_top\"><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$add5</FONT></FONT></A><BR>"; print"<A HREF=\"mailto:$myemail[0]\"><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$myemail[0]</FONT></A><BR>"; print "</TD></TR></TABLE></CENTER>"; &print_button; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>"; exit; } if ( ($FORM{'purpose'} eq "credit") || ($FORM{'purpose'} eq "aux_processor") || ($FORM{'purpose'} eq "aux_processor2") || ($FORM{'purpose'} eq "check_transfer") ) { &denial_of_access_log; &get_shoppers_items; if (!$shopper_id) { &check_cookie; } if (!$shopper_id) { &list_items; exit; } &check_tax; if ( $items[1] =~ /$delimiter2/ ) { ($field1,$field2,$field3,$field4,$field5,$field6,$field7,$field8,$field9) = split(/$delimiter2/, $items[1]); } if ( $FORM{'purpose'} eq "credit" ) { $purpose_temp = "$lang[14]"; if ( $path5 !~ /paypal.com/ ) { $ssl_target_top = ""; } } if ( $FORM{'purpose'} eq "check_transfer" ) { $purpose_temp = "$lang[71]"; } if ( $FORM{'purpose'} eq "aux_processor" ) { $purpose_temp = "$lang[154]"; } if ( $FORM{'purpose'} eq "aux_processor2" ) { $purpose_temp = "$lang[165]"; } &header; $purpose_temp_title = $purpose_temp; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n<SCRIPT LANGUAGE=\"JavaScript\">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5LG9SGF');</SCRIPT>\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$purpose_temp</FONT></CENTER>"; print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[15]</FONT></CENTER>\n"; if ($billing_address_only_for_credit_cards) { print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[172]</FONT></CENTER>\n"; } print "<BR>\n"; &get_shipping_cookie; &print_ship_address; if (!$billing_address_only_for_credit_cards) { $show_copy_button = 1; &print_ship_address2; } &comments if($comments); &tos_agreement if ($require_tos_agreement); print "<CENTER><BR>"; if ( $lang[19] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[19]\" VALUE=\"$lang[19]\" BORDER=0>"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[19]\">"; } print "</CENTER> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\">"; if ( $FORM{'purpose'} eq "check_transfer" ) { print "<INPUT TYPE=HIDDEN NAME=purpose2 VALUE=\"check_transfer\">\n"; } if ( $FORM{'purpose'} eq "aux_processor" ) { print "<INPUT TYPE=HIDDEN NAME=purpose2 VALUE=\"aux_processor\">\n"; } if ( $FORM{'purpose'} eq "aux_processor2" ) { print "<INPUT TYPE=HIDDEN NAME=purpose2 VALUE=\"aux_processor2\">\n"; } print "</FORM>"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>"; exit; } if ( ( $FORM{'purpose'} eq "ship_info" && (!$FORM{'purpose2'})  ) || ( $FORM{'purpose2'} eq "check_transfer" ) || ( $FORM{'purpose2'} eq "aux_processor" ) || ( $FORM{'purpose2'} eq "aux_processor2" ) ) { &denial_of_access_log; &get_shoppers_items; if ($comments) { chop($items[0]) if ( $items[0] =~ /\n$/ ); ($a,$b,$c,$d,$e,$f,$coupon_number) = split(/$delimiter2/,$items[0]); $items[0] = "$a$delimiter$b$delimiter$c$delimiter$d$delimiter$FORM{'comments'}$delimiter$f$delimiter$coupon_number\n"; } &copy_shipping_info_to_billing_info; $items[1] = "$FORM{'name'}$delimiter$FORM{'company'}$delimiter$FORM{'address'}$delimiter$FORM{'city'}$delimiter$FORM{'state'}$delimiter$FORM{'zip'}$delimiter$FORM{'country'}$delimiter$FORM{'phone'}$delimiter$FORM{'email'}$delimiter$FORM{'name2'}$delimiter$FORM{'company2'}$delimiter$FORM{'address2'}$delimiter$FORM{'city2'}$delimiter$FORM{'state2'}$delimiter$FORM{'zip2'}$delimiter$FORM{'country2'}$delimiter$FORM{'phone2'}$delimiter$FORM{'email2'}$delimiter$FORM{'confirm_email'}$delimiter$FORM{'confirm_email2'}\n"; $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); foreach $item (@items) { print CART "$item"; } close CART; if ($ip_or_cookie) { &SetCookieExpDate; &SetCompressedCookies('shipping_address','name',"$FORM{'name'}",'company',"$FORM{'company'}",'address',"$FORM{'address'}",'city',"$FORM{'city'}",'state',"$FORM{'state'}",'zip',"$FORM{'zip'}",'country',"$FORM{'country'}",'phone',"$FORM{'phone'}",'email',"$FORM{'email'}",'name2',"$FORM{'name2'}",'company2',"$FORM{'company2'}",'address2',"$FORM{'address2'}",'city2',"$FORM{'city2'}",'state2',"$FORM{'state2'}",'zip2',"$FORM{'zip2'}",'country2',"$FORM{'country2'}",'phone2',"$FORM{'phone2'}",'email2',"$FORM{'email2'}",'confirm_email',"$FORM{'confirm_email'}",'confirm_email2',"$FORM{'confirm_email2'}"); } $required_fields = &required_fields; $required_fields2 = &required_fields2; if ( $FORM{'purpose'} eq "ship_info" ) { $purpose_temp = "$lang[14]"; } if ( $FORM{'purpose2'} eq "credit" ) { $purpose_temp = "$lang[14]"; } if ( $FORM{'purpose2'} eq "check_transfer" ) { $purpose_temp = "$lang[71]"; } if ( $FORM{'purpose2'} eq "aux_processor" ) { $purpose_temp = "$lang[154]"; } if ( $FORM{'purpose2'} eq "aux_processor2" ) { $purpose_temp = "$lang[165]"; } if ( !$required_fields || !$required_fields2 || $no_valid_email_address || $no_valid_email_address2 || ($require_tos_agreement && !$FORM{tos_agreement}) ) { $purpose_temp_title = $purpose_temp; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">\n"; print "$lang[20]<BR>$lang[21]\n" if(!$require_tos_agreement || $FORM{tos_agreement}); if ($no_valid_email_address || $no_valid_email_address2) { print "<BR>$lang[166]\n"; } elsif ($email_not_confirmed) { print "<BR>$lang[175]\n"; } elsif ($require_tos_agreement && !$FORM{tos_agreement}) { $lang[179] =~ s/http:\/\/www.YourName\.com\//$path4/g if($path4); print "<BR>$lang[179]\n"; } print "<BR><BR>\n"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; exit; } &deny_email_domains; &sales_tax_state_verification; if ($pending_file) { $purchase_method2 = "$lang[152] - $purpose_temp"; $tracking_file = "$pending_file"; if ( $items[1] !~ /^Shipping address info goes here later/ ) { &order_tracking; } } if ( $FORM{'purpose2'} eq "check_transfer" ) { if ( $option4 =~ /^(http)/i ) { $path5 = "$option4". '?' . "check"; } elsif ( $option4 =~ /^(signio)/i ) { $path5 = "$signio_echeck_url"; } elsif ( $option4 =~ /^(telecheck)/i ) { $path5 = "$verisign_telecheck_url"; $MerchantID = "$i_check_id"; } elsif ( $option4 =~ /(chexpedite)/i ) { $path5 = "$option4"; $MerchantID = "$i_check_id"; } else { &prepare_and_send_pending_order_notice; &i_check; } } &calculate_fulltotal; if ( ($minimum_order) && ($subtotal_original_for_minimum_order < $minimum_order) ) { &list_items; exit; } if ( ($maximum_order) && ($subtotal_original_for_minimum_order > $maximum_order) ) { &list_items; exit; } if ($total <= 0) { print "Location: $MerchantApprovedURL\n\n"; exit; } if ( ( ($path5 =~ /(html)$/) || ($path5 =~ /(htm)$/) ) && ( ($path5 !~ /(\.pl)/) && ($path5 !~ /(\.cgi)/) ) ) { } $processor_path = "$vars"; $a = ""; until ($a eq "/" || $processor_path eq "") { $a = chop($processor_path); } if ( $FORM{'purpose2'} eq "aux_processor" ) { ($path5,$MerchantID,$temp_exchange_rate) = split(/\|/,"$aux_processor_payment_option"); if ($temp_exchange_rate) { $MerchantID .= "\|$temp_exchange_rate"; } $MerchantApprovedURL = "$MerchantApprovedURL_aux_processor"; if (-e "$processor_path/$aux_processor_payment_option") { $processor_path = "$processor_path/$aux_processor_payment_option"; &custom_processor; } else { &cambist_or_authorize_net_names; } } if ( $FORM{'purpose2'} eq "aux_processor2" ) { ($path5,$MerchantID,$temp_exchange_rate) = split(/\|/,"$aux_processor2_payment_option"); if ($temp_exchange_rate) { $MerchantID .= "\|$temp_exchange_rate"; } $MerchantApprovedURL = "$MerchantApprovedURL_aux_processor2"; if (-e "$processor_path/$aux_processor2_payment_option") { $processor_path = "$processor_path/$aux_processor2_payment_option"; &custom_processor; } else { &cambist_or_authorize_net_names; } } if ( $FORM{'purpose2'} ne "aux_processor" && $FORM{'purpose2'} ne "aux_processor2" ) { if ( (-e "$processor_path/processor.dat") && ( $FORM{'purpose2'} ne "check_transfer" )) { $processor_path = "$processor_path/processor.dat"; &custom_processor; } else { &cambist_or_authorize_net_names; } } if ($bizname_backup) { $biz_temp = "$bizname_backup"; } else { $biz_temp = "$bizname"; } $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp</TITLE>\n$meta_tag\n</HEAD>"; if (!$force_no_script) { print "\n<SCRIPT LANGUAGE=\"JavaScript\">\n function AutoSubmit()\n {\n document.form1.submit()\n }\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">\n"; if (!$force_no_script) { print "\n</NOSCRIPT>\n"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n document.write('<BODY BGCOLOR=\"$bgcolor\" ONLOAD=\"AutoSubmit()\">')\n </SCRIPT>\n"; } print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$biz_temp</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$purpose_temp</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 WIDTH=80%><TR><TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[16]</FONT></TD></TR></TABLE></CENTER><BR>"; if ( !$processor_post_method ) { $processor_post_method = "POST"; } print "<CENTER><TABLE><TR><TD>\n\n\n<FORM NAME=\"form1\" METHOD=$processor_post_method ACTION=\"$path5\" $ssl_target_top >\n"; &pass_standard_secure_variables; &pass_ssl_variables; &pass_shipping_secure_variables; print "<INPUT TYPE=SUBMIT VALUE=\"$lang[86]\">\n"; print "</FORM>\n\n\n </TD></TR></TABLE>\n"; if (!$force_no_script) { print "\n<SCRIPT LANGUAGE=\"JavaScript\">\n TimerID = setTimeout(\"document.form1.submit()\",10000); </SCRIPT>\n"; } print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>\n"; print "<NOSCRIPT>\n <SCRIPT>\n /*\n"; &prepare_and_send_pending_order_notice; exit; } if ( ( $ENV{'QUERY_STRING'} =~ /^failure/ ) || ( ( $path5 =~ /www.aba.net.au/i ) && ( $ENV{'QUERY_STRING'} =~ /refused/i ) || ( $ENV{'QUERY_STRING'} =~ /timeout/i ) ) || ( ( $path5 =~ /www.1internetave.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(approve)(\=)(0)(.*)/ ) ) || ( ( $path5 =~ /commercepay\.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(MStatus\=Decline)(.*)/ || $ENV{'QUERY_STRING'} =~ /(.*)(MStatus\=failure)(.*)/ ) ) || ( ( $path5 =~ /(eplastic)$/ ) && ( $FORM{'accepted'} eq "NO" ) ) || ( ( $path5 =~ /(eplastic)$/ ) && ( $FORM{'accepted'} eq "YES" ) && ( $ENV{'HTTP_REFERER'} && $ENV{'HTTP_REFERER'} !~ /(https\:\/\/www\.e-plastic\.com)/ ) ) || ( ( $path5 =~ /authorize\.net/i ) && ( ($FORM{'RESPONSECODE'} eq "D") || ($FORM{'RESPONSECODE'} eq "R") || ($FORM{'RESPONSECODE'} eq "E") ) ) || ( ( $path5 =~ /secpay\.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(valid\=false)(.*)/ ) ) || ( ( $path5 =~ /signio\.com/i && $ENV{'QUERY_STRING'} =~ /^($unique_MAU)/ ) && ( $ENV{'QUERY_STRING'} =~ /(RESPMSG)/ ) && ( $ENV{'QUERY_STRING'} !~ /(.*)(RESPMSG\=Approved)(.*)/ ) ) || ( ( $path5 =~ /anacom\.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(approval\=)/i ) && ( $ENV{'QUERY_STRING'} !~ /(.*)(approval\=)(\d{1,})(.*)/i && $ENV{'QUERY_STRING'} !~ /(.*)(approval\=)(SimulatedApproval)(.*)/i ) ) || ( ( $path5 =~ /payready.net/i ) && ( $ENV{'QUERY_STRING'} =~ /txtApprovalStatus/i ) && ( $ENV{'QUERY_STRING'} !~ /txtApprovalStatus\=0/i ) ) || ( ( $path5 =~ /iongate.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(RESPONSECODE)(\=)(.*)/i ) && ( $ENV{'QUERY_STRING'} !~ /(.*)(RESPONSECODE)(\=)(AA)(.*)/i ) ) || ( ( $path5 =~ /intellipay.net/i ) && ( $ENV{'QUERY_STRING'} =~ /^($unique_MAU)/ ) && ( ( $FORM{'RESPONSECODE'} ne "A" ) && ( $ENV{'QUERY_STRING'} !~ /(.*)(RESPONSECODE)(\=)(A)(.*)/i ) ) ) || ( ( $path5 =~ /arvic.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(ASC_POSRes)(\=)(.*)/i ) && ( $ENV{'QUERY_STRING'} !~ /(.*)(ASC_POSRes)(\=)(0000)(.*)/i ) ) || ( ( $path5 =~ /PriceNet.com.au/i || $aux_processor_payment_option =~ /PriceNet.com.au/i || $aux_processor2_payment_option =~ /PriceNet.com.au/i ) && ( $FORM{'price_net_receipt'} && $FORM{'payment_result'} == 0 ) ) ) { &denial_of_access_log; &check_duplicate_order2; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $lang[22]</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[23]</FONT></CENTER><BR>"; print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; &get_shoppers_items; chop($items[0]); @info = split(/$delimiter2/, $items[0]); $tax = $info[2]; $ship_method = $info[3]; print "<FORM METHOD=POST ACTION=$path3>"; print "<INPUT TYPE=HIDDEN NAME=ship_method VALUE=\"$ship_method\">"; print "<INPUT TYPE=HIDDEN NAME=tax VALUE=\"$tax\">"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[24] </B></FONT><BR>"; print "<SELECT NAME=purpose size=1>"; print "<OPTION VALUE=\"credit\">$lang[14]" if ($option1); print "<OPTION VALUE=\"aux_processor\">$lang[154]" if ($aux_processor_payment_option); print "<OPTION VALUE=\"aux_processor2\">$lang[165]" if ($aux_processor2_payment_option); print "<OPTION VALUE=\"check_transfer\">$lang[71]" if ($option4); print "<OPTION VALUE=\"credit_phone\">$lang[25]" if ($option2); print "<OPTION VALUE=\"check\">$lang[26]" if ($option3); print "<OPTION VALUE=\"cod\">$lang[97]" if ($option5); print "<OPTION VALUE=\"auxiliary\"> $option6" if ($option6); print "</SELECT><BR><BR>"; if ( $lang[148] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[148]\" VALUE=\"$lang[148]\" BORDER=0>"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[148]\">"; } print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> </FORM><BR>"; if ( !$ssl_frames ) { $path4 = "$ssl_target_page"; } &home; print "<BR><BR>\n"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</FONT></CENTER>"; print "</BODY></HTML>"; exit; } if (  ( $ENV{'QUERY_STRING'} =~ /^($unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(check$unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(icheck$unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(ValidCheck$unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(aux_processor$unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(aux_processor2$unique_MAU)/ ) || ( ( $path5 =~ /www.1internetave.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(approve)(\=)(1)(.*)/ ) ) || ( ( $path5 =~ /anacom\.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(approval\=)(\d{1,})(.*)/i || $ENV{'QUERY_STRING'} =~ /(.*)(approval\=)(SimulatedApproval)(.*)/i ) ) || ( ( $path5 =~ /bamart.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(Ecom_transaction_complete)(\=)(TRUE)(.*)/ ) ) || ( ( $path5 =~ /payready.net/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(txtApprovalStatus)(\=)(0)(.*)/i ) ) || ( ( $path5 =~ /iongate.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(RESPONSECODE)(\=)(AA)(.*)/i ) ) || ( ( $path5 =~ /intellipay.net/i ) && ( $FORM{'RESPONSECODE'} eq "A" ) ) || ( ( $path5 =~ /arvic.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(ASC_POSRes)(\=)(0000)(.*)/i ) ) || ( ( $path5 =~ /PriceNet.com.au/i || $aux_processor_payment_option =~ /PriceNet.com.au/i || $aux_processor2_payment_option =~ /PriceNet.com.au/i ) && ( $FORM{'price_net_receipt'} && $FORM{'payment_result'} == 1 ) ) || ( ( $path5 =~ /2checkout.com/i || $aux_processor_payment_option =~ /2checkout.com/i || $aux_processor2_payment_option =~ /2checkout.com/i ) && ( $FORM{'x_trans_id'} ) ) ) { &denial_of_access_log; &check_duplicate_order2; if ($paper_font_color) { &paper_font_color; } if ( $ENV{'QUERY_STRING'} =~ /^($unique_MAU)/ ) { $purpose_temp = "$lang[14]<BR>$instant_trans"; $email_purpose_temp = "$lang[14]"; } elsif ( ( $ENV{'QUERY_STRING'} =~ /^(check$unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(icheck$unique_MAU)/ ) || ( $ENV{'QUERY_STRING'} =~ /^(ValidCheck$unique_MAU)/ ) ) { $purpose_temp = "$lang[71]"; $email_purpose_temp = "$lang[71]"; } elsif ( ( $ENV{'QUERY_STRING'} =~ /^(aux_processor$unique_MAU)/ ) ) { $purpose_temp = "$lang[154]<BR>$instant_trans"; $email_purpose_temp = "$lang[154]"; } elsif ( ( $ENV{'QUERY_STRING'} =~ /^(aux_processor2$unique_MAU)/ ) ) { $purpose_temp = "$lang[165]<BR>$instant_trans"; $email_purpose_temp = "$lang[165]"; } else { $purpose_temp = "$lang[14]<BR>$instant_trans"; $email_purpose_temp = "$lang[14]"; } if ( ( $path5 =~ /anacom\.com/i ) && ( $ENV{'QUERY_STRING'} =~ /(.*)(approval\=)(\d{1,})(.*)/i || $ENV{'QUERY_STRING'} =~ /(.*)(approval\=)(SimulatedApproval)(.*)/i ) ) { $ENV{'QUERY_STRING'} = "$unique_MAU" .  "$ENV{'QUERY_STRING'}"; } $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "<!--BEGIN-->\n"; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $lang[28]</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$purpose_temp<BR>$lang[28]</FONT></CENTER><BR>"; print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[29] </FONT></CENTER><BR>"; $purchase_method2 = "$purpose_temp"; if ( $ENV{'QUERY_STRING'} =~ /(^$unique_MAU)/ ) { $purchase_method2 = "$lang[14]"; } if ( $ENV{'QUERY_STRING'} =~ /(^aux_processor$unique_MAU)/ ) { $purchase_method2 = "$lang[154]"; } if ( $ENV{'QUERY_STRING'} =~ /(^aux_processor2$unique_MAU)/ ) { $purchase_method2 = "$lang[165]"; } if ( $items[1] !~ /^Shipping address info goes here later/ ) { &order_tracking; } $affiliate = 1; &show_invoice; if ( $items[1] =~ /$delimiter2/ ) { ($field1,$field2,$field3,$field4,$field5,$field6,$field7,$field8,$field9,$field10,$field11,$field12,$field13,$field14,$field15,$field16,$field17,$field18) = split(/$delimiter2/, $items[1]); } print "<BR><CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[30]</FONT></CENTER><BR>"; &print_ship_address3; if (!$billing_address_only_for_credit_cards) { &print_ship_address4; } &comments2 if($comments); print "<BR></FORM>"; print "<BR><CENTER><TABLE WIDTH=\"$table_width\" BORDER=0 CELLPADDING=0 CELLSPACING=0><TR><TD>\n\n <FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$guarantee</FONT><BR><BR>\n\n"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add1</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add2</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add3</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add4</FONT><BR>" if ( $add4 ); print "<BR><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[12] <A HREF=\"$ssl_target_page\" TARGET=\"_top\"><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$add5</FONT></FONT></A><BR>"; print"<A HREF=\"mailto:$myemail[0]\"><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$myemail[0]</FONT></A><BR>"; print "</TD></TR></TABLE></CENTER>"; &print_button; &check_mailprog; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>\n"; print "<!--BEGIN-->\n"; print "<NOSCRIPT>\n <SCRIPT>\n /*\n"; $purchase_method = "$email_purpose_temp"; if ( $items[1] !~ /^Shipping address info goes here later/ ) { &send_email; } $untainted = &untaint("$path1/$shopper_id$ext"); unlink("$untainted"); exit; } if ( $FORM{'purpose'} eq "credit_phone" ||  $FORM{'purpose'} eq "cod" || ( $FORM{'purpose'} eq "check" && ($option3 == 2) ) || $FORM{'purpose'} eq "auxiliary" ) { &denial_of_access_log; &get_shoppers_items; if (!$shopper_id) { &check_cookie; } if (!$shopper_id) { &list_items; exit; } &check_tax; if ( $items[1] =~ /$delimiter2/ ) { ($field1,$field2,$field3,$field4,$field5,$field6,$field7,$field8,$field9,$field10,$field11,$field12,$field13,$field14,$field15,$field16,$field17,$field18) = split(/$delimiter2/, $items[1]); } &header; if ( $FORM{'purpose'} eq "credit_phone" ) { $purpose_temp = "$lang[25]"; } if ( $FORM{'purpose'} eq "cod" ) { $purpose_temp = "$lang[97]"; } if ( $FORM{'purpose'} eq "check" ) { $purpose_temp = "$lang[1]"; } if ( $FORM{'purpose'} eq "auxiliary" ) { $purpose_temp = "$option6"; } $purpose_temp_title = "$purpose_temp"; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$purpose_temp</FONT></CENTER>"; print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[15]</FONT></CENTER>\n"; if ($billing_address_only_for_credit_cards && ($FORM{'purpose'} eq "credit_phone") || ( $FORM{'purpose'} eq "auxiliary" )) { print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[172]</FONT></CENTER>\n"; } print "<BR>\n"; &get_shipping_cookie; &print_ship_address; if ( ($FORM{'purpose'} eq "credit_phone") || ( $FORM{'purpose'} eq "auxiliary" ) ) {  if (!$billing_address_only_for_credit_cards) { $show_copy_button = 1; &print_ship_address2; } } &comments if ($comments); &tos_agreement if ($require_tos_agreement); print "<INPUT TYPE=HIDDEN NAME=purpose2 VALUE=\"$FORM{'purpose'}\">"; print "<CENTER><BR>"; if ( $lang[19] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[19]\" VALUE=\"$lang[19]\" BORDER=0>"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[19]\">"; } print "</CENTER> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> </FORM>"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>"; exit; } if ( $FORM{'purpose2'} eq "credit_phone" || $FORM{'purpose2'} eq "cod" || ( $FORM{'purpose2'} eq "check" && ($option3 == 2) ) || $FORM{'purpose2'} eq "auxiliary" ) { &denial_of_access_log; &check_duplicate_order; &get_shoppers_items; &calculate_fulltotal; if ( ($minimum_order) && ($subtotal_original_for_minimum_order < $minimum_order) ) { &list_items; exit; } if ( ($maximum_order) && ($subtotal_original_for_minimum_order > $maximum_order) ) { &list_items; exit; } &get_shoppers_items; if ($comments) { chop($items[0]) if ( $items[0] =~ /\n$/ ); ($a,$b,$c,$d,$e,$f,$coupon_number) = split(/$delimiter2/,$items[0]); $items[0] = "$a$delimiter$b$delimiter$c$delimiter$d$delimiter$FORM{'comments'}$delimiter$f$delimiter$coupon_number\n"; } &copy_shipping_info_to_billing_info; $items[1] = "$FORM{'name'}$delimiter$FORM{'company'}$delimiter$FORM{'address'}$delimiter$FORM{'city'}$delimiter$FORM{'state'}$delimiter$FORM{'zip'}$delimiter$FORM{'country'}$delimiter$FORM{'phone'}$delimiter$FORM{'email'}$delimiter$FORM{'name2'}$delimiter$FORM{'company2'}$delimiter$FORM{'address2'}$delimiter$FORM{'city2'}$delimiter$FORM{'state2'}$delimiter$FORM{'zip2'}$delimiter$FORM{'country2'}$delimiter$FORM{'phone2'}$delimiter$FORM{'email2'}$delimiter$FORM{'confirm_email'}$delimiter$FORM{'confirm_email2'}\n"; $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); foreach $item (@items) { print CART "$item"; } close CART; if ($ip_or_cookie) { &SetCookieExpDate; &SetCompressedCookies('shipping_address','name',"$FORM{'name'}",'company',"$FORM{'company'}",'address',"$FORM{'address'}",'city',"$FORM{'city'}",'state',"$FORM{'state'}",'zip',"$FORM{'zip'}",'country',"$FORM{'country'}",'phone',"$FORM{'phone'}",'email',"$FORM{'email'}",'name2',"$FORM{'name2'}",'company2',"$FORM{'company2'}",'address2',"$FORM{'address2'}",'city2',"$FORM{'city2'}",'state2',"$FORM{'state2'}",'zip2',"$FORM{'zip2'}",'country2',"$FORM{'country2'}",'phone2',"$FORM{'phone2'}",'email2',"$FORM{'email2'}",'confirm_email',"$FORM{'confirm_email'}",'confirm_email2',"$FORM{'confirm_email2'}"); } $required_fields = &required_fields; $required_fields2 = &required_fields2 if ($FORM{'purpose2'} ne "check" && $FORM{'purpose2'} ne "cod"); if (  (!$required_fields || $no_valid_email_address) || ( ($FORM{'purpose2'} eq "credit_phone") && (!$required_fields2 || $no_valid_email_address2) ) || ( ($FORM{'purpose2'} eq "auxiliary") && (!$required_fields2 || $no_valid_email_address2) ) || ($require_tos_agreement && !$FORM{tos_agreement}) ) { $purpose_temp_title = "$purpose_temp"; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">"; print "$lang[20]<BR>$lang[21]\n" if(!$require_tos_agreement || $FORM{tos_agreement}); if ($no_valid_email_address) { print "<BR>$lang[166]\n"; } elsif ($no_valid_email_address2 && ($FORM{'purpose2'} ne "cod" && $FORM{'purpose2'} ne "check") ) { print "<BR>$lang[166]\n"; } elsif ($email_not_confirmed) { print "<BR>$lang[175]\n"; } elsif ($require_tos_agreement && !$FORM{tos_agreement}) { $lang[179] =~ s/http:\/\/www.YourName\.com\//$path4/g if($path4); print "<BR>$lang[179]\n"; } print "<BR><BR>\n"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; exit; } &deny_email_domains; &sales_tax_state_verification; if ( $FORM{'purpose2'} eq "credit_phone" ) { $purpose_temp = "$lang[25]"; } if ( $FORM{'purpose2'} eq "cod" ) { $purpose_temp = "$lang[97]"; } if ( $FORM{'purpose2'} eq "check" ) { $purpose_temp = "$lang[1]"; } if ( $FORM{'purpose2'} eq "auxiliary" ) { $purpose_temp = "$option6"; } if ($paper_font_color) { &paper_font_color; } $purpose_temp_title = "$purpose_temp"; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">"; if ( $FORM{'purpose2'} eq "credit_phone" ) { print "$lang[25]<BR>$lang[31]<BR>$add4"; } if ( $FORM{'purpose2'} eq "cod" ) { print "$lang[97]<BR>$lang[98]"; } if ( $FORM{'purpose2'} eq "check" ) { print "$lang[1]"; } if ( $FORM{'purpose2'} eq "auxiliary" ) { print "$lang[83]"; } print "</FONT></CENTER>"; print "<CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[29]</FONT></CENTER><BR>"; $purchase_method2 = "$purpose_temp"; &order_tracking; &show_invoice; if ( $items[1] =~ /$delimiter2/ ) { ($field1,$field2,$field3,$field4,$field5,$field6,$field7,$field8,$field9,$field10,$field11,$field12,$field13,$field14,$field15,$field16,$field17,$field18) = split(/$delimiter2/, $items[1]); } print "<BR><CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[30]</FONT></CENTER><BR>"; &print_ship_address3; if ( ($FORM{'purpose2'} eq "credit_phone") || ($FORM{'purpose2'} eq "auxiliary") ) { if (!$billing_address_only_for_credit_cards) { &print_ship_address4; } } &comments2 if ($comments); print "<BR> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> </FORM>"; print "<BR><CENTER><TABLE WIDTH=\"$table_width\" BORDER=0 CELLPADDING=0 CELLSPACING=0><TR><TD>\n\n <FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$guarantee</FONT><BR><BR>\n\n"; if ( $FORM{'purpose2'} eq "check" ) { print "<FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[10] </FONT>\n"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"> \"$payable\"</FONT>" if ($payable); print "<BR>\n\n"; print "<FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[11]</FONT><BR><BR>"; } print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add1</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add2</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add3</FONT><BR>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$add4</FONT><BR>" if ( $add4 ); print "<BR><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[12] <A HREF=\"$ssl_target_page\" TARGET=\"_top\"><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$add5</FONT></FONT></A><BR>"; print"<A HREF=\"mailto:$myemail[0]\"><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$myemail[0]</FONT></A><BR>"; print "</TD></TR></TABLE></CENTER>"; &print_button; &check_mailprog; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>\n <NOSCRIPT>\n <SCRIPT>\n /*\n"; if ( $FORM{'purpose2'} eq "credit_phone" ) { $purchase_method = "$lang[25]"; } if ( $FORM{'purpose2'} eq "cod" ) { $purchase_method = "$lang[97]"; } if ( $FORM{'purpose2'} eq "check" ) { $purchase_method = "$lang[1]"; } if ( $FORM{'purpose2'} eq "auxiliary" ) { $purchase_method = "$option6"; } &send_email; if ( ($FORM{'purpose2'} eq "cod") || ($FORM{'purpose2'} eq "auxiliary") ) { $untainted = &untaint("$path1/$shopper_id$ext"); unlink("$untainted"); } exit; } if ( $ENV{'QUERY_STRING'} =~ /^(referrer)(\=)(.*)/i ) { &denial_of_access_log; @referrer_info = split(/\&/,$ENV{'QUERY_STRING'}); foreach (@referrer_info) { ($name,$value) = split(/\=/,$_); if ($name eq "referrer") { $referrer = "$value"; } if ($name eq "url") { $url = "$value"; } if ($name eq "merchant") { $merchant = "$value"; } } if (!$url) { $url = "$path4"; } $referrer_setup = 1; &get_shoppers_items; $untainted = &untaint("$path1/$shopper_id$ext"); $untainted2 = &untaint("$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext"); if (!-e "$untainted") { open(CART,">$untainted"); print CART "$date$delimiter$referrer - $invoice_prefix$invoice\n"; print CART "Shipping address info goes here later\n"; close CART; if ( $ip_or_cookie != 2 ) { use File::Copy; copy("$untainted","$untainted2"); } } $url =~ s/\%3F/\?/g; $url =~ s/\%3D/\=/g; $url =~ s/\%26/\&/g; &header; print "$doctype<HTML><HEAD><META HTTP-EQUIV=REFRESH CONTENT=0;URL=$url></HEAD></HTML>"; exit; } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} =~ /^write_test/i) ) { &denial_of_access_log; $path1 .= "/test.txt"; open(FILE,">>$path1"); print FILE "testing... \n"; close(FILE); &increment_invoice; &header; print "<B>\"carts\" directory and \"shopperid.dat\" file write permissions test:</B><BR>"; open(FILE,"$path1"); @lines = <FILE>; close(FILE); open(FILE,"$path2"); @lines2 = <FILE>; close(FILE); print "<TABLE BORDER=1> <TR><TD>File:</TD><TD>\"temp\" directory:</TD><TD>\"shopperid.dat\" file:</TD></TR> <TR><TD>System Path:</TD><TD>$path1</TD><TD>$path2</TD></TR> <TR><TD>Writable?</TD><TD BGCOLOR=#aaaaff>@lines &nbsp;</TD><TD BGCOLOR=#aaaaff>@lines2 &nbsp;</TD></TR> </TABLE><BR>"; print "Are the contents of the above blue areas growing or changing as you click the RELOAD/REFRESH button at the top of your browser? If not then permissions are not set as writable. If you don't know how to set the permissions, send your host the URL to this page and ask them to set permissions for you on this directory and file so the cart.pl script can write to them."; &footer; } if ( $ENV{'QUERY_STRING'} =~ /^test/i ) { &denial_of_access_log; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - Installation Success!</TITLE>\n$meta_tag\n</HEAD> <BODY BGCOLOR=#FFFFFF>\n"; if ( $diagnostics ) { $temp = ""; foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $temp .= "$name = $value<BR>"; } print "REQUEST_METHOD: $ENV{'REQUEST_METHOD'}<BR>QUERY_STRING: $ENV{'QUERY_STRING'}<BR>POST:<BR>$temp<BR>"; } print "<H1>Installation Success! <BR>Your Dansie Shopping Cart is installed!</H1>"; &check_mailprog; print "<H3>Below is a test form, but it will only work properly if you have your system paths and URLs set correctly in the HOST VARIABLES section of your vars.dat file. Now you may set your Personal, Secure Server and Database Variables.</H3> <FORM METHOD=POST ACTION=\"$path3\"> <FONT FACE=\"Times New Roman\" COLOR=\"#000099\" SIZE=+1> SuperWuper Widget<BR>Price: \$1.00</FONT><BR> <INPUT TYPE=HIDDEN NAME=name VALUE=\"SuperWuper Widget\"> <INPUT TYPE=HIDDEN NAME=price VALUE=\"1.00\"> <INPUT TYPE=HIDDEN NAME=sh VALUE=\"1\"> <INPUT TYPE=HIDDEN NAME=return VALUE=\"$path4\"> <INPUT TYPE=HIDDEN NAME=\"custom1\" VALUE=\"Stock#SW01\">"; if ( $FORM{'merchant'} ) { print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\">"; } print "<INPUT TYPE=SUBMIT NAME=\"add\" VALUE=\"Put in Shopping Cart\">\n"; if ( $FORM{'merchant'} ) { $merchant_form_example = "'&lt;INPUT TYPE=HIDDEN NAME=merchant  VALUE=\"$FORM{'merchant'}\">\\n\\n',\n"; } print "<SCRIPT LANGUAGE=\"JavaScript\">\n document.write('<INPUT TYPE=BUTTON VALUE=\"View Form Source\" onClick=\"viewSource()\">');\n </SCRIPT>\n <SCRIPT LANGUAGE=\"JavaScript\">\n <!--\n function viewSource()\n {\n FormSource = window.open(\"\", \"FormSource\", \"resizable=yes,height=400,width=700,scrollbars=yes,titlebar=no\")\n FormSource.document.open()\n FormSource.document.write('\\n<PRE>\\n\\n&lt;FORM METHOD=POST ACTION=\"$path3\">\\n\\n',\n $merchant_form_example '&lt;B>\\n',\n 'SuperWuper Widget&lt;BR>\\n',\n 'Price: \$1.00&lt;BR>\\n',\n '&lt;/B>\\n\\n',\n '&lt;INPUT TYPE=HIDDEN NAME=name    VALUE=\"SuperWuper Widget\">\\n',\n '&lt;INPUT TYPE=HIDDEN NAME=price   VALUE=\"1.00\">\\n',\n '&lt;INPUT TYPE=HIDDEN NAME=sh      VALUE=\"1\">\\n',\n '&lt;INPUT TYPE=HIDDEN NAME=return  VALUE=\"$path4\">\\n',\n '&lt;INPUT TYPE=HIDDEN NAME=custom1 VALUE=\"Stock#SW01\">\\n\\n',\n '&lt;INPUT TYPE=SUBMIT NAME=\"add\"   VALUE=\"Put in Shopping Cart\">\\n',\n '&lt;/FORM>\\n\\n',\n '&lt;!-- <BR>Details on HTML product forms are in section 1 \\nof Template.html in the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=\"ReadMe\">ReadMe</A> package. \\n-->\\n</PRE>\\n')\n FormSource.document.close()\n }\n //-->\n </SCRIPT>\n"; print "</FORM>\n"; if ($db_version < 3 ) { $database_link_example = "$path3?db$query_separator2" . "stuff.dat$query_separator2" . "All%20Items"; if ( $FORM{'merchant'} ) { $database_link_example .= "$query_separator2" . "merchant=$FORM{'merchant'}"; } } else { $database_link_example = "$path3?db=stuff.dat"; if ( $FORM{'merchant'} ) { $database_link_example .= "&merchant=$FORM{'merchant'}"; } } print "<H3>The cart is activated by either an <A HREF=\"http://www.dansie.net/cart_form_source.html\">HTML product form</A><BR>Or by a link to the cart script with a query string to a <A HREF=\"http://www.dansie.net/stuff.dat\">database file</A>.<BR>Database link example: <A HREF=\"$database_link_example\">$database_link_example</A></H3>"; &footer; } if ( $FORM{'purpose'} eq "coupon_discount" ) { &denial_of_access_log; if (!&GetCookies("$cookie_name2") && ($ip_or_cookie) ) { &cookie_failure; } &get_shoppers_items; $coupon_discount_file = "$vars"; $a = ""; until ($a eq "/" || $coupon_discount_file eq "") { $a = chop($coupon_discount_file); } $coupon_discount_file = "$coupon_discount_file/discount.dat"; open (FILE, "$coupon_discount_file"); @coupons=<FILE>; close (FILE); foreach $line (@coupons) { if ($line =~ /\n$/) { chop($line); } ($coupon_number,$coupon_amount) = split(/$delimiter2/,$line); if ( $FORM{'coupon'} eq "$coupon_number" ) { &get_shoppers_items; chop($items[0]); ($a,$invoice,$state,$ship_method,$comments2,$trash) = split(/$delimiter2/, $items[0]); $items[0] = "$a$delimiter$invoice$delimiter$state$delimiter$ship_method$delimiter$comments2$delimiter$coupon_amount$delimiter$coupon_number\n"; $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); foreach $item (@items) { print CART "$item"; } close (CART); last; } } &list_items; exit; } if ( $FORM{'purpose'} eq "empty_entire_cart" ) { if (!&GetCookies("$cookie_name2") && ($ip_or_cookie) ) { &cookie_failure; } &get_shoppers_items; if (!$shopper_id) { &list_items; exit; } &increment_invoice; &SetCookieExpDate; &SetCookies($cookie_name2,$invoice) if ($ip_or_cookie); $shopper_id = $invoice; $untainted = &untaint("$path1/$shopper_id$ext"); if ( $items[0] =~ /\n$/ ) { chop($items[0]); } (@temp) = split(/$delimiter2/,"$items[0]"); $temp[5] = ""; $items[0] = "$temp[0]$delimiter$temp[1]$delimiter$temp[2]$delimiter$temp[3]$delimiter$temp[4]$delimiter$temp[5]\n"; open(CART,">$untainted"); print CART "$items[0]"; print CART "$items[1]"; close (CART); &list_items; exit; } if ( $ENV{'QUERY_STRING'} eq "login" ) { &merchant_login; } if ( ( $FORM{'login'} || $FORM{'upload'} || $FORM{'delete'} || $FORM{'view'} || $FORM{'up'} || $FORM{'mkdir'} ) && ( $ENV{'CONTENT_TYPE'} =~ /multipart\/form\-data/i ) ) { &merchant_login2; } if ( $ENV{'QUERY_STRING'} =~ /^summary/i ) { &get_shoppers_items; &calculate_fulltotal; &header; print "$lang[170]"; if ($lang[167]) { print "<FONT SIZE=\"$font_size2\" COLOR=\"$font2\" FACE=\"$font_face2\">$lang[167]</FONT><BR>\n"; } if ($lang[168]) { print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[168] $summary_items</FONT><BR>\n"; } if ($lang[169]) { print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[169] $symbol $summary_subtotal</FONT><BR>\n"; } print "$lang[171]"; print " "; exit; } &denial_of_access_log; &list_items; sub list_items { if ( $FORM{'check_cookie'} ) {  if (!$shopper_id) { &check_cookie; } } &get_shoppers_items; chop($items[0]); ($a,$invoice,$state,$ship_method,$comments2,$coupon_amount,$coupon_number) = split(/$delimiter2/, $items[0]); if ( ($ENV{'HTTP_HOST'} || $ENV{'SERVER_NAME'} || $ENV{'SERVER_ADDR'} || $ENV{'REMOTE_ADDR'}) && (!$sl2) ) { exit; } &header; if ( $FORM{'return'} eq "" ) { $FORM{'return'} = "$path4"; } $target = "TARGET=\"$target_name\""; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; $restricted_dir = "$vars"; $a = ""; until ($a eq "/" || $restricted_dir eq "") { $a = chop($restricted_dir); } if ( (-e "$restricted_dir/restrict.dat") ) { open (RESTRICT, "$restricted_dir/restrict.dat"); if ($flock) { flock(RESTRICT, 2); } @restrict = <RESTRICT>; if ($flock) { flock(RESTRICT, 8); } close (RESTRICT); } print "$doctype<HTML><HEAD><TITLE>$biz_temp - $lang[32]</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<SCRIPT LANGUAGE=\"JavaScript\">\n // Pop-up window function\n function Start(page,windowWidth,windowHeight)\n {\n OpenWin = window.open(page, \"infoWindow\", \"toolbar=0,location=0,directories=0,status=1,menubar=0,scrollbars=1,resizable=1,width=\" + windowWidth + \",height=\" + windowHeight + \",top=100,left=300\");\n }\n </SCRIPT>\n <CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[33]</FONT></CENTER>"; if ($authorized_referrers_message) { print "<CENTER><BR><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[17]</FONT> <A HREF=\"mailto:$myemail\"><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$myemail[0]</FONT></A><BR><BR></CENTER>"; print "\n\n\n<!--\n\$ENV{'HTTP_REFERER'} = $ENV{'HTTP_REFERER'}\nChopped to: $http_referer\n-->\n\n\n"; } print "\n\n<FORM NAME=\"symbolform\"> <INPUT TYPE=HIDDEN NAME=symbol VALUE=\"$lang[42] $symbol \"> </FORM>\n"; if ( @items <= 2 ) { print"<BR><CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[40]</FONT></CENTER><BR><CENTER>"; if ( $FORM{'return'} =~ /$path3\?(.*)/ ) { print "<FORM $post_get_method ACTION=\"$FORM{'return'}\" $target > <INPUT TYPE=HIDDEN NAME=\"should_be_get_method\" VALUE=\"yep\">"; } else { print "<FORM $post_get_method ACTION=\"$FORM{'return'}\" $target >"; } print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; if ( $lang[41] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[41]\" VALUE=\"$lang[41]\" BORDER=0>"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[41]\">"; } print "</FONT></FORM></CENTER>"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>"; exit; } else { print "<CENTER> <TABLE BORDER=$borders2 CELLSPACING=0 CELLPADDING=5 WIDTH=\"$table_width\" > <TR BGCOLOR=\"$address_table_bgcolor\" > <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font2\"><I>$lang[54]</I></FONT></TD> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font2\"><I>$lang[74]</I></FONT></TD> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font2\"><I>$lang[34]</I></FONT></TD> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font2\"><I>$lang[36]</I></FONT></TD> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font2\"><I>$lang[82]</I></FONT></TD> </TR>"; if (!$borders2) { print "<TR><TD COLSPAN=5><HR></TD></TR>"; } $total = 0; $ship_total = 0; $nontaxable = 0; $noshipping = 0; $nodiscount = 0; $nodiscount_items = 0; $n = 0; foreach $item (@items) { if ( ( $n == 0 ) || ( $n == 1 ) ) { $n++; next; } @stuff = split(/$delimiter2/,$item); if (@restrict) { &restricted_items; } @customs = (@stuff); for($i=1;$i<=5;$i++) { shift(@customs); } $quantity = $stuff[4]; $price_calc = $stuff[1]; &price_calc; $item_total = $each * $stuff[4]; if ($item =~ /\#non.*taxable\#/i) { $nontaxable += $item_total; } if ($item =~ /\#noshipping\#/i) { $noshipping += $item_total; } if ($item =~ /\#nodiscount\#/i) { $nodiscount += $item_total; $nodiscount_items += $stuff[4]; } $total += $item_total; $sh = $stuff[2] * $stuff[4]; $ship_total += $sh; if ($show_ship) { $rows=2; } else { $rows=1; } print "<TR><TD ROWSPAN=$rows VALIGN=TOP><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$stuff[0]</B></FONT>"; $image = "$stuff[3]"; if ( $image ) { if ( $image =~ /::/ ) { ($image,$image2) = split (/::/,"$image"); if ( $image2 !~ /^(http)/ ) { $temp_url2 =  "$base_img_url/"; } else { $temp_url2 =  ""; } $temp_anchor1 =  "<A HREF=\"$temp_url2$image2\" $large_image_in_same_window_or_new>"; $temp_anchor2 =  "</A>"; } else { $temp_anchor1 = ""; $temp_anchor2 = ""; } if ( $image !~ /^(http)/ ) { $temp_url =  "$base_img_url/"; } else { $temp_url =  ""; } $tn_temp = "$stuff[0]"; $tn_temp =~ s/\"/\&quot\;/g; $tn_temp =~ s/<([^>]|\n)*>//g; print "<BR>$temp_anchor1<IMG SRC=\"$temp_url$image\" BORDER=$img_borders TITLE=\"$tn_temp\" $uni_width $uni_height >$temp_anchor2"; } print "&nbsp;</TD>"; print "<TD ROWSPAN=$rows VALIGN=TOP><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; for ( $i=5;$i<=($customs+4);$i++ ) { $stuff[$i] =~ s/$br_sub/<BR>\n/g; if ( $stuff[$i] ) { print "$stuff[$i]<BR>" unless ( $stuff[$i] =~ /\#non.*taxable\#/i || $stuff[$i] =~ /\#noshipping\#/i || $stuff[$i] =~ /\#nodiscount\#/i || $suppress_desc == 2); } } print "&nbsp;</FONT></TD>"; print "<TD VALIGN=TOP ALIGN=CENTER ROWSPAN=$rows><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" >\n"; print "<FORM METHOD=POST ACTION=$path3> <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"$lang[35]\"> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=return VALUE=\"$FORM{'return'}\"> <INPUT TYPE=HIDDEN NAME=item VALUE=$n> <INPUT TYPE=HIDDEN NAME=convert_cookie_to_ip VALUE=\"$shopper_id\">"; if ($fix_int_quantity != 2) { print "<INPUT TYPE=TEXT NAME=quantity VALUE=\"$stuff[4]\" SIZE=$quantity_digits MAXLENGTH=$quantity_digits>\n"; if ($remove_button_status) { print "<BR>\n"; print "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0><TR><TD ALIGN=CENTER VALIGN=TOP>\n"; } if ( $lang[35] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"purpose\" SRC=\"$lang[35]\" VALUE=\"$lang[35]\" BORDER=0>"; } else { print "<INPUT TYPE=SUBMIT NAME=purpose VALUE=\"$lang[35]\">"; } } else { print "<TABLE BORDER=1 CELLSPACING=0><TR><TD BGCOLOR=\"$address_table_bgcolor\"><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$stuff[4]</FONT></TD></TR></TABLE>\n"; if ($remove_button_status) { print "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0><TR><TD ALIGN=CENTER VALIGN=TOP>\n"; } } print "</FORM>\n"; if ($remove_button_status) { if ( $change_remove_buttons eq "side_by_side" ) { print "</TD>\n<TD VALIGN=TOP>\n"; } else { print "</TD>\n</TR>\n<TR>\n<TD VALIGN=TOP>\n"; } print "<FORM METHOD=POST ACTION=$path3> <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"$lang[38]\"> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=return VALUE=\"$FORM{'return'}\"> <INPUT TYPE=HIDDEN NAME=item VALUE=$n> <INPUT TYPE=HIDDEN NAME=convert_cookie_to_ip VALUE=\"$shopper_id\">"; print "<CENTER>\n"; if ( $lang[38] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"purpose\" SRC=\"$lang[38]\" VALUE=\"$lang[38]\" BORDER=0>"; } else { print "<INPUT TYPE=SUBMIT NAME=purpose VALUE=\"$lang[38]\">"; } print "</CENTER>\n"; print "</FORM>\n"; print "</TD></TR></TABLE>\n"; } print "</TD>\n"; $each = sprintf("$decimals","$each"); print "<TD ROWSPAN=1 ALIGN=RIGHT VALIGN=TOP><NOBR><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$symbol$each</FONT></NOBR></TD>"; print "<TD ROWSPAN=$rows VALIGN=TOP ALIGN=RIGHT><NOBR><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$symbol"; printf "$decimals", $item_total; print "</FONT></NOBR></TD></TR>";   if ( $show_ship ) { $sh = sprintf("$decimals",$sh); print "<TR><TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[37]<BR>($wt)</FONT><BR><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$sh</FONT></TD></TR>"; } if (!$borders2) { print "<TR><TD COLSPAN=5><HR></TD></TR>"; } $n++; } if ( $shipping_weight_total == 1 && $ship_allow == 1 ) { print "<TR><TD COLSPAN=4><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[56]</FONT></TD><TD ALIGN=RIGHT> <FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\"> $ship_total $wt</TD></TR>\n"; } $subtotal_original_for_minimum_order = $total; if ( $coupon_amount ) { &coupon_amount; print "<TR><TD COLSPAN=4><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[116] ($coupon_amount)</FONT></TD><TD ALIGN=RIGHT> <FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\"> - $symbol $temp</TD></TR>"; } &webstore_discount; if ( $discount_amount ) { $total -= $discount_amount; if ( $nontaxable ) { $nontaxable -= $discount_amount; } print "<TR><TD COLSPAN=4><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[108] ($disc_percent\%)</FONT></TD><TD ALIGN=RIGHT> <FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\"> - $symbol $discount_amount</TD></TR>"; if (!$borders2) { print "<TR><TD COLSPAN=5><HR></TD></TR>"; } } $total = sprintf("$decimals",$total); $price[0] = sprintf("$decimals",$price[0]); $tax_temp = $total - $nontaxable; $tax_temp = (($tax/100) * $tax_temp); $tax_temp =~ /(.*)(\.)(\d)(\d)(\d)/; if ( $5 >= 5 ) { $tax_temp += .005; } $tax_temp = sprintf("$decimals",$tax_temp); &ship_calc; if (!$force_no_script) { print " <SCRIPT language=\"JavaScript\">\n compat = false;\n if( parseInt( navigator.appVersion ) >= $compat ) { compat = true; }\n compat = true;\n </SCRIPT>\n <SCRIPT language=\"JavaScript\">\n //if( (navigator.appVersion.search(/Mac/i)>=0) && (navigator.appName==\"Netscape\") )\n if( navigator.appVersion.search(/Mac/i)>=0 )\n { compat = false; }\n compat = true;\n var tax = 0\n var subTotal = $total                // original sub total\n var salesTax = $tax_temp             // state sales tax if resident\n"; if ( $ship_allow == 1 ) { print "\nvar ship_method = $price[0]          // price of cheapest shipping method\n"; } elsif ( $ship_allow == 2) { print "\nvar ship_method = $ship_total        // price of cheapest shipping method\n"; } else { print "\nvar ship_method = 0          // price of cheapest shipping method\n"; } print "\ntotal = subTotal + ship_method       // sub total + cheapest shipping\n"; print "CurrentTaxRate = 0      // Initialize tax carrier\n"; print "Tax = new Array()\n"; $sn = 0; foreach (@state) { print "Tax[\"$state[$sn]\"] = $tax[$sn];\n"; $sn++; } print "\nfunction ShipUpdate() {\n"; if ( !$ship_allow ) { print "total = subTotal;\n"; } if ( $ship_allow == 1 ) { $sn = 0; foreach (@method) { print "if ( document.ordform.ship_method[$sn].selected ) { ship_method = $price[$sn] }\n"; $sn++; } print "total = subTotal + ship_method;\n"; } if ( $ship_allow == 2 ) { $sn = 0; foreach (@shipping_locations) { if (!$price[$sn]) { $price[$sn] = "0"; } print "if ( document.ordform.ship_method[$sn].selected ) { ship_method = $price[$sn] }\n"; $sn++; } print "total = subTotal + ship_method;\n"; } if ( $tax_allow == 1 || $tax_allow == 3 ) { print " if ( document.ordform.tax.type == \"checkbox\" )\n {\n if (document.ordform.tax.checked)\n {\n CurrentTaxRate = $tax[0];\n }\n else\n {\n CurrentTaxRate = 0;\n }\n }\n else\n {\n"; $nt_tax_temp = @tax; for($i=0;$i<$nt_tax_temp;$i++) { print " if ( document.ordform.tax[$i].selected ) { CurrentTaxRate = Number($tax[$i]); }\n"; } if ($lang[47]) { print "if ( document.ordform.tax[$i].selected ) { CurrentTaxRate = Number(0); }\n"; } print "}\n"; } if ( $tax_allow == 2 || $tax_allow == 4 ) { if (!$ship_allow) { print "total = subTotal;\n"; } print "CurrentTaxRate = $tax[0];\n"; } if ( $tax_allow == 1 || $tax_allow == 2 ) { print "total = Number(total) + (($total - $nontaxable)*(CurrentTaxRate/100));\n"; } if ( $tax_allow == 3 || $tax_allow == 4 ) { print "total = Number(total) + ((total - $nontaxable)*(CurrentTaxRate/100));\n"; } if ( $option5 ) { print "\nCodUpdate()\n"; } print "\nUpdate()\n }"; if ( $option5 ) { print "\nfunction CodUpdate()\n {\n current = document.ordform.purpose.selectedIndex;\n if ( document.ordform.purpose.options[current].value == \"cod\" )\n { total += Number($option5); }\n }\n"; } print "\n\nfunction TaxUpdate()\n {\n if (compat)\n {\n if ( document.ordform.tax.type != \"checkbox\" )\n {\n"; $nt_tax_temp = @tax; for($i=0;$i<$nt_tax_temp;$i++) { print "\n if ( document.ordform.tax[$i].selected ) { CurrentTaxRate = Number($tax[$i]);\n }\n"; } if ($lang[47]) { print "if ( document.ordform.tax[$i].selected ) { CurrentTaxRate = Number(0); }\n"; } print "}\n"; print "if ( document.ordform.tax.type == \"checkbox\" && (!document.ordform.tax.checked) )\n {\n CurrentTaxRate = 0;\n }\n if ( document.ordform.tax.type == \"checkbox\" && (document.ordform.tax.checked) )\n {\n CurrentTaxRate = Number($tax[0]);\n }\n total = subTotal + ship_method\n"; if ( $tax_allow == 1 || $tax_allow == 2 ) { print "total = Number(total) + (($total - $nontaxable)*(CurrentTaxRate/100));\n"; } if ( $tax_allow == 3 || $tax_allow == 4 ) { print "total = Number(total) + ((total - $nontaxable)*(CurrentTaxRate/100));\n"; } if ( $option5 ) { print "\nCodUpdate()\n"; } print "\nUpdate()\n }\n }\n function Commas(intnum)\n {\n intstr = \"\"+intnum;\n inserts = parseInt(intstr.length)/3;\n sep = \"$currency_sep\"\n for(i=1;i<=inserts;i++)\n {\n if (intnum >= Math.pow(1000,i))\n {\n intlen = intstr.length\n temp1=parseInt(\"\"+(intnum/Math.pow(1000,i)))\n temp2=intstr.substring(intlen-((i*4)-1),intlen)\n intstr = temp1+sep+temp2\n }\n }\n whole = intstr\n }\n function Update()\n {\n whole = parseInt(total)\n if ( isNaN(whole) ) { whole = \"0\" }\n dec = total - whole\n // JavaScript calc errors. Makes 176.785 - 176 = .784999999. Should be: .785\n // dec = total - parseInt(whole)\n // alert(dec);\n // dec *= 1000\n dec *= Math.pow(10,($decimals2 + 1))\n dec = parseInt(dec)\n dec /= 10\n round = dec - parseInt(dec)\n round *= 10\n round = parseInt(round)\n dec = parseInt(dec)\n if ( round >= 5 )\n {\n dec += 1;\n // if ( dec == 100 ) { whole += 1; dec = 00 }\n if ( dec == Math.pow(10,$decimals2) ) { whole += 1; dec = 0 }\n }\n // if ( dec < 10 ) { dec = \"0\" + dec }\n // if ( isNaN(dec) ) { dec = \"00\" }\n if ( isNaN(dec) ) { dec = \"0\" }\n dec = String(dec)\n while ( dec.length < $decimals2 ) { dec = \"0\" + dec }\n Commas(whole)\n document.ordform.total.value = \"\" + whole\n"; if ( $decimals2 ) { print "document.ordform.total.value = document.ordform.total.value + \".\" + dec;\n";  } print "document.ordform.total.value = document.symbolform.symbol.value + document.ordform.total.value;\n }\n </SCRIPT>\n"; } print "<TR BGCOLOR=\"$address_table_bgcolor\"><TD ALIGN=RIGHT COLSPAN=5><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[43] $symbol "; $currency_sep_total = $total; &currency_sep; print "$currency_sep_total"; print "</FONT>"; if ( $tax_allow || $ship_allow || $option5 ) { if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (!compat)\n {\n document.write('<FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><SUP>*</SUP></FONT>');\n }\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>"; } print "<FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><SUP>*</SUP></FONT>"; if (!$force_no_script) { print "</NOSCRIPT>"; } } print "</TD></TR></TABLE></CENTER>"; print "<BR>"; print "<CENTER><TABLE WIDTH=\"$table_width\" BORDER=0 CELLPADDING=0 CELLSPACING=0>"; print "<TR><TD VALIGN=BOTTOM><FORM name=\"ordform\" METHOD=POST ACTION=$path3>"; if ( $tax_allow == 1 || $tax_allow == 3 ) { if ( @tax == 1 ) { $sales_tax_temp = (($total-$nontaxable)*$tax[0])/100; $sales_tax_temp =~ /(.*)(\.)(\d)(\d)(\d)/; if ( $5 >= 5 ) { $sales_tax_temp += .005; } $sales_tax_temp = sprintf("$decimals","$sales_tax_temp"); print "<!-- BLOCKQUOTE --><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[44] ($tax[0]\%"; if ( $tax_allow == 1 ) { print " = $symbol $sales_tax_temp"; } print ")<BR>$lang[45]<BR>$state[0]. </B></FONT>"; if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<INPUT onClick=\"TaxUpdate($tax[0])\" TYPE=CHECKBOX NAME=\"tax\" VALUE=\"$state[0]\" >')\n }\n else\n { document.write('<INPUT TYPE=CHECKBOX NAME=\"tax\" VALUE=\"$state[0]\" >') }\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>"; } print "<INPUT TYPE=CHECKBOX NAME=\"tax\" VALUE=\"$state[0]\" >"; if (!$force_no_script) { print "</NOSCRIPT>"; } print "<BR><BR>"; } if ( @tax > 1 ) { print "<!-- BLOCKQUOTE --><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[44] $lang[46]</B></FONT><BR>"; if (!$force_no_script) { print " <SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<SELECT onChange=\"TaxUpdate()\" NAME=\"tax\" SIZE=1>\\n');\n }\n else { document.write('<SELECT NAME=\"tax\" SIZE=1 >\\n'); }\n"; $sn = 0; foreach (@tax) { $sales_tax_state_selected = ""; if ( $state && ($state[$sn] eq $state) ) { $sales_tax_state_selected = " SELECTED"; } $sales_tax_temp = (($total-$nontaxable)*$tax[$sn])/100; $sales_tax_temp = sprintf("$decimals","$sales_tax_temp"); print "document.write('<OPTION VALUE=\"$state[$sn]\"$sales_tax_state_selected> $state[$sn]"; if ( $tax[$sn] != 0 ) { print " $tax[$sn]\%"; if ( $tax_allow == 1 ) { print " = $symbol $sales_tax_temp"; } } print "\\n');\n"; $sn++; } if ( $lang[47] ) { print "document.write('<OPTION VALUE=\"\" >$lang[47]\\n');\n"; } print "</SCRIPT>\n"; } print "</SELECT>\n"; if (!$force_no_script) { print "<NOSCRIPT>"; } print "<SELECT NAME=\"tax\" SIZE=1 >\n"; $sn = 0; foreach (@tax) { $sales_tax_state_selected = ""; if ( $state && ($state[$sn] eq $state) ) { $sales_tax_state_selected = " SELECTED"; } $sales_tax_temp = (($total-$nontaxable)*$tax[$sn])/100; $sales_tax_temp = sprintf("$decimals","$sales_tax_temp"); print "<OPTION VALUE=\"$state[$sn]\"$sales_tax_state_selected>$state[$sn]"; if ( $tax[$sn] != 0 ) { print " $tax[$sn]\%"; if ( $tax_allow == 1 ) { print " = $symbol $sales_tax_temp"; } } print "\n"; $sn++; } if ( $lang[47] ) { print "<OPTION VALUE=\"\">$lang[47]\n"; } print "</SELECT>\n"; if (!$force_no_script) { print "</NOSCRIPT>"; } print "<BR><BR>"; } } if ( $tax_allow == 2 || $tax_allow == 4 ) { $sales_tax_temp = (($total-$nontaxable)*$tax[0])/100; $sales_tax_temp = sprintf("$decimals","$sales_tax_temp"); print "<!-- BLOCKQUOTE --><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[44] ($tax[0]\%"; if ( $tax_allow == 2 ) { print " = $symbol $sales_tax_temp"; } print ") </B></FONT>"; print "<INPUT TYPE=HIDDEN NAME=\"tax\" VALUE=\"$state[0]\" ><BR><BR>"; } if ( $ship_allow == 1 ) { print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[48]</B></FONT><BR>"; if (!$force_no_script) { print "<SCRIPT language=\"javascript\">\n if (compat)\n {\n document.write('<SELECT NAME=\"ship_method\" onChange=\"ShipUpdate()\" size=1>\\n')\n }\n else { document.write('<SELECT NAME=\"ship_method\" size=1>\\n') }\n"; $n = 0; foreach (@method) { $shipping_option_selected = ""; if ( $ship_method && ($method[$n] eq $ship_method) ) { $shipping_option_selected = " SELECTED"; } if ( $method_init_price[$n] eq "0.00" && $method_price[$n] eq "0.00" ) { print "document.write('<OPTION VALUE=\"$method[$n]\"$shipping_option_selected>$method[$n]\\n');\n"; } else { print "document.write('<OPTION VALUE=\"$method[$n]\"$shipping_option_selected>$method[$n] = $symbol2 $price[$n]\\n');\n"; } $n++; } print "document.write('</SELECT>\\n<BR>\\n');\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<SELECT NAME=\"ship_method\" size=1>\n"; $n = 0; foreach (@method) { $shipping_option_selected = ""; if ( $ship_method && ($method[$n] eq $ship_method) ) { $shipping_option_selected = " SELECTED"; } if ( $method_init_price[$n] eq "0.00" && $method_price[$n] eq "0.00" ) { print "<OPTION VALUE=\"$method[$n]\"$shipping_option_selected>$method[$n]\n"; } else { print "<OPTION VALUE=\"$method[$n]\"$shipping_option_selected>$method[$n] = $symbol $price[$n]\n"; } $n++; } print "</SELECT>\n<BR>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } } if ( $ship_allow == 2 ) { print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[49]</B></FONT><BR>"; if (!$force_no_script) { print "<SCRIPT language=\"javascript\">\n if (compat)\n {\n document.write('<SELECT NAME=\"ship_method\" onChange=\"ShipUpdate()\" size=1>\\n')\n }\n else { document.write('<SELECT NAME=\"ship_method\" size=1>\\n') }\n"; $n = 0; foreach (@shipping_locations) { $shipping_option_selected = ""; if ( $ship_method && ($shipping_locations[$n] eq $ship_method) ) { $shipping_option_selected = " SELECTED"; } if ( $price[$n] eq "0.00" ) { print "document.write('<OPTION VALUE=\"$shipping_locations[$n]\"$shipping_option_selected>$shipping_locations[$n]\\n');\n"; } else { print "document.write('<OPTION VALUE=\"$shipping_locations[$n]\"$shipping_option_selected>$shipping_locations[$n] = $symbol2 $price[$n]\\n');\n"; } $n++; } print "document.write('</SELECT>\\n<BR>\\n');\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<SELECT NAME=\"ship_method\" size=1>\n"; $n = 0; foreach (@shipping_locations) { $shipping_option_selected = ""; if ( $ship_method && ($shipping_locations[$n] eq $ship_method) ) { $shipping_option_selected = " SELECTED"; } $shipping_via_amount = $shipping_via_amount[$n]; &ship_calc; if ( $price[$n] eq "0.00" ) { print "<OPTION VALUE=\"$shipping_locations[$n]\"$shipping_option_selected>$shipping_locations[$n]\n"; } else { print "<OPTION VALUE=\"$shipping_locations[$n]\"$shipping_option_selected>$shipping_locations[$n] = $symbol $price[$n]\n"; } $n++; } print "</SELECT>\n<BR>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } } print "<BR> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><B>$lang[24]</B></FONT><BR>"; if ($option5 ne "0.00") { $cod_temp = sprintf("$decimals","$option5"); $cod_temp = "+$symbol $cod_temp"; } if (!$force_no_script) { print "<SCRIPT language=\"javascript\">\n if (compat)\n {\n document.write('<SELECT NAME=purpose onChange=\"ShipUpdate()\" size=1>')\n }\n else { document.write('<SELECT NAME=purpose size=1>') }\n"; print "document.write('<OPTION VALUE=\"credit\">$lang[14]')\n" if ($option1); print "document.write('<OPTION VALUE=\"aux_processor\">$lang[154]')\n" if ($aux_processor_payment_option); print "document.write('<OPTION VALUE=\"aux_processor2\">$lang[165]')\n" if ($aux_processor2_payment_option); print "document.write('<OPTION VALUE=\"check_transfer\">$lang[71]')\n" if ($option4); print "document.write('<OPTION VALUE=\"credit_phone\">$lang[25]')\n" if ($option2); print "document.write('<OPTION VALUE=\"check\">$lang[26]')\n" if ($option3); print "document.write('<OPTION VALUE=\"cod\">$lang[97] $cod_temp')\n" if ($option5); print "document.write('<OPTION VALUE=\"auxiliary\"> $option6')\n" if ($option6); print "document.write('</SELECT><BR><BR>');\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>"; } print "<SELECT NAME=purpose size=1>"; print "<OPTION VALUE=\"credit\">$lang[14]" if ($option1); print "<OPTION VALUE=\"aux_processor\">$lang[154]" if ($aux_processor_payment_option); print "<OPTION VALUE=\"aux_processor2\">$lang[165]" if ($aux_processor2_payment_option); print "<OPTION VALUE=\"check_transfer\">$lang[71]" if ($option4); print "<OPTION VALUE=\"credit_phone\">$lang[25]" if ($option2); print "<OPTION VALUE=\"check\">$lang[26]" if ($option3); print "<OPTION VALUE=\"cod\">$lang[97] $cod_temp" if ($option5); print "<OPTION VALUE=\"auxiliary\"> $option6" if ($option6); print "</SELECT><BR><BR>"; if (!$force_no_script) { print "</NOSCRIPT>"; } print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; if ( ($minimum_order) && ($subtotal_original_for_minimum_order < $minimum_order) ) { print "<FONT SIZE=\"$font_size2\" COLOR=\"$font2\" FACE=\"$font_face2\">$lang[18] $symbol $minimum_order<BR></FONT>\n"; print "<INPUT TYPE=HIDDEN NAME=\"total\">\n"; } elsif ( ($maximum_order) && ($subtotal_original_for_minimum_order > $maximum_order) ) { print "<FONT SIZE=\"$font_size2\" COLOR=\"$font2\" FACE=\"$font_face2\">$lang[176]<BR></FONT>\n"; print "<INPUT TYPE=HIDDEN NAME=\"total\">\n"; } else { if ( $lang[148] =~ /^http/i ) { print "<INPUT TYPE=HIDDEN NAME=\"total\">\n"; print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[148]\" VALUE=\"$lang[148]\" BORDER=0>\n"; } else { if (!$force_no_script) { print "<SCRIPT language=\"javascript\">\n if (compat)\n {\n document.write('<INPUT name=\"total\" VALUE=\"$lang[148]\" TYPE=SUBMIT>');\n }\n else\n {\n document.write('<INPUT name=\"total\" VALUE=\"$lang[148]\" TYPE=SUBMIT>');\n }\n"; print "if (compat) { ShipUpdate() } // Initializes JavaScript values\n"; print "</SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<INPUT name=\"total\" VALUE=\"$lang[148]\" TYPE=SUBMIT>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } } } print "</FONT> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=convert_cookie_to_ip VALUE=\"$shopper_id\"> </FORM></TD> <TD VALIGN=BOTTOM ALIGN=CENTER WIDTH=50%>"; if ($empty_entire_cart) { if (!$force_no_script) { print "\n\n<FORM NAME=\"empty_entire_cart\" METHOD=POST ACTION=\"$path3\" onSubmit=\"return confirm('$lang[89]')\">\n"; } else { print "\n\n<FORM METHOD=POST ACTION=$path3>\n"; } print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[87]<BR>\n <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"empty_entire_cart\">\n <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\">\n <INPUT TYPE=HIDDEN NAME=return VALUE=\"$FORM{'return'}\">\n <INPUT TYPE=HIDDEN NAME=convert_cookie_to_ip VALUE=\"$shopper_id\">\n"; if ( $lang[88] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[88]\" VALUE=\"$lang[88]\" BORDER=0>\n"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[88]\">\n"; } print "</FONT>\n</FORM>\n<BR><FORM></FORM>\n\n"; } if ($coupon_discount) { print "\n\n<FORM METHOD=POST ACTION=$path3>\n <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[115]<BR>\n <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"coupon_discount\">\n </FONT>\n <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" >\n <INPUT TYPE=TEXT NAME=coupon SIZE=10 MAXLENGTH=25>\n </FONT>\n <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">\n <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\">\n <INPUT TYPE=HIDDEN NAME=return VALUE=\"$FORM{'return'}\">\n <INPUT TYPE=HIDDEN NAME=convert_cookie_to_ip VALUE=\"$shopper_id\">\n"; if ( $lang[146] =~ /^http/i ) { print "<BR><INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[146]\" VALUE=\"$lang[146]\" BORDER=0 ALIGN=CENTER>\n"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[146]\">\n"; } print "</FONT>\n</FORM>\n<BR><BR>\n\n"; } if ( $FORM{'return'} =~ /$path3\?(.*)/ ) { print "\n\n<FORM $post_get_method ACTION=\"$FORM{'return'}\" $target > <INPUT TYPE=HIDDEN NAME=\"should_be_get_method\" VALUE=\"yep\">\n"; } else { print "\n\n<FORM $post_get_method ACTION=\"$FORM{'return'}\" $target >\n"; } print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">\n"; if ( $lang[41] =~ /^http/i ) { print "<INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[41]\" VALUE=\"$lang[41]\" BORDER=0>\n"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[41]\">\n"; } print "</FONT>\n</FORM>\n\n</TD></TR>\n"; print "<TR><TD COLSPAN=2>"; if ( $ship_allow ) { if (!$force_no_script) { print "<NOSCRIPT>"; } print "<BR><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">* $lang[50]<BR></FONT>"; if (!$force_no_script) { print "</NOSCRIPT>"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (!compat)\n {\n document.write('<BR><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">* $lang[50]<BR></FONT>');\n }\n </SCRIPT>\n"; } } if ( $tax_allow ) { if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">* $lang[51]<BR></FONT>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (!compat)\n {\n document.write('<FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">* $lang[51]<BR></FONT>');\n }\n </SCRIPT>\n"; } } if ( $option5 > 0 ) { if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">* $lang[103]<BR></FONT>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (!compat)\n {\n document.write('<BR><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">* $lang[103]<BR></FONT>');\n }\n </SCRIPT>\n"; } } print "</TD></TR></TABLE></CENTER>"; } print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; print "</BODY></HTML>"; } sub change_quantity { @stuff = split(/$delimiter2/,$item); &fix_quantity2; $stuff[4] = $FORM{'quantity'}; unless ( $FORM{'quantity'} <= 0 ) { print CART "$stuff[0]$delimiter$stuff[1]$delimiter$stuff[2]$delimiter$stuff[3]$delimiter$stuff[4]"; for($i=5;$i<=($customs+4);$i++) { print CART "$delimiter$stuff[$i]"; } } } sub delete_old_carts { opendir(DIR,"$path1"); @cart_list=grep(/\w/,readdir(DIR)); close(DIR); foreach $cart (sort @cart_list) { if ( (-M "$path1/$cart") > $expire ) { $untainted = &untaint("$path1/$cart"); unlink("$untainted"); } if ( (-s "$path1/$cart") > $max_size_delete_shoppers_file ) { $untainted = &untaint("$path1/$cart"); unlink("$untainted"); } } } sub show_invoice { &get_shoppers_items; $limited_dir = "$vars"; $a = ""; until ($a eq "/" || $limited_dir eq "") { $a = chop($limited_dir); } if ( (-e "$limited_dir/limited.dat") ) { open (LIMITED, "$limited_dir/limited.dat"); if ($flock) { flock(LIMITED, 2); } @limited = <LIMITED>; if ($flock) { flock(LIMITED, 8); } close (LIMITED); } chop($items[0]); ($date,$invoice,$state,$ship_method,$comments2,$coupon_amount,$coupon_number) = split(/$delimiter2/, $items[0]); print "<BR><CENTER><TABLE WIDTH=\"$table_width\" BORDER=0 CELLPADDING=0 CELLSPACING=0><TR><TD>"; print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[52] $date<BR>"; print "$lang[53] $invoice</FONT><BR><BR>"; print "</TD></TR></TABLE></CENTER>"; print "<CENTER><TABLE BORDER=1 CELLPADDING=5 CELLSPACING=0 WIDTH=\"$table_width\"><TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[54]</FONT></TD><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[55]</FONT></TD><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[34]</FONT></TD>"; if ($show_ship) { print "<TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><NOBR>$lang[37] <FONT SIZE=-2>($wt)</FONT></NOBR></FONT></TD>"; } print "<TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[36]</FONT></TD><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[82]</FONT></TD></TR>"; $total = 0; $nontaxable = 0; $noshipping = 0; $nodiscount = 0; $nodiscount_items = 0; $ship_total = 0; $n = 0; foreach $item (@items) { if ( ( $n == 0 ) || ( $n == 1 ) ) { $n++; next; } @stuff = split(/$delimiter2/,$item); &limited_item_deincrement; @customs = (@stuff); for($i=1;$i<=5;$i++) { shift(@customs); } $quantity = $stuff[4]; $price_calc = $stuff[1]; &price_calc; $item_total = $each * $stuff[4]; if ($item =~ /\#non.*taxable\#/i) { $nontaxable += $item_total; } if ($item =~ /\#noshipping\#/i) { $noshipping += $item_total; } if ($item =~ /\#nodiscount\#/i) { $nodiscount += $item_total; $nodiscount_items += $stuff[4]; } $total += $item_total; $sh = $stuff[2] * $stuff[4]; $ship_total += $sh; print "<TR><TD VALIGN=top><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$stuff[0]</FONT></TD><TD VALIGN=top><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; $br = 0; for ( $i=5;$i<=($customs+4);$i++ ) { if ( $stuff[$i] =~ /\n/ ) { chop($stuff[$i]); } $stuff[$i] =~ s/$br_sub/<BR>\n/g; if ( $stuff[$i] ) { $br += 1; if ( $br == 1 ) { print "$stuff[$i]" unless ( $stuff[$i] =~ /\#non.*taxable\#/i || $stuff[$i] =~ /\#noshipping\#/i || $stuff[$i] =~ /\#nodiscount\#/i || $suppress_desc == 2);  } else { print "<BR>$stuff[$i]" unless ( $stuff[$i] =~ /\#non.*taxable\#/i || $stuff[$i] =~ /\#noshipping\#/i || $stuff[$i] =~ /\#nodiscount\#/i || $suppress_desc == 2);  } } } if (!$br) { print "<BR>"; } print "&nbsp;</FONT></TD><TD ALIGN=CENTER VALIGN=top><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$stuff[4]</FONT></TD>"; if ($show_ship) { $sh = sprintf("$decimals",$sh); print "<TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$sh</FONT></TD>"; } print "<TD VALIGN=top ALIGN=right><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; printf "$decimals",$each; print "</FONT></TD><TD VALIGN=top ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">"; printf "$decimals", $item_total; print "</FONT></TD></TR>"; $n++; } if ($show_ship) { $cols = 5; } else { $cols = 4; } if ( $coupon_amount ) { &coupon_amount; print "<TR><TD COLSPAN=$cols ><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[116] ($coupon_amount)</FONT></TD><TD ALIGN=RIGHT> <FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\"> - $symbol $temp</TD></TR>"; } &webstore_discount; if ( $discount_amount ) { $total -= $discount_amount; if ( $nontaxable ) { $nontaxable -= $discount_amount; } print "<TR><TD COLSPAN=$cols ><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[108] ($disc_percent\%)</FONT></TD><TD ALIGN=RIGHT> <FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\"> - $symbol $discount_amount</TD></TR>"; } if (!$lang[70]) { $lang[70] = "$lang[43]"; } print "<TR><TD COLSPAN=$cols><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[70]</FONT></TD><TD ALIGN=RIGHT><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"> <NOBR>$symbol "; $currency_sep_total = $total; &currency_sep; print "$currency_sep_total"; print "</NOBR></FONT></TD></TR>"; if ( $ship_allow ) { $ship_weight_total = "$ship_total"; &ship_calc; if ( $shipping_weight_total == 1 && $ship_allow == 1 ) { $shipping_weight_temp = " $ship_weight_total $wt"; } else { $shipping_weight_temp = ""; } print "<TR><TD COLSPAN=$cols><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[56]$shipping_weight_temp ($ship_method)</FONT></TD><TD ALIGN=RIGHT><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"> <NOBR>$symbol"; $ship_total = sprintf("$decimals","$ship_total"); printf "$decimals", $ship_total; print "</NOBR></FONT></TD></TR>"; } else { $ship_total = 0; } if ( $state ) { &get_sales_tax; if ( $tax_allow == 1 || $tax_allow == 2 ) { $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; } if ( $tax_allow == 3 || $tax_allow == 4 ) { $taxes = ($total - $nontaxable + $ship_total) * $tax_rate; $taxes /= 100; } else { $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; } $taxes =~ /(.*)(\.)(\d)(\d)(\d)/; if ( $5 >= 5 ) { $taxes += .005; } print "<TR><TD COLSPAN=$cols><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$state $lang[151] $lang[44]"; print " $tax_rate"; print "\%"; print "</FONT></TD><TD ALIGN=RIGHT><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"> <NOBR>$symbol"; printf "$decimals", $taxes; print "</NOBR></FONT></TD></TR>"; } if ( ($FORM{'purpose2'} eq "cod") && ($option5 ne "0.00") ) { print "<TR><TD COLSPAN=$cols><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[102]</FONT></TD><TD ALIGN=RIGHT><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"> <NOBR>$symbol"; printf "$decimals", $option5; print "</NOBR></FONT></TD></TR>"; $total += $option5; } $total += $ship_total; $total += $taxes; $total = sprintf("$decimals","$total"); print "<TR><TD COLSPAN=$cols><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[57]</FONT></TD><TD ALIGN=RIGHT><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"> <NOBR>$symbol "; $currency_sep_total = $total; &currency_sep; print "$currency_sep_total"; print "</NOBR></FONT></TD></TR></TABLE></CENTER><BR>"; if ( $deincrement ) { open (LIMITED, ">$limited_dir/limited.dat"); if ($flock) { flock(LIMITED, 2); } foreach (@limited) { if ($_ =~ /\n$/) { chop($_); } print LIMITED "$_\n"; } if ($flock) { flock(LIMITED, 8); } close (LIMITED); &check_on_limited_quantity_inv_summary; } $comish = "$vars"; $a = ""; until ($a eq "/" || $comish eq "") { $a = chop($comish); } $comish = "$comish/comish.dat"; if (-e "$comish") { open (COMISH,"$comish"); @comish=<COMISH>; close (COMISH); if ( $comish[0] =~ /\n$/ ) { chop( $comish[0]); } require "$comish[0]"; $comish_total = $total - $taxes; $comish_total -= $ship_total; $comish_total = sprintf("$decimals",$comish_total); $commission_amount = $comish[1] * $comish_total; $commission_amount = sprintf("$decimals",$commission_amount); &the_comish($invoice,$comish_total,$commission_amount,$purchase_method2); } @temp = split(/\|/,"$items[1]"); if ( ($purchase_method2 eq "$lang[97]") || ($purchase_method2 eq "$lang[1]") ) { $customer_name = (@temp)[0]; $customer_email = (@temp)[8]; } else { $customer_name = (@temp)[9]; $customer_email = (@temp)[17]; } $customer_name =~ s/\,/ /g; $customer_name =~ s/ /\+/g; if ( ($guarantee =~ /(cashflow\=)/) || ($guarantee =~ /(\#subtotal\#)/) || ($guarantee =~ /(\#orderid\#)/) ) { $just_do_it = 1; if ( $just_do_it ) { $comish_total = $total - $taxes;  $comish_total -= $ship_total if ( $ship_allow ); $comish_total = sprintf("$decimals",$comish_total); $comish_total =~ s/ //g; $guarantee =~ s/(\#subtotal\#)/$comish_total/gi; if ($invoice =~ /(.+?)(\s?-\s?)(.+)/) { $referrer_temp = $1; $invoice_temp = $3; $guarantee =~ s/(\#orderid\#)/$invoice_temp/gi; $guarantee =~ s/(\#referrer\#)/$referrer_temp/gi; } else { $guarantee =~ s/(\#orderid\#)/$invoice/gi; $guarantee =~ s/(\#referrer\#)//gi; } $customer_email =~ s/('|"|&|#|\||\\|\/)//g; $customer_name =~ s/('|"|&|#|\||\\|\/)//g; $purchase_method_no_spaces =~ s/('|"|&|#|\||\\|\/)//g; if ($purchase_method) { $purchase_method_no_spaces = "$purchase_method"; } else { $purchase_method_no_spaces = "$purchase_method2"; } $purchase_method_no_spaces =~ s/ /+/g; $guarantee =~ s/(\#ordertype\#)/$purchase_method_no_spaces/gi; $guarantee =~ s/(\#email\#)/$customer_email/gi; $guarantee =~ s/(\#name\#)/$customer_name/gi; } elsif ($guarantee =~ /(commission-junction\.com)/) { $comish_total = $total - $taxes;  $comish_total -= $ship_total if ( $ship_allow ); $comish_total = sprintf("$decimals",$comish_total); $comish_total =~ s/ //g; $guarantee =~ s/(\#orderid\#)/$invoice/; $guarantee =~ s/(\#subtotal\#)/$comish_total/; $guarantee =~ s/TYPE\=sale/TYPE\=lead/gi; $guarantee =~ s/(OID\=)(.+)(\&)(TYPE)/$1$customer_email$3$4/gi; } else { $guarantee =~ s/(\<img src\=)(\S+)(\#subtotal\#)(.*)(\>)//i; } } } sub get_shipping_cookie { if (&GetCompressedCookies('shipping_address','name','company','address','city','state','zip','country','email','phone','name2','company2','address2','city2','state2','zip2','country2','email2','phone2','confirm_email','confirm_email2')) { $field1 = "$Cookies{'name'}"; $field2 = "$Cookies{'company'}"; $field3 = "$Cookies{'address'}"; $field4 = "$Cookies{'city'}"; $field5 = "$Cookies{'state'}"; $field6 = "$Cookies{'zip'}"; $field7 = "$Cookies{'country'}"; $field8 = "$Cookies{'phone'}"; $field9 = "$Cookies{'email'}"; $field10 = "$Cookies{'name2'}"; $field11 = "$Cookies{'company2'}"; $field12 = "$Cookies{'address2'}"; $field13 = "$Cookies{'city2'}"; $field14 = "$Cookies{'state2'}"; $field15 = "$Cookies{'zip2'}"; $field16 = "$Cookies{'country2'}"; $field17 = "$Cookies{'phone2'}"; $field18 = "$Cookies{'email2'}"; $field19 = "$Cookies{'confirm_email'}"; $field20 = "$Cookies{'confirm_email2'}"; } } sub sales_tax_state_verification { if ( $assess_tax_on_shipping_or_billing_state eq "billing" ) { if ($sales_tax_state_verification == 1) { $shipping_or_billing_state_to_be_taxed = "$FORM{'state2'}"; } elsif ($sales_tax_state_verification == 2) { $shipping_or_billing_state_to_be_taxed = "$FORM{'country2'}"; } } else { if ($sales_tax_state_verification == 1) { $shipping_or_billing_state_to_be_taxed = "$FORM{'state'}"; } elsif ($sales_tax_state_verification == 2) { $shipping_or_billing_state_to_be_taxed = "$FORM{'country'}"; } } ($trash,$trash,$sales_tax_state,$trash) = split(/\|/,$items[0]); if ( ( ($sales_tax_state_verification == 1 && $use_state) || ($sales_tax_state_verification == 2) ) && ( $sales_tax_state && ($tax_allow == 1 || $tax_allow == 3) ) && ( $shipping_or_billing_state_to_be_taxed !~ /^($sales_tax_state)$/i) ) { $purpose_temp_title = $purpose_temp; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">"; print "$lang[159] <B>$sales_tax_state</B><BR><BR>$lang[160] <B>$shipping_or_billing_state_to_be_taxed</B><BR><BR><A HREF=\"$correct_sales_tax_location_back_link\">$lang[161]</A></FONT><BR><BR></CENTER>"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; exit; } if ( ($sales_tax_state_verification == 1 && $use_state && !$sales_tax_state ) || ($sales_tax_state_verification == 2 && !$sales_tax_state ) ) { foreach $temp_state (@state) { if ( $shipping_or_billing_state_to_be_taxed eq "$temp_state" ) { (@temp) = split(/\|/,$items[0]); $temp[2] = "$temp_state"; $items[0] = join("|",@temp); open(CART,">$untainted"); foreach $item (@items) { print CART "$item"; } close CART; } } } } sub deny_email_domains { foreach $email_domain (@deny_email_domains) { $email_domain_temp = $email_domain; $email_domain_temp =~ s/\./\\\./g; if ( $FORM{'email'} =~ /($email_domain_temp)$/i || $FORM{'email2'} =~ /($email_domain_temp)$/i ) { $bad_email_domain = "$email_domain"; last; } } if ( $bad_email_domain ) { $purpose_temp_title = $purpose_temp; $purpose_temp_title =~ s/<([^>]|\n)*>//g; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $purpose_temp_title</TITLE>\n$meta_tag\n</HEAD>"; print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; print "<CENTER>$lang[114]</CENTER>"; if ( $show_bizname ) { print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$bizname</FONT></CENTER>"; } if ( $image ) { print "<CENTER><IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0></CENTER>"; } print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">"; print "$lang[162] <B>$bad_email_domain</B> <BR><BR><A HREF=\"$cambist_back\">$lang[163]</A></FONT><BR><BR></CENTER>"; print "<CENTER><FONT SIZE=-1 COLOR=\"$font1\" FACE=\"$font_face1\">$lang[111]</FONT></CENTER><BR>"; print "<CENTER><TABLE BORDER=0 BGCOLOR=$link_bg><TR><TD><A HREF=\"http://www.dansie.net/$referral_id_code\" TARGET=\"cart\" ><FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\">Dansie Shopping Cart</FONT></A> <FONT SIZE=-1 COLOR=\"$link_font\" FACE=\"$font_face1\"><I>http://www.dansie.net</I></FONT></TR></TR></TABLE></CENTER>"; exit; } } sub copy_shipping_info_to_billing_info { if ($billing_address_only_for_credit_cards) { $FORM{'name2'} = $FORM{'name'}; $FORM{'company2'} = $FORM{'company'}; $FORM{'address2'} = $FORM{'address'}; $FORM{'city2'} = $FORM{'city'}; $FORM{'state2'} = $FORM{'state'}; $FORM{'zip2'} = $FORM{'zip'}; $FORM{'country2'} = $FORM{'country'}; $FORM{'phone2'} = $FORM{'phone'}; $FORM{'email2'} = $FORM{'email'}; $FORM{'confirm_email2'} = $FORM{'confirm_email'}; } } sub print_ship_address { &get_shoppers_items; ($trash,$trash,$sales_tax_state,$trash) = split(/\|/,$items[0]); print "<FORM NAME=\"form1\" METHOD=POST ACTION=\"$path3\" $ssl_target_top > <INPUT TYPE=HIDDEN NAME=purpose VALUE=ship_info> <TABLE BORDER=0 WIDTH=\"$table_width\" ALIGN=CENTER > <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[4] </FONT> </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" ><INPUT TYPE=TEXT SIZE=40 MAXLENGTH=$maxlength_name NAME=name VALUE=\"$field1\"></TD> </TR>"; if ( $use_company_name_field ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[90] </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\"> <INPUT TYPE=TEXT SIZE=40 MAXLENGTH=$maxlength_company NAME=company VALUE=\"$field2\"> </TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[58] </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" ><INPUT TYPE=TEXT SIZE=40 MAXLENGTH=$maxlength_address NAME=address VALUE=\"$field3\"></TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[59] </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" ><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_city NAME=city VALUE=\"$field4\"> </TD> </TR>"; if ( $use_state ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[60] </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\">\n"; if ($state_list) { @state_list = split(/\,/,$state_list); print "<SELECT NAME=state>\n"; foreach (@state_list) { if ($field5 && ($_ eq "$field5")) { print "<OPTION SELECTED>$_\n"; } elsif ($sales_tax_state && ($_ eq "$sales_tax_state")) { print "<OPTION SELECTED>$_\n"; } else { print "<OPTION>$_\n"; } } print "</SELECT>\n"; } else { print "<INPUT TYPE=TEXT SIZE=$state_length MAXLENGTH=$state_length NAME=state VALUE=\"$field5\">\n"; } print "</TD></TR>\n"; } if ( $use_zipcode_fields ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[61] </FONT></TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\">  <INPUT TYPE=TEXT SIZE=10 MAXLENGTH=$maxlength_zip NAME=zip VALUE=\"$field6\"> </TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[7] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" >\n"; if ($country_list) { @country_list = split(/\,/,$country_list); print "<SELECT NAME=country>\n"; foreach (@country_list) { if ($field7 && ($_ eq "$field7")) { print "<OPTION SELECTED>$_\n"; } else { print "<OPTION>$_\n"; } } print "</SELECT>\n"; } else { print "<INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_country NAME=country VALUE=\"$field7\">\n"; } print "</TD>\n </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[9] </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\"> <INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_phone NAME=phone VALUE=\"$field8\"></TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[8] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" ><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_email NAME=email VALUE=\"$field9\"></TD> </TR>\n"; if ( $reqired_field_prefs =~ /(confirm_email)/i ) { print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[174] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" ><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_email NAME=confirm_email VALUE=\"$field19\"></TD> </TR>\n"; } print "</TABLE>"; } sub print_ship_address2 { print " <CENTER> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[104]</FONT>"; if ( (!$force_no_script) && ($show_copy_button) ) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n function CopyInfo()\n {\n document.form1.name2.value = document.form1.name.value;\n"; if ( $use_company_name_field ) { print "document.form1.company2.value = document.form1.company.value;\n"; } print "document.form1.address2.value = document.form1.address.value;\n document.form1.city2.value = document.form1.city.value;\n"; if ($use_state) { if ($state_list) { print "document.form1.state2.options.selectedIndex = document.form1.state.options.selectedIndex;\n"; } else { print "document.form1.state2.value = document.form1.state.value;\n"; } } if ($use_zipcode_fields) { print "document.form1.zip2.value = document.form1.zip.value;\n"; } if ($country_list) { print "document.form1.country2.options.selectedIndex = document.form1.country.options.selectedIndex;\n"; } else { print "document.form1.country2.value = document.form1.country.value;\n"; } if ( $reqired_field_prefs =~ /(confirm_email)/i ) { print "document.form1.confirm_email2.value = document.form1.confirm_email.value;\n"; } print "document.form1.phone2.value = document.form1.phone.value;\n document.form1.email2.value = document.form1.email.value;\n }\n"; if ( $lang[105] =~ /This wont work/i ) { print "document.write('<BR><INPUT TYPE=IMAGE NAME=\"\" SRC=\"$lang[105]\" VALUE=\"$lang[105]\" BORDER=0 OnClick=\"CopyInfo()\">');\n"; } elsif ( $lang[105] ) { print "compat = true;\n if( navigator.appVersion.search(/Mac/i)>=0 )\n { compat = false; }\n if( parseInt( navigator.appVersion ) >= $compat ) { compat = true; }\n compat = true;\n if ( compat )\n { document.write('<BR><INPUT TYPE=BUTTON VALUE=\"$lang[105]\" OnClick=\"CopyInfo()\">'); }\n"; } print "</SCRIPT>\n"; } print "</CENTER> <TABLE BORDER=0 WIDTH=\"$table_width\" ALIGN=CENTER> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[4] </FONT> </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"><INPUT TYPE=TEXT SIZE=40 MAXLENGTH=$maxlength_name NAME=name2 VALUE=\"$field10\"></TD> </TR>"; if ( $use_company_name_field ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[90] </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\"> <INPUT TYPE=TEXT SIZE=40 MAXLENGTH=$maxlength_company NAME=company2 VALUE=\"$field11\"> </TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[58] </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"><INPUT TYPE=TEXT SIZE=40 MAXLENGTH=$maxlength_address NAME=address2 VALUE=\"$field12\"></TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[59] </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_city NAME=city2 VALUE=\"$field13\"> </TD> </TR>"; if ( $use_state ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[60] </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\">\n"; if ($state_list) { @state_list = split(/\,/,$state_list); print "<SELECT NAME=state2>\n"; foreach (@state_list) { if ($field14 && ($_ eq "$field14")) { print "<OPTION SELECTED>$_\n"; } else { print "<OPTION>$_\n"; } } print "</SELECT>\n"; } else { print "<INPUT TYPE=TEXT SIZE=$state_length MAXLENGTH=$state_length NAME=state2 VALUE=\"$field14\">\n"; } print "</TD></TR>\n"; } if ( $use_zipcode_fields ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[61] </FONT></TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\">  <INPUT TYPE=TEXT SIZE=10 MAXLENGTH=$maxlength_zip NAME=zip2 VALUE=\"$field15\"> </TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[7] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\">\n"; if ($country_list) { @country_list = split(/\,/,$country_list); print "<SELECT NAME=country2>\n"; foreach (@country_list) { if ($field16 && ($_ eq "$field16")) { print "<OPTION SELECTED>$_\n"; } else { print "<OPTION>$_\n"; } } print "</SELECT>\n"; } else { print "<INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_country NAME=country2 VALUE=\"$field16\">\n"; } print "</TD>\n </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[9] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_phone NAME=phone2 VALUE=\"$field17\"></TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[8] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_email NAME=email2 VALUE=\"$field18\"></TD> </TR>\n"; if ( $reqired_field_prefs =~ /(confirm_email)/i ) { print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[174] </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" ><INPUT TYPE=TEXT SIZE=25 MAXLENGTH=$maxlength_email NAME=confirm_email2 VALUE=\"$field20\"></TD> </TR>\n"; } print "</TABLE>"; } sub print_ship_address3 { &get_shoppers_items; ($trash,$trash,$sales_tax_state,$trash) = split(/\|/,$items[0]); print "<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=\"$table_width\" ALIGN=CENTER > <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[4]&nbsp; </FONT> </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"  FACE=\"$font_face1\">$field1</TD> </TR>"; if ( $use_company_name_field ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[90]&nbsp; </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field2</TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[58]&nbsp; </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"  FACE=\"$font_face1\">$field3</TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[59]&nbsp; </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\"  FACE=\"$font_face1\">$field4</TD> </TR>"; if ( $use_state ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[60]&nbsp; </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field5</TD></TR>\n"; } if ( $use_zipcode_fields ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[61]&nbsp; </FONT></TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field6</TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[7]&nbsp; </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field7</TD>\n </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[9]&nbsp; </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field8</TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[8]&nbsp; </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field9</TD> </TR> </TABLE>"; } sub print_ship_address4 { print "<BR><CENTER> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[104]</FONT> </CENTER><BR>"; &get_shoppers_items; ($trash,$trash,$sales_tax_state,$trash) = split(/\|/,$items[0]); print "<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=\"$table_width\" ALIGN=CENTER > <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[4]&nbsp; </FONT> </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field10</TD> </TR>"; if ( $use_company_name_field ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[90]&nbsp; </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field11</TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[58]&nbsp; </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field12</TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[59]&nbsp; </FONT></TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field13</TD> </TR>"; if ( $use_state ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[60]&nbsp; </FONT> </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field14</TD></TR>\n"; } if ( $use_zipcode_fields ) { print "<TR><TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[61]&nbsp; </FONT></TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field15</TD></TR>"; } print "<TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[7]&nbsp; </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field16</TD>\n </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[9]&nbsp; </TD><TD> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field17</TD> </TR> <TR> <TD ALIGN=RIGHT><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[8]&nbsp; </TD><TD><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$field18</TD> </TR> </TABLE>"; } sub tos_agreement { $lang[177] =~ s/http:\/\/www.YourName\.com\//$path4/g if($path4); print "<CENTER> <TABLE BORDER=0> <TR> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><BR> <INPUT TYPE=checkbox NAME=\"tos_agreement\" style=\"width: 22px; height: 22px; cursor: pointer; vertical-align: middle; position: relative; top: -1.5px;\"> $lang[177]<BR> <BR> </TD> </TR> </TABLE> </CENTER>"; } sub comments { ($cols,$rows,$default_comments) = split(/$delimiter2/,$comments); ($trash,$trash,$trash,$trash,$comments2,$trash) = split(/$delimiter2/,$items[0]); $comments2 =~ s/$br_sub/\n/g; print "<CENTER> <TABLE BORDER=0> <TR> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><BR>$lang[99]<BR> <TEXTAREA NAME=comments ROWS=\"$rows\" COLS=\"$cols\" WRAP>"; if ($comments2 =~ /\n$/ ) { chop($comments2); } if ($comments2) { print "$comments2"; } else { $default_comments =~ s/<BR>/\n/gi; print "$default_comments"; } print "</TEXTAREA> <BR> </TD> </TR> </TABLE> </CENTER>"; } sub comments2 { ($cols,$rows,$default_comments) = split(/$delimiter2/,$comments); ($trash,$trash,$trash,$trash,$comments2,$trash) = split(/$delimiter2/,$items[0]); $comments2 =~ s/$br_sub/\n/g; print "<CENTER> <TABLE BORDER=0> <TR> <TD ALIGN=CENTER><FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\"><BR>"; if ($comments2 =~ /\n$/ ) { chop($comments2); } $comments2 =~ s/\n/<BR>/g; if ($comments2) { print "$comments2"; } else { $default_comments =~ s/<BR>/\n/gi; print "$default_comments"; } print " </TD> </TR> </TABLE> </CENTER>"; } sub send_email { if ( $symbol eq "&pound;" ) { $symbol = "ï¿½"; } if ( $symbol eq "&nbsp;" ) { $symbol = " "; } &get_shoppers_items; if ( $append_datafile && ($append_datafile !~ /(off)$/i) ) { &send_email2('do_appending'); } foreach $myemail (@myemail) { &send_email2('merchant'); } if ( $customer_mail ) { &send_email2('customer'); } } sub send_email2 { $multiple_password_counter = 0; $customer_name =~ s/\,//g; $bizname =~ s/\,//g; $bizname =~ s/<([^>]|\n)*>//g; $subject_no_html = "$purchase_method"; $subject_no_html =~ s/<([^>]|\n)*>//g; $payable = remove_html_tags_for_email($payable); $add1 = remove_html_tags_for_email($add1); $add2 = remove_html_tags_for_email($add2); $add3 = remove_html_tags_for_email($add3); $lang[10] = remove_html_tags_for_email($lang[10]); $lang[11] = remove_html_tags_for_email($lang[11]); $lang[30] = remove_html_tags_for_email($lang[30]); $instant_trans = remove_html_tags_for_email($instant_trans); chop($items[0]) if ( $items[0] =~ /\n/ ); ($date,$invoice,$state,$ship_method,$comments2,$coupon_amount,$coupon_number) = split(/$delimiter2/, $items[0]); if ( $items[1] =~ /(\n)$/ ) { chop($items[1]); } @ship_lines = split(/$delimiter2/, $items[1]); while ( @ship_lines > 18 ) { pop(@ship_lines); } while ( $ship_lines[@ship_lines-1] eq "" ) { pop(@ship_lines); } foreach $line (@ship_lines) { if ( $line eq "." ) { $line .= " "; } } if ( $_[0] eq "customer" ) { $myemail = $myemail[0]; } if ( ($purchase_method eq "$lang[97]") || ($purchase_method eq "$lang[1]") ) { $customer_name = "$ship_lines[0]"; $customer_email = "$ship_lines[8]"; } else { $customer_name = "$ship_lines[9]"; $customer_email = "$ship_lines[17]"; } $customer_name =~ s/\,/ /g; if ( $customer_email =~ /(\n)$/ ) { chop($customer_email); } if (  ( $_[0] eq "merchant" ) && ( $myemail =~ /(jfaxsend\.com)/i || $myemail =~ /(maxemail\.com)/i || $myemail =~ /(faxaway\.com)/i || $myemail =~ /(fax2me\.com)/i ) ) { $customer_email = "$myemail[0]"; } $passwords="$vars"; $a=""; until ($a eq "/" || $passwords eq "") { $a=chop($passwords); } $passwords .= "/passwords.dat"; $htpasswd_exception="$vars"; $a=""; until ($a eq "/" || $htpasswd_exception eq "") { $a=chop($htpasswd_exception); } if ( (-e "$passwords") && (!@passwords) ) { open (PASSWORDS, "$passwords"); if ($flock) { flock(PASSWORDS, 2); } @passwords = <PASSWORDS>; if ($flock) { flock(PASSWORDS, 8); } close (PASSWORDS); } if ( ( ($_[0] eq "merchant") || ($_[0] eq "do_appending") ) && (@items > 1) ) { if ( $append_datafile && ( $_[0] eq "do_appending" ) ) { if ( $append_datafile =~ /(.+)(\s)(.+)/ ) { $append_datafile = $3; } if ( $append_datafile =~ /(.+)(\|)(.+)/ ) { $append_datafile = $3; } if (-d "$append_datafile") { $invoice =~ s/ //g; $append_datafile = "$append_datafile/orders$invoice" . "$ext"; } $append_datafile = &untaint("$append_datafile"); open (MAIL, ">>$append_datafile"); print MAIL "\n\nDate: $date\n"; } elsif ( $blat || $windmail || $socket_smtp_server ) { $untainted = &untaint("$path1/$shopper_id$mail_ext$ext"); open (MAIL, ">$untainted"); } elsif ( $mailprog ) { while($myemail =~ / /) { chop($myemail); } if ($myemail !~ /^(.+)(\@)(.+)(\.)(.+)$/) { $myemail = ""; } if ( $mailprog eq "windmail -t" ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $mailprog =~ /(cgimail)$/ ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $mailprog =~ /(-t)/ ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $no_f_switch ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } else { open (MAIL, "|$mailprog $myemail"); $sendmail_command = "open (MAIL, \"|$mailprog $myemail\");"; } } } if ( $_[0] eq "customer" ) { if ( $customer_email =~ /(.*)(\@)(.*)(\.)(.*)/ && $mailprog  ) { if ( $blat || $windmail || $socket_smtp_server ) { $untainted = &untaint("$path1/$shopper_id$mail_ext$ext"); open (MAIL, ">$untainted"); } else { while($customer_email =~ / /) { chop($customer_email); } if ( $mailprog eq "windmail -t" ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $mailprog =~ /(cgimail)$/ ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $mailprog =~ /(-f)/ ) { open (MAIL, "|$mailprog $customer_email"); $sendmail_command = "open (MAIL, \"|$mailprog $customer_email\");"; } elsif ( $mailprog =~ /(-t)/ ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $no_f_switch ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } else { open (MAIL, "|$mailprog -f $myemail $myemail"); $sendmail_command = "open (MAIL, \"|$mailprog -f $myemail $myemail\");"; } } } } if ($email_content_type && !$blat && !$socket_smtp_server) { print MAIL "Content-Type: $email_content_type\n"; } if ($email_encoding && !$blat && !$socket_smtp_server) { print MAIL "Content-Transfer-Encoding: $email_encoding\n"; } if ( (!$blat && !$windmail && !$socket_smtp_server && ($mailprog ne "windmail -t") && ( $mailprog !~ /(cgimail)$/ ) ) || ( ( $_[0] eq "do_appending") && $append_datafile) )  { print MAIL "Return-Path: $myemail\n"; if ( $_[0] eq "customer" ) { if ( $email_content_type =~ /(x\-sjis)/i ) { print MAIL "To: $customer_email\n"; print MAIL "From: $myemail\n"; print MAIL "$lang[62] $bizname\n\n"; $to_log = "$customer_email"; $from_log = "$myemail"; $subject_log = "$bizname"; } else { print MAIL "To: $customer_name <$customer_email>\n"; print MAIL "From: $bizname <$myemail>\n"; print MAIL "$lang[62] $invoice - $subject_no_html\n\n"; $to_log = "$customer_name <$customer_email>"; $from_log = "$bizname <$myemail>"; $subject_log = "$invoice - $subject_no_html"; } } else { if ( $email_content_type =~ /(x\-sjis)/i ) { print MAIL "To: $myemail\n"; print MAIL "From: $customer_email\n"; print MAIL "$lang[62] $invoice\n\n"; $to_log = "$myemail"; $from_log = "$customer_email"; $subject_log = "$invoice"; } else { print MAIL "To: $bizname <$myemail>\n"; print MAIL "From: $customer_name <$customer_email>\n"; print MAIL "$lang[62] $invoice - $subject_no_html\n\n"; $to_log = "$bizname <$myemail>"; $from_log = "$customer_name <$customer_email>"; $subject_log = "$invoice - $subject_no_html"; } } } if ( ( ($windmail) || ($mailprog eq "windmail -t") || ( $mailprog =~ /(cgimail)$/ ) ) && ($_[0] ne "do_appending") ) { if ( $_[0] eq "customer" ) { print MAIL "To: $customer_email\n"; print MAIL "From: $myemail\n"; $to_log = "$customer_email"; $from_log = "$myemail ($bizname)"; if ( $email_content_type =~ /(x\-sjis)/i ) { print MAIL "$lang[62] $bizname\n\n"; $subject_log = "$bizname"; } else { print MAIL "$lang[62] $invoice - $subject_no_html\n\n"; $subject_log = "$invoice - $subject_no_html"; } } else { print MAIL "To: $myemail\n"; print MAIL "From: $myemail\n"; print MAIL "Reply-To: $customer_email\n"; $to_log = "$myemail"; $from_log = "$myemail, Reply-To: $customer_email"; if ( $email_content_type =~ /(x\-sjis)/i ) { print MAIL "$lang[62] $invoice\n\n"; $subject_log = "$invoice"; } else { print MAIL "$lang[62] $invoice - $subject_no_html\n\n"; $subject_log = "$invoice - $subject_no_html"; } } } $thank_you_for_your_order = $lang[110]; if ( ($append_datafile && ($_[0] eq "do_appending") ) )  { $html_br = ""; } if ( ($email_content_type =~ /^(text\/html)/i) && ($_[0] ne "do_appending") ) { $html_br = "<BR>"; } else { $thank_you_for_your_order =~ s/<BR>/\n/gi; } if ( $_[0] eq "customer" ) { print MAIL "$lang[109] $customer_name$html_br\n$thank_you_for_your_order$html_br\n$html_br\n"; } $temp = $lang[152]; $safe_code = "if ($purchase_method =~ /$temp/ && $lang[152] ) { print MAIL \"$lang[153]$html_br\n\"; }"; eval($safe_code); if (!$@) { if ($purchase_method =~ /$temp/ && $lang[152] ) { print MAIL "$lang[153]$html_br\n"; } } if ($purchase_method eq "$lang[14]" || $purchase_method eq "$lang[154]" || $purchase_method eq "$lang[165]") { print MAIL "$instant_trans$html_br\n"; } if ($purchase_method eq "$lang[25]") { print MAIL "$lang[64]$html_br\n$lang[65]$html_br\n" if ( $_[0] eq "merchant" ); print MAIL "$lang[31]$html_br\n$add4$html_br\n" if ( $_[0] eq "customer" ); } if ($purchase_method eq "$lang[71]") { print MAIL "$lang[71]$html_br\n" if ( $_[0] eq "merchant" ); print MAIL "$lang[28]$html_br\n" if ( $_[0] eq "customer" ); } if ($purchase_method eq "$lang[97]") { $br_temp = "$lang[98]"; print MAIL "$br_temp$html_br\n" if ( $_[0] eq "merchant" ); print MAIL "$br_temp$html_br\n" if ( $_[0] eq "customer" ); } print MAIL "_______________________________________$html_br\n"; print MAIL "$lang[53] $invoice$html_br\n"; print MAIL "$lang[52] $date$html_br\n"; print MAIL "$lang[66] $ENV{'REMOTE_HOST'}$html_br\n" if ( $_[0] ne "customer" ); print MAIL "$lang[67] $ENV{'REMOTE_ADDR'}$html_br\n" if ( $_[0] ne "customer" ); print MAIL "$lang[85] $ENV{'HTTP_USER_AGENT'}$html_br\n" if ( $_[0] ne "customer" ); print MAIL "_______________________________________$html_br\n$html_br\n"; $total = 0; $nontaxable = 0; $noshipping = 0; $nodiscount = 0; $nodiscount_items = 0; $ship_total = 0; $n = 0; if ($email_receipt_tables) { printf MAIL "$lang[156]$html_br\n"; $table_line_length = $email_receipt_tables[0] + $email_receipt_tables[1] + $email_receipt_tables[2] + $email_receipt_tables[3] + $email_receipt_tables[4] + 12; $item_separator = ""; if (!$lang[157]) { $lang[157] = " - -"; } while ( length($item_separator) < $table_line_length ) { $item_separator .= "$lang[157]"; } while ( length($item_separator) > $table_line_length ) { chop($item_separator); } print MAIL "$item_separator$html_br\n"; foreach $item (@items) { if ( ( $n == 0 ) || ( $n == 1 ) ) { $n++; next; } if ( $item =~ /\n$/ ) { chop($item); } @stuff = split(/$delimiter2/,$item); @customs = (@stuff); for($i=1;$i<=5;$i++) { shift(@customs); } $quantity = $stuff[4]; $price_calc = $stuff[1]; &price_calc; $item_total = $each * $stuff[4]; if ($item =~ /\#non.*taxable\#/i) { $nontaxable += $item_total; } if ($item =~ /\#noshipping\#/i) { $noshipping += $item_total; } if ($item =~ /\#nodiscount\#/i) { $nodiscount += $item_total; $nodiscount_items += $stuff[4]; } $total += $item_total; $ship_total += $stuff[2] * $stuff[4]; $item_ship_total = $stuff[2] * $stuff[4]; $print_inst = ""; $custom_col = ""; for ( $i=5;$i<=($customs+4);$i++ ) { if ( $stuff[$i] ) { if ( $stuff[$i] =~ /\n$/ ) { chop($stuff[$i]); } $stuff[$i] =~ s/<([^>]|\n)*>//g unless($email_content_type =~ /^(text\/html)/); $stuff[$i] =~ s/$br_sub/$html_br\n/g; $custom_col .= "$stuff[$i]$html_br\n" unless ( (($suppress_desc == 1 || $suppress_desc == 2) && $_[0] eq "merchant") || ($stuff[$i] =~ /\#non.*taxable\#/i) || ($stuff[$i] =~ /\#noshipping\#/i || $stuff[$i] =~ /\#nodiscount\#/i) ); if ( ($purchase_method eq "$lang[14]") || ( $purchase_method eq "$lang[154]" ) || (( $purchase_method eq "$lang[71]" ) && ( ($option4 !~ /^(http)/i) || $allow_passwords_with_ssl_pl_check_draft ) ) ) { foreach $line (@passwords) { if ( $line =~ /\n$/ ) { chop($line); } ($keyword,@instructions) = split(/$delimiter2/,$line); if ( $instructions[0] =~ /^(\/)(.*)(\.htpasswd)$/ || $instructions[0] =~ /^(\w\:)(.*)(\.htpasswd)$/ || $instructions[0] =~ /^(\/)(.*)(passwd)$/ ) { $htpasswd = shift(@instructions); } $htpasswd_days = ""; if ( $instructions[0] =~ /^(Expires:)(\s{0,1})(\d+)$/i ) { $htpasswd_days = "$3"; $trash = shift(@instructions); } $instructions = join("\n",@instructions); if ( $stuff[$i] eq "$keyword" ) { if ( !$pw || $all_different_passwords) { if (!$sent_first_email) { $pw = ""; while ( length($pw) < 8 ) { $random = int(rand(255)); $random = chr($random); if ( ( $random =~ /\d/ || $random =~ /\w/ ) && ( $random !~ /[\_|O|o|0|l|1|I]/ ) ) { $pw .= "$random"; } } push(@pw,"$pw"); } else { $pw = $pw[$multiple_password_counter]; $multiple_password_counter++; } $crypt_pw = crypt($pw,"aa"); } $instructions =~ s/\#random_password\#/$pw/i; if ( $_[0] eq "customer" ) { if ( ( -e "$htpasswd" ) && ( $allow_htpasswd_write ) && ( ( $htpasswd =~ /^($htpasswd_exception)/ ) || ( ( $FORM{'merchant'} && !$merchant_security ) || ( !$FORM{'merchant'} && $merchant_security ) || ( !$FORM{'merchant'} && !$merchant_security ) ) ) ) { &add_email_and_password_to_htpasswd_file; } } $instructions =~ s/$delimiter2/\n/g; $print_inst .= "$instructions"; } } } } } $custom_col .= "$lang[37] ($wt) \ $item_ship_total$html_br\n" if ( ($ship_allow == 1) && ($show_ship) ); if ($print_inst) { $custom_col .= "$print_inst$html_br\n"; } $each = sprintf("$decimals","$each"); $item_total = sprintf("$decimals","$item_total"); $each =~ s/ //g; $item_total =~ s/ //g; $each = "$symbol $each"; $item_total = "$symbol $item_total"; if (!$email_receipt_tables[0]) { $first_item_name_line = ""; } else { $item_name_lines = &wrap($stuff[0],$email_receipt_tables[0]); ($first_item_name_line,@item_name_lines) = split(/\n/,"$item_name_lines"); } if (!$email_receipt_tables[1]) { $first_custom_line = ""; } else { $custom_col = &wrap($custom_col,$email_receipt_tables[1]); ($first_custom_line,@custom_col) = split(/\n/,"$custom_col"); } if (!$email_receipt_tables[2]) { $stuff[4] = ""; } if (!$email_receipt_tables[3]) { $each = ""; } if (!$email_receipt_tables[4]) { $item_total = ""; } printf MAIL "%-$email_receipt_tables[0]s %1s %-$email_receipt_tables[1]s %1s %$email_receipt_tables[2]s %1s %$email_receipt_tables[3]s %1s %$email_receipt_tables[4]s$html_br\n", "$first_item_name_line", "", "$first_custom_line", "", "$stuff[4]", "", "$each", "", "$item_total"; until (!@item_name_lines && !@custom_col) { if (!$email_receipt_tables[0]) { $item_name_lines[0] = ""; } if (!$email_receipt_tables[1]) { $custom_col[0] = ""; } printf MAIL "%-$email_receipt_tables[0]s %1s %-$email_receipt_tables[1]s$html_br\n", "$item_name_lines[0]", "", "$custom_col[0]"; shift (@item_name_lines); shift (@custom_col); } print MAIL "$item_separator$html_br\n"; $n++; } } else { foreach $item (@items) { if ( ( $n == 0 ) || ( $n == 1 ) ) { $n++; next; } if ( $item =~ /\n$/ ) { chop($item); } @stuff = split(/$delimiter2/,$item); @customs = (@stuff); for($i=1;$i<=5;$i++) { shift(@customs); } $quantity = $stuff[4]; $price_calc = $stuff[1]; &price_calc; $item_total = $each * $stuff[4]; if ($item =~ /\#non.*taxable\#/i) { $nontaxable += $item_total; } if ($item =~ /\#noshipping\#/i) { $noshipping += $item_total; } if ($item =~ /\#nodiscount\#/i) { $nodiscount += $item_total; $nodiscount_items += $stuff[4]; } $total += $item_total; $ship_total += $stuff[2] * $stuff[4]; $item_ship_total = $stuff[2] * $stuff[4]; print MAIL "$stuff[0]$html_br\n"; print MAIL "$lang[34] $stuff[4]$html_br\n"; print MAIL "$lang[55] " unless (($suppress_desc == 1 || $suppress_desc == 2) && $_[0] eq "merchant"); $print_inst = ""; $any_custom_descriptions = 0; $first_custom_description = 0; for ( $i=5;$i<=($customs+4);$i++ ) { if ( $stuff[$i] ) { $any_custom_descriptions = 1; if ( $stuff[$i] =~ /\n$/ ) { chop($stuff[$i]); } $stuff[$i] =~ s/<([^>]|\n)*>//g unless($email_content_type =~ /^(text\/html)/); $stuff[$i] =~ s/$br_sub/$html_br\n         /g; if ( !$first_custom_description ) { print MAIL "$stuff[$i]$html_br\n" unless ( (($suppress_desc == 1 || $suppress_desc == 2) && $_[0] eq "merchant") || ( $stuff[$i] =~ /\#non.*taxable\#/i || $stuff[$i] =~ /\#noshipping\#/i || $stuff[$i] =~ /\#nodiscount\#/i ) ); $first_custom_description = 1; } else { printf MAIL "%-8s %-50s$html_br\n", "", "$stuff[$i]" unless ( (($suppress_desc == 1 || $suppress_desc == 2) && $_[0] eq "merchant") || ($stuff[$i] =~ /\#non.*taxable\#/i || $stuff[$i] =~ /\#noshipping\#/i || $stuff[$i] =~ /\#nodiscount\#/i) ); } if ( ($purchase_method eq "$lang[14]") || ( $purchase_method eq "$lang[154]" ) || (( $purchase_method eq "$lang[71]" ) && ( ($option4 !~ /^(http)/i) || $allow_passwords_with_ssl_pl_check_draft ) ) ) { foreach $line (@passwords) { if ( $line =~ /\n$/ ) { chop($line); } ($keyword,@instructions) = split(/$delimiter2/,$line); if ( $instructions[0] =~ /^(\/)(.*)(\.htpasswd)$/ || $instructions[0] =~ /^(\w\:)(.*)(\.htpasswd)$/ || $instructions[0] =~ /^(\/)(.*)(passwd)$/ ) { $htpasswd = shift(@instructions); } $htpasswd_days = ""; if ( $instructions[0] =~ /^(Expires:)(\s{0,1})(\d+)$/i ) { $htpasswd_days = "$3"; $trash = shift(@instructions); } $instructions = join("\n",@instructions); if ( $stuff[$i] eq "$keyword" ) { if ( !$pw || $all_different_passwords) { if (!$sent_first_email) { $pw = ""; while ( length($pw) < 8 ) { $random = int(rand(255)); $random = chr($random); if ( ( $random =~ /\d/ || $random =~ /\w/ ) && ( $random !~ /[\_|O|o|0|l|1|I]/ ) ) { $pw .= "$random"; } } push(@pw,"$pw"); } else { $pw = $pw[$multiple_password_counter]; $multiple_password_counter++; } $crypt_pw = crypt($pw,"aa"); } $instructions =~ s/\#random_password\#/$pw/i; if ( $_[0] eq "customer" ) { if ( ( -e "$htpasswd" ) && ( $allow_htpasswd_write ) && ( ( $htpasswd =~ /^($htpasswd_exception)/ ) || ( ( $FORM{'merchant'} && !$merchant_security ) || ( !$FORM{'merchant'} && $merchant_security ) || ( !$FORM{'merchant'} && !$merchant_security ) ) ) ) { &add_email_and_password_to_htpasswd_file; } } $instructions =~ s/$delimiter2/\n/g; $print_inst .= "$html_br\n$instructions"; } } } } } if ( !$any_custom_descriptions ) {print MAIL "$html_br\n"; } printf MAIL "%-15s %3s $decimals$html_br\n", "$lang[36]", "$symbol", $each; printf MAIL "%-15s %3s $decimals$html_br\n", "$lang[37] ($wt)", "\ ", $item_ship_total if ( ($ship_allow == 1) && ($show_ship) ); printf MAIL "%-15s %3s $decimals$html_br\n", "$lang[39]", "$symbol", $item_total; print MAIL "$html_br\n"; if ($print_inst) { print MAIL "$print_inst$html_br\n"; } print MAIL "_______________________________________$html_br\n$html_br\n"; $n++; } } $currency_sep_total = $total; &currency_sep; $total_string_length = length($currency_sep_total); $total_format = '%' . "$total_string_length" . 's'; if ( $coupon_amount ) { &coupon_amount; $temp = sprintf("$decimals",$temp); $temp =~ s/ //g; $lang[116] = remove_html_tags_for_email("$lang[116]"); printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[116] ($coupon_number / $coupon_amount)", "- $symbol", $temp; } if (!$lang[70]) { $lang[70] = "$lang[43]"; } $currency_sep_total = $total; &currency_sep; $total_string_length = length($currency_sep_total); $total_format = '%' . "$total_string_length" . 's'; printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[70]", "$symbol", "$currency_sep_total"; &webstore_discount; if ( $discount_amount ) { $total -= $discount_amount; if ( $nontaxable ) { $nontaxable -= $discount_amount; } $discount_amount = sprintf("$decimals",$discount_amount); $discount_amount =~ s/ //g; $lang[108] = remove_html_tags_for_email("$lang[108]"); printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[108] ($disc_percent\%)", "- $symbol", $discount_amount; $currency_sep_total = $total; &currency_sep; $total_string_length = length($currency_sep_total); $total_format = '%' . "$total_string_length" . 's'; printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[70]", "$symbol", "$currency_sep_total"; } if ( $ship_allow ) { $ship_weight_total = "$ship_total"; &ship_calc; $ship_total = sprintf("$decimals",$ship_total); $ship_total =~ s/ //g; if ( $shipping_weight_total == 1 && $ship_allow == 1 ) { $shipping_weight_temp = " $ship_weight_total $wt"; } else { $shipping_weight_temp = ""; } printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[56]$shipping_weight_temp ($ship_method)", "$symbol", $ship_total; } else { $ship_total = 0; } if ( $state ) { &get_sales_tax; $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; if ( $tax_allow == 1 || $tax_allow == 2 ) { $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; } if ( $tax_allow == 3 || $tax_allow == 4 ) { $taxes = ($total - $nontaxable + $ship_total) * $tax_rate; $taxes /= 100; } else { $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; } $taxes =~ /(.*)(\.)(\d)(\d)(\d)/; if ( $5 >= 5 ) { $taxes += .005; } $taxes2 = sprintf("$decimals",$taxes); $taxes2 =~ s/ //g; printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[44] ($state) $tax_rate\%", "$symbol", $taxes2; } if ( ($FORM{'purpose2'} eq "cod") && ($option5 ne "0.00") ) { printf MAIL "%-45s %3s $total_format$html_br\n", "$lang[102]", "$symbol", $option5; $total += $option5; } $total += $taxes2 if ( $state ); $total += $ship_total if ( $ship_allow ); $bug_flag = 1; $currency_sep_total = $total; &currency_sep; if ( $purchase_method eq "$lang[14]" || $purchase_method eq "$lang[154]" || $purchase_method eq "$lang[165]" || ($purchase_method eq "$lang[71]" && $option4 !~ /^(http)/i) ) { printf MAIL "%-45s %3s $total_format %-4s$html_br\n", "$lang[57]", "$symbol", $currency_sep_total, "$lang[68]"; } else { printf MAIL "%-45s %3s $total_format %-4s$html_br\n", "$lang[57]", "$symbol", $currency_sep_total, "$lang[69]"; } print MAIL "$html_br\n"; unless ( $suppress_address_in_customer_email_receipt && $_[0] eq "customer" ) { $temp = "$lang[30]"; if ( ($append_datafile && ($_[0] eq "do_appending") ) )  { $temp =~ s/<([^>]|\n)*>//g; } print MAIL "_______________________________________$html_br\n$temp$html_br\n$html_br\n"; $n = 0; foreach $line (@ship_lines) { if ( $n == 9 && !$billing_address_only_for_credit_cards ) { $temp = "$lang[104]"; $temp =~ s/<([^>]|\n)*>//g; print MAIL "_______________________________________$html_br\n$temp$html_br\n$html_br\n"; } if ( ($n < 9) || ($n > 8 && $n < 18 && !$billing_address_only_for_credit_cards) ) { if ($line) { print MAIL "$line"; if ($n != 3 && $n != 4 && $n != 12 && $n != 13) { print MAIL "$html_br\n"; } else { print MAIL " "; } } } $n++; } print MAIL "_______________________________________$html_br\n"; } if ($comments2) { $comments2 =~ s/$br_sub/$html_br\n/g; print MAIL "$html_br\n$comments2$html_br\n"; print MAIL "_______________________________________$html_br\n"; } if ( $require_tos_agreement == 2 ) { $lang[178] =~ s/http:\/\/www.YourName\.com\//$path4/g if($path4); $lang[178] =~ s/\|/$html_br\n/g; print MAIL "$html_br\n$lang[178]$html_br\n"; print MAIL "_______________________________________$html_br\n"; } if ( $purchase_method eq "$lang[1]" && ($_[0] ne "do_appending") ) { print MAIL "$html_br\n$lang[10]"; print MAIL " \"$payable\"$html_br\n" if ($payable); print MAIL "$html_br\n"; print MAIL "$lang[11]$html_br\n"; print MAIL "$add1$html_br\n"; print MAIL "$add2$html_br\n"; print MAIL "$add3$html_br\n"; } if ( $purchase_method eq "$option6" && ($_[0] ne "do_appending") ) { if ($email_content_type !~ /^(text\/html)/i) { $lang[83] =~ s/\<br\>/\n/gi; } print MAIL "$html_br\n$lang[83]$html_br\n"; } if ( ($append_datafile && ($_[0] eq "do_appending") ) )  { print MAIL "\n################################################\n\n"; } if ( (($_[0] eq "customer") || ($_[0] eq "merchant")) && $signature ) { print MAIL "$html_br\n"; @signature = split(/$delimiter2/,$signature); foreach $line (@signature) { print MAIL "$line$html_br\n"; } } if ( $mailprog eq "windmail -t" ) { print MAIL ".\n"; } close (MAIL); if ( $append_datafile && ( $_[0] eq "do_appending" ) ) { if (!$ENV{'OS'}) { `chmod 777 $append_datafile`; } } if ( ($blat || $windmail || $socket_smtp_server) && ($_[0] ne "do_appending") ) { $temp_path = &untaint("$path1/$shopper_id$mail_ext$ext"); $mailprog2 = &untaint("$mailprog"); $customer_email = &untaint("$customer_email"); $subject = &untaint("$subject_no_html"); $myemail2 = &untaint("$myemail"); if ($windmail) { system($mailprog2,"-t -t -n $temp_path"); $sendmail_command = "system($mailprog2,\"-t -t -n $temp_path\");"; } if ($blat) { if ( $_[0] eq "customer" ) { open(MAIL2,"|$mailprog2 \"$temp_path\" -t $customer_email -s \"$bizname - $subject\" -f $myemail2$blat_server -q");  close(MAIL2); $sendmail_command = "open(MAIL2,\"|$mailprog2 \"$temp_path\" -t $customer_email -s \"$bizname - $subject\" -f $myemail2$blat_server -q\");"; } else { open(MAIL2,"|$mailprog2 \"$temp_path\" -t $myemail2 -s \"$invoice - $subject\" -f $customer_email$blat_server -q"); close(MAIL2); $sendmail_command = "open(MAIL2,\"|$mailprog2 \"$temp_path\" -t $myemail2 -s \"$invoice - $subject\" -f $customer_email$blat_server -q\");"; } } if ( $socket_smtp_server ) { open(BODY,"$temp_path"); @socket_body=<BODY>; close(BODY); $socket_body = join("",@socket_body); if ( $_[0] eq "customer" ) { $socket_subject = "$bizname - $subject"; $socket_email_output = &socket_email($customer_email,$myemail2,$socket_subject,$socket_body,$socket_smtp_server,$email_content_type,$email_encoding); } else { $socket_subject = "$invoice - $subject"; $socket_email_output = &socket_email($myemail2,$customer_email,$socket_subject,$socket_body,$socket_smtp_server,$email_content_type,$email_encoding); } $sendmail_command = "socket|$socket_smtp_server|$socket_return_path"; } if ( $_[0] eq "customer" || (!$customer_mail) ) { unlink("$temp_path"); } } $sent_first_email = 1; if (-e "$email_log" && $mailprog && $_[0] ne "do_appending" ) { open(LOG,">>$email_log"); print LOG "Date: $date\n"; print LOG "The cart has sent email to the server's sendmail program using the following command:\n"; print LOG "$sendmail_command\n"; print LOG "To: $to_log\n"; print LOG "From: $from_log\n"; print LOG "Subject: $subject_log\n\n"; close(LOG); } } sub remove_html_tags_for_email { if ($email_content_type !~ /^(text\/html)/i) { $_[0] =~ s/\<br\>/\n/gi; $_[0] =~ s/<([^>]|\n)*>//g; } return $_[0]; } sub check_tax { &get_shoppers_items; $matched_a_shipping_type_in_pv29 = 0; foreach $type (@method) { if ( $FORM{'ship_method'} eq $type ) { $matched_a_shipping_type_in_pv29 = 1; } } if (!$matched_a_shipping_type_in_pv29 && $ship_allow == 1) { &list_items; exit; } chop($items[0]); if ( $tax_allow == 2 || $tax_allow == 4 ) { $FORM{'tax'} = "$state[0]"; } @info = split(/$delimiter2/, $items[0]); $items[0] = "$info[0]$delimiter$info[1]$delimiter$FORM{'tax'}$delimiter$FORM{'ship_method'}$delimiter$info[4]$delimiter$info[5]$delimiter$info[6]\n"; $untainted = &untaint("$path1/$shopper_id$ext"); open(CART,">$untainted"); foreach $item (@items) { print CART "$item"; } close CART; } sub print_button { if ( $lang[13] ) { print "<CENTER>"; if (!$force_no_script) { print "<SCRIPT language=\"JavaScript\">\n <!--\n var bn=navigator.appName;\n var vn=navigator.appVersion;\n if ( (bn==\"Netscape\") && (parseInt(vn) >= 4) )\n {\n document.write('<FORM><INPUT TYPE=BUTTON OnClick=\"window.print()\" VALUE=\"$lang[13]\"></FORM>');\n }\n else\n {\n document.write('<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[13]</FONT>');\n }\n // -->\n </SCRIPT>\n"; } if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[13]</FONT>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } print "</CENTER>"; } } sub price_calc { &symbol2; if ( !$quantity ) { $quantity = 1; } if ( $price_calc =~ /$discount_sep/ ) { (@discount_prices) = split(/$discount_sep/,$price_calc); $nt_discount_prices_temp = @discount_prices; for($dp=0;$dp<=$nt_discount_prices_temp-1;$dp+=2) { if ( $quantity >= $discount_prices[$dp+1] ) { $price_calc = $discount_prices[$dp]; } } } if ( $price_calc =~ /(.*)($symbol2)(.+)(\W*.*)/ ) { $price_calc = $3; } if ($custom_description_currency_symbol_feature) { $nt_customs_temp = @customs; for($i=0;$i<=$nt_customs_temp;$i++) { if ( ($customs[$i] =~ /(.*)($symbol2)(.+)(\W*.*)/ ) && !($customs[$i] =~ /(.*)(\+$symbol2)(.+)/) ) { $price_calc = $3; last; } } } $nt_customs_temp = @customs; for($i=0;$i<=$nt_customs_temp;$i++) { if ( ($customs[$i] =~ /(.*)(\+$symbol2)(.+)(\W*.*)/ ) ) { $price_calc += $3; } } $each = sprintf("$decimals",$price_calc); } sub database { &symbol2; ($trash,$file,$cat,$item_start,$trash,$cat_or_search) =    split(/$query_separator/,$ENV{'QUERY_STRING'}); $cat =~ s/\%20/ /g; if ( !$item_cat_pos ) { $cat_or_search = "search"; } if ( $FORM{'should_be_get_method'} ) { $ENV{'REQUEST_METHOD'} = "get"; } if ( !$ENV{'QUERY_STRING'} ) { $query_separator2 = $query_separator; $query_separator2 =~ s/^\\//; $temp = "search"; $ENV{'QUERY_STRING'} = "db$query_separator2$FORM{'file'}$query_separator2$FORM{'search'}$query_separator2$query_separator2$query_separator2$temp"; } $ENV{'QUERY_STRING'} =~ s/ /\%20/g; if ( $ENV{'REQUEST_METHOD'} =~ /POST/i ) { $cat_or_search = "search"; $file = "$FORM{'file'}"; $cat = "$FORM{'search'}"; if ( $FORM{'merchant'} ) { $ENV{'QUERY_STRING'} .= "$query_separator2$FORM{'merchant'}"; } } if ( $cat =~ /^(All Items)$/i ) { $item_cat_pos = 0; } if ( $cat =~ /^(All_Items)$/i ) { $item_cat_pos = 0; } if (!$item_start) { $item_start = 1; } if (!$cat_or_search) { $cat_or_search = "cat"; } $file =~ s/\.\.\///g; $file =~ s/\.\.//g; $file =~ s/(\/etc\/passwd)//g; open (FILE,"$database_dir/$file"); @items = <FILE>; close (FILE); $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $cat</TITLE>\n$meta_tag\n</HEAD>\n <BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\"> <CENTER>\n"; if ( $diagnostics ) { $temp = ""; foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $temp .= "$name = $value<BR>"; } print "REQUEST_METHOD: $ENV{'REQUEST_METHOD'}<BR>QUERY_STRING: $ENV{'QUERY_STRING'}<BR>POST:<BR>$temp<BR>"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n compat = false;\n if( parseInt( navigator.appVersion ) >= $compat )\n {\n compat = true;\n }\n compat = true;\n </SCRIPT>\n"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n //if( (navigator.appVersion.search(/Mac/i)>=0) && (navigator.appName==\"Netscape\") )\n if( navigator.appVersion.search(/Mac/i)>=0 )\n { compat = false; }\n compat = true;\n function Commas(intnum)\n {\n intstr = \"\"+intnum;\n inserts = parseInt(intstr.length)/3;\n sep = \"$currency_sep\"\n for(i=1;i<=inserts;i++)\n {\n if (intnum >= Math.pow(1000,i))\n {\n intlen = intstr.length\n temp1=parseInt(\"\"+(intnum/Math.pow(1000,i)))\n temp2=intstr.substring(intlen-((i*4)-1),intlen)\n intstr = temp1+sep+temp2\n }\n }\n whole = intstr\n }\n function Total(X)\n {\n if(compat)\n {\n if (document.forms[X].quantity)\n {\n if ( document.forms[X].quantity.value < 1 ) { document.forms[X].quantity.value = 1; }\n if ( isNaN(document.forms[X].quantity.value) ) { document.forms[X].quantity.value = 1; }\n"; if (!$fix_int_quantity) { print "document.forms[X].quantity.value = parseInt(document.forms[X].quantity.value);\n"; } print "}\n if ( document.forms[X].price.value.match(/$discount_sep/) )\n {\n Prices = document.forms[X].price.value.split(\"$discount_sep\");\n for(dp=0;dp<=Prices.length-1;dp+=2)\n {\n if ( document.forms[X].quantity && document.forms[X].quantity.value >= Number(Prices[dp+1]) ) { document.forms[X].add.value = Prices[dp]; }\n if ( !document.forms[X].quantity && Number(Prices[dp+1]) == 1 ) { document.forms[X].add.value = Prices[dp]; }\n }\n }\n else { document.forms[X].add.value = document.forms[X].price.value }\n document.forms[X].add.value.match(/(\\$symbol)?(.*)/)\n document.forms[X].add.value = Number(RegExp.\$2)\n Price = Number(RegExp.\$2)\n for (i = 0 ; i < document.forms[X].elements.length ; i++)\n {\n if ( document.forms[X].elements[i].name.match(/custom/) && document.forms[X].elements[i].type != \"hidden\" )\n {\n if ( document.forms[X].elements[i].type == \"checkbox\" && document.forms[X].elements[i].checked )\n { A = document.forms[X].elements[i].value;\n A.match(/^.*\\+?\\$symbol(.+\$)/)\n B = RegExp.\$1\n                 if ( A.match(/\\+\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) + Number(B);\n }\n if ( A.match(/[^+]\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) - Number(Price) + Number(B);\n }\n }\n if ( document.forms[X].elements[i].type == \"select-one\" || document.forms[X].elements[i].type == \"select-multiple\" )\n {\n current = document.forms[X].elements[i].selectedIndex;\n A = document.forms[X].elements[i].options[current].text;\n A.match(/^.*\\+?\\$symbol(.+\$)/)\n B = RegExp.\$1\n if ( A.match(/\\+\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) + Number(B);\n               }\n if ( A.match(/[^+]\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) - Number(Price) + Number(B);\n }\n }\n }\n }\n if (document.forms[X].quantity)\n {\n document.forms[X].add.value *= document.forms[X].quantity.value;\n }\n whole = parseInt(document.forms[X].add.value)\n if ( isNaN(whole) ) { whole = \"0\" }\n dec = document.forms[X].add.value - whole\n // dec *= 1000\n dec *= Math.pow(10,($decimals2 + 1))\n dec = parseInt(dec)\n dec /= 10\n round = dec - parseInt(dec)\n round *= 10\n round = parseInt(round)\n dec = parseInt(dec)\n if ( round >= 5 )\n {\n dec += 1;\n // if ( dec == 100 ) { whole += 1; dec = 00 }\n if ( dec == Math.pow(10,$decimals2) ) { whole += 1; dec = 0 }\n }\n // if ( dec < 10 ) { dec = \"0\" + dec }\n if ( isNaN(dec) ) { dec = \"0\" }\n dec = String(dec)\n while ( dec.length < $decimals2 ) { dec = \"0\" + dec }\n // document.forms[X].add.value = \"$lang[42] \" + \"$symbol2 \" + whole + \".\" + dec\n Commas(whole);\n document.forms[X].add.value = \"$lang[42] $symbol2 \" + whole \n"; if ( $decimals2 ) { print "document.forms[X].add.value = document.forms[X].add.value + \".\" + dec\n";  } print "} // end compat\n else\n {\n document.forms[X].add.value = \"$button\"\n }\n }\n </SCRIPT>\n"; } if ($database_logo && $image) { print "<IMG SRC=\"$image\" TITLE=\"$bizname\" BORDER=0><BR>\n"; } if ( ($navigation_bar) && ( $navigation_bar_position eq "top" || $navigation_bar_position eq "left" ) ) { &navigation_bar; } print "\n<CENTER>\n"; print "<FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\">"; if ( $cat_or_search eq "search" ) { print "$lang[72] "; } print "$cat"; print "</FONT> </CENTER>\n"; print "<CENTER><TABLE BORDER=\"$borders\" CELLPADDING=5 WIDTH=$table_width>\n <TR>"; if (!$name_pos) { $lang[54] = ""; } print "<TD ALIGN=CENTER><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[54]</I></FONT></TD>"; if ($image_pos) { $image_colspan = "4"; print "<TD ALIGN=CENTER><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[73]</I></FONT></TD>"; } else { $image_colspan = "3"; } print "<TD ALIGN=CENTER><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[74]</I></FONT></TD> <TD ALIGN=CENTER><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[75]</I></FONT></TD> </TR>"; print "<TR><TD COLSPAN=\"$image_colspan\" ><HR>\n</TD></TR>"; $total_items = 0; $form = $extra_forms; if (!$form) { $form = '0'; } $cat2 = $cat; $cat2 =~ s/ /_/g; foreach $item (@items) { if ( $item !~ /($separator)/ ) { $item = ""; next; } if ( $item =~ /\n$/ ) { chop($item); } if ( $item =~ /\r$/ ) { chop($item); } $item =~ s/"/&quot;/g; (@line) = split(/$separator/,$item); unshift(@line," "); $ii = @line; for($i=0;$i<=$ii;$i++) { if ($line[$i] =~ /\n$/) { chop($line[$i]); } while ($line[$i] =~ / $/) { chop($line[$i]); } $line[$i] = reverse($line[$i]); if ($line[$i] =~ /\n$/) { chop($line[$i]); } while ($line[$i] =~ / $/) { chop($line[$i]); } $line[$i] = reverse($line[$i]); } $item_cat = $line[$item_cat_pos]; $stock = $line[$stock_pos]; $name = $line[$name_pos]; $name = &quote_strip("$name"); $description = $line[$description_pos]; $description = &quote_strip("$description"); $price = $line[$price_pos]; if ( $price =~ / $/ ) { chop($price); } $sh = $line[$sh_pos]; $image = $line[$image_pos]; $n = 0; $description2 = ""; foreach $addition (@additionals) { $line[$addition] = &quote_strip("$line[$addition]"); $description2 .= "$line[$addition] "; $custom[$n] = $line[$addition]; $n++; } if ( ( $cat_or_search eq "cat" && $item_cat =~ /^$cat$/i ) || ( ($cat_or_search eq "search") && ($cat) && ( $name =~ /$cat/i || $description =~ /$cat/i || $item_cat =~ /$cat/i || $description2 =~ /$cat/i || $stock =~ /$cat/i ) ) || ( ($cat_or_search eq "search") && ($cat2) && ( $name =~ /$cat2/i || $description =~ /$cat2/i || $item_cat =~ /$cat2/i || $description2 =~ /$cat2/i || $stock =~ /$cat2/i ) ) || (( $item_cat_pos == 0 ) && ($cat_or_search eq "cat") && ($item)) || (( $item_cat_pos == 0 ) && ($cat_or_search eq "search") && ($item) && ($cat =~ /^(All).(Items)$/) ) ) { $cat_found = 1; $total_items++; if ( $total_items >= $item_start &&  ($total_items - $item_start) <= ( $items_per_page - 1 )  ) { print "<TR>\n <TD ALIGN=CENTER VALIGN=TOP><FORM METHOD=POST ACTION=\"$path3\">\n <FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><B>$name</B></FONT></TD>\n"; if ($image_pos) { if ( $image =~ /^(http)/ ) { print "<TD ALIGN=CENTER VALIGN=TOP><IMG SRC=\"$image\" BORDER=\"$img_borders\"  TITLE=\"$name\" $uni_width $uni_height ></TD>\n"; } elsif ( $image =~ /\./ ) { print "<TD ALIGN=CENTER VALIGN=TOP><IMG SRC=\"$base_img_url/$image\" BORDER=\"$img_borders\"  TITLE=\"$name\" $uni_width $uni_height ></TD>\n"; } else { print "<TD ALIGN=CENTER VALIGN=TOP>$image_statement &nbsp;</TD>"; } } print "<TD VALIGN=TOP><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$description"; if ($stock) { print "<BR>$lang[112] $stock"; } $n = 3; foreach $custom (@custom) { if (( $custom ) && ( $custom !~ /^OPTIONS/i && $custom !~ /^CHECKBOX/i && $custom !~ /^TEXT/i && $custom !~ /^QUANTITY/i ) ) { print "<BR>$custom"; } $n++; } print "</FONT></TD>\n <TD ALIGN=CENTER VALIGN=TOP><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">"; $symbol2 = "\\" . "$symbol"; if ( $price =~ /$discount_sep/ ) { (@discount_prices) = split(/$discount_sep/,$price); $nt_discount_prices_temp = @discount_prices; for($dp=0;$dp<=$nt_discount_prices_temp-1;$dp+=2) { print "<NOBR>$discount_prices[$dp+1] = $symbol $discount_prices[$dp] $lang[63]</NOBR><BR>"; } } elsif ($price) { if ($price !~ /$symbol2/ ) { print "$symbol "; } print "$price<BR>"; } print "</FONT>\n <INPUT TYPE=HIDDEN NAME=\"name\" VALUE=\"$name\">\n <INPUT TYPE=HIDDEN NAME=\"price\" VALUE=\"$price\">\n <INPUT TYPE=HIDDEN NAME=\"sh\" VALUE=\"$sh\">\n"; if ($database_return_url) { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$database_return_url\">\n"; } else { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$path3?$ENV{'QUERY_STRING'}\">\n"; } print "<INPUT TYPE=HIDDEN NAME=\"add2\" VALUE=\"1\">\n"; if ( $image =~ /^(http)/ ) { print "<INPUT TYPE=HIDDEN NAME=\"img\" VALUE=\"$image\">\n"; } elsif ( $image =~ /\./ ) { print "<INPUT TYPE=HIDDEN NAME=\"img\" VALUE=\"$base_img_url/$image\">\n"; } print "<INPUT TYPE=HIDDEN NAME=\"custom1\" VALUE=\"$description\">\n"; if ($stock) { print "<INPUT TYPE=HIDDEN NAME=\"custom2\" VALUE=\"$lang[112] $stock\">\n"; } $n = 3; foreach $custom (@custom) { if (( $custom ) && ( $custom !~ /^OPTIONS/i && $custom !~ /^CHECKBOX/i && $custom !~ /^TEXT/i && $custom !~ /^QUANTITY/i ) ) { print "<INPUT TYPE=HIDDEN NAME=\"custom$n\" VALUE=\"$custom\">\n"; } $n++; } if ( $button =~ /^http/i ) { print "<INPUT TYPE=HIDDEN NAME=\"add\">\n"; print "<INPUT TYPE=IMAGE NAME=\"add\" SRC=\"$button\" VALUE=\"$button\" BORDER=0>\n"; } else { print "&nbsp;<INPUT TYPE=SUBMIT NAME=\"add\" VALUE=\"$button\" >\n"; } print "</TD></TR>"; print "<TR><TD COLSPAN=\"$image_colspan\" ALIGN=\"$db_select_alignment\" >"; $n = 3; foreach $custom (@custom) { if (( $custom ) && ( $custom =~ /^OPTIONS/i )) { ($size,@options) = split(/$options_separator/,$custom); $size =~ /^OPTIONS(\d*)/i; $size = $1; if (!$force_no_script) { print "<NOSCRIPT>"; } print "<SELECT NAME=\"custom$n\" SIZE=\"$size\" >"; if (!$force_no_script) { print "</NOSCRIPT>"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<SELECT NAME=\"custom$n\" SIZE=\"$size\" OnChange=\"Total($form)\">');\n }\n else\n {\n document.write('<SELECT NAME=\"custom$n\" SIZE=\"$size\" >');\n }\n </SCRIPT>\n"; } $m = 0; foreach $opt (@options) { if ( $size > 1 && $m == 0 ) { print "<OPTION SELECTED>$opt\n"; } else { print "<OPTION>$opt\n"; } $m++; } print "</SELECT>\n"; if ($db_select_stack_or_across eq "stack") { print "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^CHECKBOX/i )) { ($size,@options) = split(/$options_separator/,$custom); $opt = "@options"; if ( $symbol eq "\\" ) { $opt =~ s/\\/\\\\/g; } if (!$force_no_script) { print "<NOSCRIPT>"; } print "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> <INPUT TYPE=CHECKBOX NAME=\"custom$n\" VALUE=\"$opt\" >$opt </FONT>"; if (!$force_no_script) { print "</NOSCRIPT>\n"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> <INPUT TYPE=CHECKBOX NAME=\"custom$n\" VALUE=\"$opt\" onClick=\"Total($form)\">$opt </FONT>');\n }\n else\n {\n document.write('<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> <INPUT TYPE=CHECKBOX NAME=\"custom$n\" VALUE=\"$opt\" >$opt </FONT>');\n }\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { print "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^TEXT/i )) { ($size,@options) = split(/$options_separator/,$custom); ( $options[1] ,$options[2]) = split(/\-/,$options[1]); if (!$options[1]) { $options[1] = "20"; } if (!$options[2]) { $options[2] = "20"; } if (!$force_no_script) { print "<NOSCRIPT>"; } print "<BR><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0]  </FONT> <FONT COLOR=\"$font1\" SIZE=\"$font_size1\"> <INPUT TYPE=TEXT NAME=\"custom$n\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT>"; if (!$force_no_script) { print "</NOSCRIPT>"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n document.write('<BR><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0] </FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><INPUT TYPE=TEXT NAME=\"custom$n\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT>');\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { print "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^QUANTITY/i )) { ($size,@options) = split(/$options_separator/,$custom); if ($options[1] =~ /\n$/ ) { chop($options[1]); } ( $options[1] ,$options[2],$options[3] ) = split(/\-/,$options[1]); if (!$options[1]) { $options[1] = "20"; } if (!$options[2]) { $options[2] = "20"; } if ($options[3] ne "0") { if (!$options[3]) { $options[3] = "1"; } } if (!$force_no_script) { print "<NOSCRIPT>"; } print "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0]  </FONT> <FONT COLOR=\"$font1\" SIZE=\"$font_size1\"> <INPUT TYPE=TEXT NAME=\"quantity\" VALUE=\"$options[3]\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT> "; if (!$force_no_script) { print "</NOSCRIPT>"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0] </FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><INPUT TYPE=TEXT NAME=\"quantity\" VALUE=\"$options[3]\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\" Onblur=\"Total($form)\"> </FONT> ');\n }\n else\n {\n document.write(' <FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0] </FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><INPUT TYPE=TEXT NAME=\"quantity\" VALUE=\"$options[3]\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT> ');\n }\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { print "<BR>\n"; } } $n++; } print "<HR>"; if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat) { Total($form); }\n </SCRIPT>\n"; } print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\">\n </FORM>\n </TD></TR>"; $form++; } } } print "</TABLE>\n<CENTER>"; $cat =~ s/ /\%20/g; if ( !$cat && $cat_or_search eq "search" ) { $cat = "(empty)"; } if ( !$cat_found && $cat_or_search eq "cat" ) { if (!-e "$database_dir/$file") { print "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[106] $database_dir/$file</FONT><BR>"; } else { print "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[76] <B>$cat</B>, $lang[77] <B>$file</B></FONT><BR>"; } } if ( !$cat_found && $cat_or_search eq "search" ) { if (!-e "$database_dir/$file") { print "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[106] $database_dir/$file</FONT><BR>"; } else { print "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[78] <B>$FORM{'search'}</B>.</FONT><BR>"; } } $item_end = $item_start + $items_per_page - 1; if ( $item_end > $total_items ) { $item_end = $total_items; } if ( $total_items > $items_per_page ) { print "<FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\"> $lang[79] $item_start - $item_end $lang[113] $total_items</FONT><BR>"; $new_item_start = $item_start + $items_per_page; $query_separator2 = $query_separator; $query_separator2 =~ s/^\\//; for($i=1;$i<=$total_items;$i=$i+$items_per_page) { if ( ($total_items - $i) < ($items_per_page - 1) ) { $temp = $total_items; } else { $temp = ($i + ($items_per_page - 1)); } if ( $i == $item_start ) { $temp_font = $font2; } else { $temp_font = $font1; } $temp_path = "$path3?db$query_separator2$file$query_separator2$cat$query_separator2$i$query_separator2$items_per_page$query_separator2$cat_or_search"; if ($FORM{'merchant'}) { $temp_path .= "$delimiter$FORM{'merchant'}"; } print " <NOBR><A HREF=\"$temp_path\"><FONT COLOR=\"$temp_font\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[79] $i - $temp</FONT></A></NOBR> &nbsp;"; } print "<BR>"; } print "<BR>\n"; print "<TABLE><TR><TD VALIGN=TOP>\n"; &home; print "</TD><TD VALIGN=TOP>\n"; if ( $view_url ) { print "<FORM METHOD=POST ACTION=\"$path3\">\n"; if ($database_return_url) { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$database_return_url\">\n"; } else { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$path3?$ENV{'QUERY_STRING'}\">\n"; } print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"look\"> <INPUT TYPE=IMAGE SRC=\"$view_url\" NAME=\"$lang[81]\" BORDER=0> </FORM></A></CENTER>\n"; } elsif ( $lang[81] ) { print "<FORM METHOD=POST ACTION=\"$path3\">\n"; if ($database_return_url) { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$database_return_url\">\n"; } else { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$path3?$ENV{'QUERY_STRING'}\">\n"; } print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"look\"> <INPUT TYPE=SUBMIT VALUE=\"$lang[81]\"> </FORM></A></CENTER>\n"; } print "</TD></TR></TABLE>\n"; if ( $navigation_bar && $navigation_bar_position eq "bottom" ) { &navigation_bar; } if ($navigation_bar) { print "</TD></TR></TABLE>"; } print "</BODY></HTML>\n"; } sub database3 { (@temp) = ($FORM{'db'},$FORM{'category'},$FORM{'search'},$FORM{'method'},$FORM{'begin'},$FORM{'display'},$FORM{'price'},$FORM{'merchant'},$FORM{'return'}); foreach (@temp) { $_ =~ s/ /\+/g; $_ =~ s/\?/\%3F/g; $_ =~ s/\=/\%3D/g; $_ =~ s/\&/\%26/g; } $ENV{'QUERY_STRING'} = "$path3" . "?" . "db=$temp[0]&category=$temp[1]&search=$temp[2]&method=$temp[3]&begin=$temp[4]&display=$temp[5]&price=$temp[6]&merchant=$temp[7]"; if ( $FORM{'begin'} ) { $item_start = "$FORM{'begin'}"; } else { $item_start = "1"; } if ( $FORM{'display'} ) {  $items_per_page = "$FORM{'display'}"; } else { $FORM{'display'} = "$items_per_page"; } $FORM{'category'} =~ s/\+/ /g; $FORM{'category'} =~ s/\%20/ /g; $FORM{'search'} =~ s/\+/ /g; $FORM{'search'} =~ s/\%20/ /g; @keywords = (); if ( $FORM{'search'} ) { (@keywords) = split(/ /,$FORM{'search'}); } $FORM{'db'} =~ s/\.\.\///g; $FORM{'db'} =~ s/\.\.//g; $FORM{'db'} =~ s/(\/etc\/passwd)//g; @unauthorized_database_files = ("vars.dat","order.dat","orders.dat","tracking.dat","pending.dat","limited.dat","discount.dat","cart.pl","cart.cgi","ssl.pl","ssl.cgi","lang.dat","shopperid.dat","invoice.dat","processor.dat","processor2.dat","processor3.dat","shipping.dat","passwords.dat","restrict.dat","merchant_passwords.dat", "email_log.txt", "email_log.dat"); foreach $unauthorized_database_file (@unauthorized_database_files) { if ( $FORM{'db'} eq $unauthorized_database_file ) { $FORM{'db'} = ""; } } &symbol2; if ( $FORM{'search'} ) { $title_bar = "$FORM{'search'}"; } if ( $FORM{'category'} ) { $title_bar = "$FORM{'category'}"; } $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD><TITLE>$biz_temp - $title_bar</TITLE>\n$meta_tag\n</HEAD>\n <BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\"> <CENTER>\n"; print "\n\n<FORM NAME=\"symbolform\"> <INPUT TYPE=HIDDEN NAME=symbol VALUE=\"$lang[42] $symbol \"> </FORM>\n"; if ( $diagnostics ) { $temp = ""; foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $temp .= "$name = $value<BR>"; } print "REQUEST_METHOD: $ENV{'REQUEST_METHOD'}<BR>QUERY_STRING: $ENV{'QUERY_STRING'}<BR>POST:<BR>$temp<BR>"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n compat = false;\n if( parseInt( navigator.appVersion ) >= $compat )\n {\n compat = true;\n }\n compat = true;\n </SCRIPT>\n"; } if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n // Pop-up window function\n function Start(page,windowWidth,windowHeight)\n {\n OpenWin = window.open(page, \"infoWindow\", \"toolbar=0,location=0,directories=0,status=1,menubar=0,scrollbars=1,resizable=1,width=\" + windowWidth + \",height=\" + windowHeight + \",top=100,left=300\");\n }\n //if( (navigator.appVersion.search(/Mac/i)>=0) && (navigator.appName==\"Netscape\") )\n if( navigator.appVersion.search(/Mac/i)>=0 )\n { compat = false; }\n compat = true;\n function Commas(intnum)\n {\n intstr = \"\"+intnum;\n inserts = parseInt(intstr.length)/3;\n sep = \"$currency_sep\"\n for(i=1;i<=inserts;i++)\n {\n if (intnum >= Math.pow(1000,i))\n {\n intlen = intstr.length\n temp1=parseInt(\"\"+(intnum/Math.pow(1000,i)))\n temp2=intstr.substring(intlen-((i*4)-1),intlen)\n intstr = temp1+sep+temp2\n }\n }\n whole = intstr\n }\n function Total(X)\n {\n if(compat)\n {\n if (document.forms[X].quantity)\n {\n"; if (!$fix_int_quantity) { print "if ( document.forms[X].quantity.value < 1 ) { document.forms[X].quantity.value = 1; }\n"; } print "if ( isNaN(document.forms[X].quantity.value) ) { document.forms[X].quantity.value = 1; }\n"; if (!$fix_int_quantity) { print "document.forms[X].quantity.value = parseInt(document.forms[X].quantity.value);\n"; } print "}\n if ( document.forms[X].price.value.match(/$discount_sep/) )\n {\n Prices = document.forms[X].price.value.split(\"$discount_sep\");\n for(dp=0;dp<=Prices.length-1;dp+=2)\n {\n if ( document.forms[X].quantity && document.forms[X].quantity.value >= Number(Prices[dp+1]) ) { document.forms[X].add.value = Prices[dp]; }\n if ( !document.forms[X].quantity && Number(Prices[dp+1]) == 1 ) { document.forms[X].add.value = Prices[dp]; }\n }\n }\n else { document.forms[X].add.value = document.forms[X].price.value }\n document.forms[X].add.value.match(/(\\$symbol)?(.*)/)\n document.forms[X].add.value = Number(RegExp.\$2)\n Price = Number(RegExp.\$2)\n"; if ($custom_description_currency_symbol_feature) { print "for (i = 0 ; i < document.forms[X].elements.length ; i++)\n {\n if ( document.forms[X].elements[i].name.match(/custom/) && document.forms[X].elements[i].type != \"hidden\" )\n {\n if ( document.forms[X].elements[i].type == \"checkbox\" && document.forms[X].elements[i].checked )\n { A = document.forms[X].elements[i].value;\n A.match(/^.*\\+?\\$symbol(.+\$)/)\n B = RegExp.\$1\n                 if ( A.match(/\\+\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) + Number(B);\n }\n if ( A.match(/[^+]\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) - Number(Price) + Number(B);\n }\n }\n if ( document.forms[X].elements[i].type == \"select-one\" || document.forms[X].elements[i].type == \"select-multiple\" )\n {\n current = document.forms[X].elements[i].selectedIndex;\n A = document.forms[X].elements[i].options[current].text;\n A.match(/^.*\\+?\\$symbol(.+\$)/)\n B = RegExp.\$1\n if ( A.match(/\\+\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) + Number(B);\n               }\n if ( A.match(/[^+]\\$symbol/) )\n {\n document.forms[X].add.value = Number(document.forms[X].add.value) - Number(Price) + Number(B);\n }\n }\n }\n }\n"; } print "if (document.forms[X].quantity)\n {\n document.forms[X].add.value *= document.forms[X].quantity.value;\n }\n whole = parseInt(document.forms[X].add.value)\n if ( isNaN(whole) ) { whole = \"0\" }\n dec = document.forms[X].add.value - whole\n // dec *= 1000\n dec *= Math.pow(10,($decimals2 + 1))\n dec = parseInt(dec)\n dec /= 10\n round = dec - parseInt(dec)\n round *= 10\n round = parseInt(round)\n dec = parseInt(dec)\n if ( round >= 5 )\n {\n dec += 1;\n // if ( dec == 100 ) { whole += 1; dec = 00 }\n if ( dec == Math.pow(10,$decimals2) ) { whole += 1; dec = 0 }\n }\n // if ( dec < 10 ) { dec = \"0\" + dec }\n if ( isNaN(dec) ) { dec = \"0\" }\n dec = String(dec)\n while ( dec.length < $decimals2 ) { dec = \"0\" + dec }\n // document.forms[X].add.value = \"$lang[42] \" + \"$symbol2 \" + whole + \".\" + dec\n Commas(whole);\n document.forms[X].add.value = document.symbolform.symbol.value + whole \n"; if ( $decimals2 ) { print "document.forms[X].add.value = document.forms[X].add.value + \".\" + dec\n";  } print "} // end compat\n else\n {\n document.forms[X].add.value = \"$button\"\n }\n }\n </SCRIPT>\n"; } $bizname_no_html_tags = "$bizname"; $bizname_no_html_tags =~ s/<([^>]|\n)*>//g; if ($database_logo && $image) { print "<IMG SRC=\"$image\" TITLE=\"$bizname_no_html_tags\" BORDER=0><BR>\n"; } if ( ($navigation_bar) && ( $navigation_bar_position eq "top" || $navigation_bar_position eq "left" ) ) { &navigation_bar; } print "\n<CENTER>\n"; print "<FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\">"; if ( $FORM{'category'} && $lang[91] ) { print "$lang[91] $FORM{'category'}<BR>"; } if ( $FORM{'search'} && $lang[72] ) { print "$lang[72] $FORM{'search'}<BR>"; } if ( $FORM{'method'} && $lang[92] && ( $FORM{'method'} !~ /$lang[93]/i ) ) { print "$lang[92] $FORM{'method'}<BR>"; } $database_output .= "</FONT> </CENTER>\n"; $database_output .= "<CENTER><TABLE BORDER=\"$borders\" CELLPADDING=5 CELLSPACING=0 WIDTH=$table_width>\n <TR>"; if (!$name_pos) { $lang[54] = ""; } $database_output .= "<TD ALIGN=$item_align><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[54]</I></FONT></TD>"; if ($image_pos) { $image_colspan = "4"; $database_output .= "<TD ALIGN=$image_align><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[73]</I></FONT></TD>"; } else { $image_colspan = "3"; } $database_output .= "<TD ALIGN=$desc_align><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[74]</I></FONT></TD> <TD ALIGN=$price_align><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><I>$lang[75]</I></FONT></TD> </TR>"; $database_output .= "<TR><TD COLSPAN=\"$image_colspan\" ><HR>\n</TD></TR>"; $total_items = 0; $form = $extra_forms; if (!$form) { $form = '1'; } open (FILE,"$database_dir/$FORM{'db'}"); while (<FILE>) { $item = $_; if ( $item !~ /($separator)/ ) { $item = ""; next; } if ( $item =~ /^(#)/ ) { $item = ""; next; } while ($item =~ /(\n|\r|\s)$/) { chop($item); } $item =~ s/"/&quot;/g; (@line) = split(/$separator/,$item); unshift(@line," "); $ii = @line; for($i=0;$i<=$ii;$i++) { while ($line[$i] =~ /(\n|\r|\s)$/) { chop($line[$i]); } $line[$i] = reverse($line[$i]); while ($line[$i] =~ /(\n|\r|\s)$/) { chop($line[$i]); } $line[$i] = reverse($line[$i]); } $item_cat = $line[$item_cat_pos]; $stock = $line[$stock_pos]; $name = $line[$name_pos]; $name = &quote_strip("$name"); $description = $line[$description_pos]; $description = &quote_strip("$description"); $price = $line[$price_pos]; if ( $price =~ / $/ ) { chop($price); } $sh = $line[$sh_pos]; $image = $line[$image_pos]; $image2 = ""; $n = 0; $description2 = ""; foreach $addition (@additionals) { $line[$addition] = &quote_strip("$line[$addition]"); $description2 .= "$line[$addition] "; $custom[$n] = $line[$addition]; $n++; } if (@all_searchable_fields) { $all_searchable_fields = ""; foreach $searchable_field_position (@all_searchable_fields) { $line[$searchable_field_position] = &quote_strip("$line[$searchable_field_position]"); $all_searchable_fields .= "$line[$searchable_field_position] "; } $item = "$all_searchable_fields"; } $cat_pass = 0; $search_pass = 0; $price_pass = 0; if ( $FORM{'category'} && ( $item_cat =~ /^$FORM{'category'}$/i ) ) { $cat_pass = 1; $category_exists = 1; } if ( !$FORM{'category'} ) { $cat_pass = 1; } if ( $FORM{'search'} ) { if ( ( $FORM{'method'} =~ /^($lang[93])$/i ) || (!$FORM{'method'}) ) { foreach $key_word (@keywords) { $key_word2 = &foreign_character_replace($key_word); $item2 = &foreign_character_replace($item); if ( $item2 =~ /($key_word2)/i ) { $search_pass = 1; } } } if ( $FORM{'method'} =~ /^($lang[94])$/i ) { $keywords = (@keywords); $keywords2 = 0; foreach $key_word (@keywords) { $key_word2 = &foreign_character_replace($key_word); $item2 = &foreign_character_replace($item); if ( $item2 =~ /($key_word2)/i ) { $keywords2++; } } if ( $keywords == $keywords2 ) { $search_pass = 1; } } if ( $FORM{'method'} =~ /^($lang[95])$/i ) { $key_word2 = &foreign_character_replace($FORM{'search'}); $item2 = &foreign_character_replace($item); if ( $item2 =~ /($key_word2)/i ) { $search_pass = 1; } } } if ( !$FORM{'search'} ) { $search_pass = 1; } if ( $FORM{'price'} ) { if ( $FORM{'price'} =~ /\-/ ) { ($price_low,$price_high) = split(/\-/,$FORM{'price'}); if ( ( $price >= $price_low ) && ( $price <= $price_high ) ) { $price_pass = 1; } } if ( $FORM{'price'} !~ /\-/ ) { if ( ( $price <= $FORM{'price'} ) ) { $price_pass = 1; } } } if ( !$FORM{'price'} ) { $price_pass = 1; } if ( $cat_pass && $search_pass && $price_pass ) { $match_found = 1; $total_items++; if ( $total_items >= $item_start &&  ($total_items - $item_start) <= ( $items_per_page - 1 )  ) { $database_output .= "<TR>\n <TD ALIGN=$item_align VALIGN=TOP><FORM METHOD=POST ACTION=\"$path3\" TARGET=\"$target_name\" >\n <FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"><B>$name</B></FONT></TD>\n"; if ($image_pos) { if ( $image =~ /^(http)/ || $image =~ /\./ ) { if ( $image =~ /::/ ) { ($image,$image2) = split (/::/,"$image"); if ( $image2 !~ /^(http)/ ) { $temp_url2 =  "$base_img_url/"; } else { $temp_url2 =  ""; } $temp_anchor1 =  "<A HREF=\"$temp_url2$image2\">"; $temp_anchor2 =  "</A>"; } else { $temp_anchor1 =  ""; $temp_anchor2 =  ""; } if ( $image !~ /^(http)/ ) { $temp_url =  "$base_img_url/"; } else { $temp_url =  ""; } $name_no_html_tags = "$name"; $name_no_html_tags =~ s/<([^>]|\n)*>//g; $database_output .= "<TD ALIGN=$image_align VALIGN=TOP>$temp_anchor1<IMG SRC=\"$temp_url$image\" BORDER=\"$img_borders\"  TITLE=\"$name_no_html_tags\" $uni_width $uni_height >$temp_anchor2</TD>\n"; } else { $database_output .= "<TD ALIGN=$image_align VALIGN=TOP>$image_statement &nbsp;</TD>\n"; } } $database_output .= "<TD VALIGN=TOP ALIGN=$desc_align><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">"; if ($description && ($description !~ /\#non.*taxable\#/i && $description !~ /\#noshipping\#/i && $description !~ /\#nodiscount\#/i ) ) { $database_output .= "$description<BR>\n"; } if ($stock) { $database_output .= "$lang[112] $stock<BR>\n"; } $n = 3; foreach $custom (@custom) { if (( $custom ) && ( $custom !~ /^OPTIONS(\d*)$options_separator/i && $custom !~ /^CHECKBOX$options_separator/i && $custom !~ /^TEXT$options_separator/i && $custom !~ /^TEXTAREA$options_separator/i && $custom !~ /^QUANTITY$options_separator/i && $custom !~ /\#non.*taxable\#/i && $custom !~ /\#noshipping\#/i && $custom !~ /\#nodiscount\#/i ) ) { $database_output .= "$custom<BR>\n"; } $n++; } $database_output .= "</FONT></TD>\n <TD ALIGN=$price_align VALIGN=TOP><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">\n"; $symbol2 = "\\" . "$symbol"; if ( $price =~ /$discount_sep/ ) { (@discount_prices) = split(/$discount_sep/,$price); $nt_discount_prices_temp = @discount_prices; for($dp=0;$dp<=$nt_discount_prices_temp-1;$dp+=2) { $database_output .= "<NOBR>$discount_prices[$dp+1] = $symbol $discount_prices[$dp] $lang[63]</NOBR><BR>\n"; } } elsif ($price) { $database_output .= "<NOBR>"; if ($price !~ /$symbol2/ ) { $database_output .= "$symbol "; } $database_output .= "$price</NOBR><BR>\n"; } $database_output .= "</FONT>\n <INPUT TYPE=HIDDEN NAME=\"name\" VALUE=\"$name\">\n <INPUT TYPE=HIDDEN NAME=\"price\" VALUE=\"$price\">\n <INPUT TYPE=HIDDEN NAME=\"sh\" VALUE=\"$sh\">\n"; if ($FORM{'return'}) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$FORM{'return'}\">\n"; } elsif ($database_return_url) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$database_return_url\">\n"; } else { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$ENV{'QUERY_STRING'}\">\n"; } $database_output .= "<INPUT TYPE=HIDDEN NAME=\"add2\" VALUE=\"1\">\n"; if ( $image =~ /^(http)/ ) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"img\" VALUE=\"$image\">\n"; } elsif ( $image =~ /\./ ) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"img\" VALUE=\"$base_img_url/$image\">\n"; } if ( $image2 ) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"img2\" VALUE=\"$image2\">\n"; } if ( $suppress_desc != 3) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"custom1\" VALUE=\"$description\">\n"; if ($stock) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"custom2\" VALUE=\"$lang[112] $stock\">\n"; } } $n = 3; foreach $custom (@custom) { if (( $custom ) && ( $custom !~ /^OPTIONS(\d*)$options_separator/i && $custom !~ /^CHECKBOX$options_separator/i && $custom !~ /^TEXT$options_separator/i && $custom !~ /^TEXTAREA$options_separator/i && $custom !~ /^QUANTITY$options_separator/i ) ) { if ( ($suppress_desc != 3) || ( $custom =~ /\#nontaxable\#/ || $custom =~ /\#noshipping\#/ || $custom =~ /\#nodiscount\#/ ) ) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"custom$n\" VALUE=\"$custom\">\n"; } } $n++; } if ( $database_button_location ne "bottom" ) { if ( $button =~ /^http/i ) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"add\">\n"; $database_output .= "<INPUT TYPE=IMAGE NAME=\"add\" SRC=\"$button\" VALUE=\"$button\" BORDER=0>\n"; } else { $database_output .= "&nbsp;<INPUT TYPE=SUBMIT NAME=\"add\" VALUE=\"$button\" >\n"; } } $database_output .= "</TD></TR>"; $database_output .= "<TR><TD COLSPAN=\"$image_colspan\" ALIGN=\"$db_select_alignment\" >"; $n = 3; foreach $custom (@custom) { if (( $custom ) && ( $custom =~ /^OPTIONS(\d*)$options_separator/i )) { ($size,@options) = split(/$options_separator/,$custom); $size =~ /^OPTIONS(\d*)/i; $size = $1; if (!$force_no_script) { $database_output .= "\n<NOSCRIPT>\n"; } $database_output .= "\n<SELECT NAME=\"custom$n\" SIZE=\"$size\" >\n"; if (!$force_no_script) { $database_output .= "\n</NOSCRIPT>\n"; } if (!$force_no_script) { $database_output .= "\n<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<SELECT NAME=\"custom$n\" SIZE=\"$size\" OnChange=\"Total($form)\">');\n }\n else\n {\n document.write('<SELECT NAME=\"custom$n\" SIZE=\"$size\" >');\n }\n </SCRIPT>\n"; } $m = 0; foreach $opt (@options) { if ( $size > 1 && $m == 0 ) { $database_output .= "<OPTION SELECTED>$opt\n"; } else { $database_output .= "<OPTION>$opt\n"; } $m++; } $database_output .= "</SELECT>\n"; if ($db_select_stack_or_across eq "stack") { $database_output .= "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^CHECKBOX$options_separator/i )) { ($size,@options) = split(/$options_separator/,$custom); $opt = "@options"; if ( $symbol eq "\\" ) { $opt =~ s/\\/\\\\/g; } if (!$force_no_script) { $database_output .= "<NOSCRIPT>"; } $database_output .= "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> <INPUT TYPE=CHECKBOX NAME=\"custom$n\" VALUE=\"$opt\" >$opt </FONT>"; if (!$force_no_script) { $database_output .= "</NOSCRIPT>\n"; } if (!$force_no_script) { $database_output .= "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> <INPUT TYPE=CHECKBOX NAME=\"custom$n\" VALUE=\"$opt\" onClick=\"Total($form)\">$opt </FONT>');\n }\n else\n {\n document.write('<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> <INPUT TYPE=CHECKBOX NAME=\"custom$n\" VALUE=\"$opt\" >$opt </FONT>');\n }\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { $database_output .= "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^TEXT$options_separator/i )) { ($size,@options) = split(/$options_separator/,$custom); ( $options[1] ,$options[2]) = split(/\-/,$options[1]); if (!$options[1]) { $options[1] = "20"; } if (!$options[2]) { $options[2] = "20"; } if (!$force_no_script) { $database_output .= "<NOSCRIPT>"; } $database_output .= "<BR><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0]  </FONT> <FONT COLOR=\"$font1\" SIZE=\"$font_size1\"> <INPUT TYPE=TEXT NAME=\"custom$n\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT>"; if (!$force_no_script) { $database_output .= "</NOSCRIPT>"; } if (!$force_no_script) { $database_output .= "<SCRIPT LANGUAGE=\"JavaScript\">\n document.write('<BR><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0] </FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><INPUT TYPE=TEXT NAME=\"custom$n\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT>');\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { $database_output .= "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^TEXTAREA$options_separator/i )) { ($size,@options) = split(/$options_separator/,$custom); ( $options[1] ,$options[2]) = split(/\-/,$options[1]); if (!$options[1]) { $options[1] = "30"; } if (!$options[2]) { $options[2] = "5"; } if (!$force_no_script) { $database_output .= "<NOSCRIPT>"; } $database_output .= "<BR><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0]<BR>\n  </FONT> <FONT COLOR=\"$font1\" SIZE=\"$font_size1\"> <TEXTAREA NAME=\"custom$n\" COLS=\"$options[1]\" ROWS=\"$options[2]\" WRAP=virtual> </TEXTAREA></FONT>"; if (!$force_no_script) { $database_output .= "</NOSCRIPT>"; } if (!$force_no_script) { $database_output .= "<SCRIPT LANGUAGE=\"JavaScript\">\n document.write('<BR><FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0]<BR></FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><TEXTAREA NAME=\"custom$n\" COLS=\"$options[1]\" ROWS=\"$options[2]\" WRAP=virtual></TEXTAREA></FONT>');\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { $database_output .= "<BR>\n"; } } if (( $custom ) && ( $custom =~ /^QUANTITY$options_separator/i )) { ($size,@options) = split(/$options_separator/,$custom); if ($options[1] =~ /\n$/ ) { chop($options[1]); } ( $options[1] ,$options[2],$options[3] ) = split(/\-/,$options[1]); if (!$options[1]) { $options[1] = "20"; } if (!$options[2]) { $options[2] = "20"; } if ($options[3] ne "0") { if (!$options[3]) { $options[3] = "1"; } } if (!$force_no_script) { $database_output .= "<NOSCRIPT>"; } $database_output .= "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0]  </FONT> <FONT COLOR=\"$font1\" SIZE=\"$font_size1\"> <INPUT TYPE=TEXT NAME=\"quantity\" VALUE=\"$options[3]\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT> "; if (!$force_no_script) { $database_output .= "</NOSCRIPT>"; } if (!$force_no_script) { $database_output .= "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat)\n {\n document.write('<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0] </FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><INPUT TYPE=TEXT NAME=\"quantity\" VALUE=\"$options[3]\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\" Onblur=\"Total($form)\"> </FONT> ');\n }\n else\n {\n document.write(' <FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\"> $options[0] </FONT><FONT COLOR=\"$font1\" SIZE=\"$font_size1\"><INPUT TYPE=TEXT NAME=\"quantity\" VALUE=\"$options[3]\" SIZE=\"$options[1]\" MAXLENGTH=\"$options[2]\"> </FONT> ');\n }\n </SCRIPT>\n"; } if ($db_select_stack_or_across eq "stack") { $database_output .= "<BR>\n"; } } $n++; } if ( $database_button_location eq "bottom" ) { $database_output .= "</TD></TR>\n"; $database_output .= "<TR><TD COLSPAN=\"$image_colspan\" ALIGN=right>\n"; if ( $button =~ /^http/i ) { $database_output .= "<INPUT TYPE=HIDDEN NAME=\"add\" VALUE=\"1\">\n"; $database_output .= "<INPUT TYPE=IMAGE NAME=\"add\" SRC=\"$button\" VALUE=\"$button\" BORDER=0>\n"; } else { $database_output .= "&nbsp;<INPUT TYPE=SUBMIT NAME=\"add\" VALUE=\"$button\" >\n"; } } $database_output .= "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\">\n </FORM>\n"; if (!$force_no_script) { $database_output .= "<SCRIPT LANGUAGE=\"JavaScript\">\n if (compat) { Total($form); }\n </SCRIPT>\n"; } $database_output .= "<HR>"; $database_output .= "</TD></TR>"; $form++; } } } close (FILE); $database_output .= "</TABLE>\n<CENTER>"; if ( !$match_found ) { if (!-e "$database_dir/$FORM{'db'}") { if (!$vars_security) { $database_output .= "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[106] $database_dir/$FORM{'db'}</FONT><BR>\n"; } else { $database_output .= "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[106] .../$FORM{'db'}</FONT><BR>\n"; } } elsif ( ($FORM{'category'}) && (!$category_exists) ) { $database_output .= "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[76] <B>$FORM{'category'}</B>, $lang[77] <B>$FORM{'db'}</B></FONT><BR>\n"; } else { $database_output .= "<FONT COLOR=\"$font1\" FACE=\"$font_face1\" SIZE=\"$font_size1\">"; if ( $FORM{'search'} ) { $database_output .= "$lang[78] <B>$FORM{'search'}</B><BR>\n"; } if ( $FORM{'method'} ) { $database_output .= "$lang[92] $FORM{'method'}<BR>\n"; } if ( $FORM{'price'} ) { $database_output .= "$lang[96] $FORM{'price'}<BR>\n"; } $database_output .= "</FONT><BR>\n"; } } $item_end = $item_start + $items_per_page - 1; if ( $item_end > $total_items ) { $item_end = $total_items; } if ( $item_end == 0 ) { $item_start = "0"; } { print "<FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\"> $lang[79] $item_start - $item_end $lang[113] $total_items</FONT><BR>\n"; } print "$database_output\n"; $FORM{'category'} =~ s/ /\+/g; $FORM{'search'} =~ s/ /\+/g; if ( $db_next_link_method eq "next" ) { $item_end = $item_start + $items_per_page - 1; if ( $item_end > $total_items ) { $item_end = $total_items; } print "<FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\">$lang[79] $item_start - $item_end $lang[113] $total_items</FONT><BR>\n"; if ( $FORM{'begin'} > 1 ) { $previous_start = $FORM{'begin'} - $FORM{'display'}; if ( $previous_start < 1 ) { $previous_start = 1; } $temp_path = "$path3" . "?" . "db=$FORM{'db'}&category=$FORM{'category'}&search=$FORM{'search'}&method=$FORM{'method'}&begin=$previous_start&display=$FORM{'display'}&price=$FORM{'price'}&merchant=$FORM{'merchant'}"; print " <NOBR><A HREF=\"$temp_path\"><FONT COLOR=\"$font2\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[150] $FORM{'display'} $lang[79]</FONT></A></NOBR> &nbsp;"; } if ( ( $FORM{'begin'} + $FORM{'display'} ) <= $total_items ) { $next_start = $item_start + $FORM{'display'}; if ( $next_start > $total_items ) { $next_start = $total_items; } $temp_path = "$path3" . "?" . "db=$FORM{'db'}&category=$FORM{'category'}&search=$FORM{'search'}&method=$FORM{'method'}&begin=$next_start&display=$FORM{'display'}&price=$FORM{'price'}&merchant=$FORM{'merchant'}"; print " <NOBR><A HREF=\"$temp_path\"><FONT COLOR=\"$font2\" FACE=\"$font_face1\" SIZE=\"$font_size1\">$lang[149] $FORM{'display'} $lang[79]</FONT></A></NOBR> &nbsp;"; } print "<BR>\n"; print "<BR>\n"; } else { $item_end = $item_start + $items_per_page - 1; if ( $item_end > $total_items ) { $item_end = $total_items; } if ( $total_items > $items_per_page ) { print "<FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\"> $lang[79] $item_start - $item_end $lang[113] $total_items</FONT><BR>\n"; $new_item_start = $item_start + $items_per_page; $query_separator2 = $query_separator; $query_separator2 =~ s/^\\//; print "<FORM METHOD=POST ACTION=\"$path3\">\n <INPUT TYPE=HIDDEN NAME=\"db\" VALUE=\"$FORM{'db'}\">\n <INPUT TYPE=HIDDEN NAME=\"category\" VALUE=\"$FORM{'category'}\">\n <INPUT TYPE=HIDDEN NAME=\"search\" VALUE=\"$FORM{'search'}\">\n <INPUT TYPE=HIDDEN NAME=\"method\" VALUE=\"$FORM{'method'}\">\n <INPUT TYPE=HIDDEN NAME=\"display\" VALUE=\"$FORM{'display'}\">\n <INPUT TYPE=HIDDEN NAME=\"price\" VALUE=\"$FORM{'price'}\">\n <INPUT TYPE=HIDDEN NAME=\"merchant\" VALUE=\"$FORM{'merchant'}\">\n <SELECT NAME=\"begin\">\n"; for($i=1;$i<=$total_items;$i=$i+$items_per_page) { if ( ($total_items - $i) < ($items_per_page - 1) ) { $temp = $total_items; } else { $temp = ($i + ($items_per_page - 1)); } if ( $i == $item_start ) { $temp_font = $font2; } else { $temp_font = $font1; } $selected_item = ""; if ($FORM{'begin'} == $i) { $selected_item = "SELECTED"; } print "<OPTION VALUE=\"$i\" $selected_item>$lang[79] $i - $temp\n"; } if (!$lang[164]) { $lang[164] = "GO";} print "</SELECT>\n"; if ( $lang[164] =~ /^(http)/ ) { print "<INPUT TYPE=IMAGE SRC=\"$lang[164]\" BORDER=0 ALIGN=CENTER>\n"; } else { print "<INPUT TYPE=SUBMIT VALUE=\"$lang[164]\">\n"; } print "</FORM>\n"; } } print "<TABLE><TR><TD VALIGN=TOP>\n"; &home; print "</TD><TD VALIGN=TOP>\n"; if ( $view_url ) { print "<FORM METHOD=POST ACTION=\"$path3\">\n"; if ($FORM{'return'}) { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$FORM{'return'}\">\n"; } elsif ($database_return_url) { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$database_return_url\">\n"; } else { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$ENV{'QUERY_STRING'}\">\n"; } print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"look\"> <INPUT TYPE=IMAGE SRC=\"$view_url\" NAME=\"$lang[81]\" BORDER=0> </FORM></A></CENTER>\n"; } elsif ( $lang[81] ) { print "<FORM METHOD=POST ACTION=\"$path3\">\n"; if ($database_return_url) { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$database_return_url\">\n"; } else { print "<INPUT TYPE=HIDDEN NAME=\"return\" VALUE=\"$ENV{'QUERY_STRING'}\">\n"; } print "<INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=purpose VALUE=\"look\"> <INPUT TYPE=SUBMIT VALUE=\"$lang[81]\"> </FORM></A></CENTER>\n"; } print "</TD></TR></TABLE>\n"; if ( $navigation_bar && $navigation_bar_position eq "bottom" ) { &navigation_bar; } if ($navigation_bar) {  print "</TD></TR>\n"; print "</TABLE>\n"; } if ( $navigation_bar2 ) { &navigation_bar2; } print "</BODY></HTML>\n"; } sub navigation_bar { $extra_forms = 1; if ($navigation_bar) { open(NAVBAR,"$navigation_bar"); @nav_bar_html=<NAVBAR>; close(NAVBAR); print "<TABLE WIDTH=$table_width BORDER=$borders CELLPADDING=0 CELLSPACING=0 ><TR><TD VALIGN=TOP>\n"; foreach (@nav_bar_html) { print "$_\n"; while ( $_ =~ /(<form)/gi ) { $extra_forms++; } } if (!-e "$navigation_bar")  { print "Could not find Navigation Bar file at: \"$navigation_bar\""; } print "</TD>"; if ( $navigation_bar_position eq "top" ) { print "</TR><TR>\n"; } print "<TD VALIGN=TOP>"; $table_width = "100%"; } } sub navigation_bar2 { $extra_forms = 0; if ($navigation_bar2) { open(NAVBAR,"$navigation_bar2"); @nav_bar_html=<NAVBAR>; close(NAVBAR); print "<TABLE WIDTH=$table_width BORDER=$borders CELLPADDING=0 CELLSPACING=0><TR><TD VALIGN=TOP>\n"; foreach (@nav_bar_html) { print "$_\n"; while ( $_ =~ /(<form)/gi ) { $extra_forms++; } } if (!-e "$navigation_bar2")  { print "Could not find Navigation Bar file at: \"$navigation_bar2\""; } print "</TD></TR></TABLE>"; } } sub quote_strip { $q = "&quot;"; $_ = $_[0]; s/(<)([^>|\n]*)(")([^>|\n]*)(>)/$1$2$4$5/gi while (/(<)([^>|\n]*)(")([^>|\n]*)(>)/); s/(<)([^>|\n]*)($q)([^>|\n]*)(>)/$1$2$4$5/gi while (/(<)([^>|\n]*)($q)([^>|\n]*)(>)/); return $_; } sub get_sales_tax { $sn = 0; foreach (@state) { if ( $state[$sn] eq $state ) { $tax_rate = $tax[$sn]; last; } $sn++; } } sub address_table { print "<BR>"; print "<CENTER><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[2]</FONT><BR><FONT SIZE=\"$font_size1\" FACE=\"$font_face1\" COLOR=\"$font1\">$lang[3]</FONT></CENTER><BR>"; print "<CENTER><TABLE WIDTH=$table_width BORDER=4 CELLPADDING=5 CELLSPACING=0 BGCOLOR=\"$address_table_bgcolor\"><TR><TD WIDTH=15%><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[4]</FONT></TD><TD WIDTH=60%>&nbsp;</TD></TR>"; if ($use_company_name_field) { print "<TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><NOBR>$lang[90]</NOBR></FONT></TD><TD>&nbsp;</TD></TR>"; } print "<TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><NOBR>$lang[5]</NOBR></FONT></TD><TD>&nbsp;</TD></TR>"; print "<TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><NOBR>$lang[6]</NOBR></FONT></TD><TD>&nbsp;</TD></TR>"; print "<TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\">$lang[7]</FONT></TD><TD>&nbsp;</TD></TR>"; print "<TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><NOBR>$lang[8]</NOBR></FONT></TD><TD>&nbsp;</TD></TR>"; print "<TR><TD><FONT SIZE=\"$font_size2\" FACE=\"$font_face2\" COLOR=\"$font2\"><NOBR>$lang[9]</NOBR></FONT></TD><TD>&nbsp;</TD></TR>"; print "</TABLE></CENTER><BR>"; } sub ship_calc { $ship_total_db = $ship_total; if ($ship_allow == 1) { if ($shipping_roundup) { if ( ($ship_total - int($ship_total)) > 0 && ( $ship_total < 1 ) ) { $ship_total = int($ship_total); $ship_total++; } } if ($shipping_roundup2) { if ( ( $ship_total > 0 ) && ($ship_total != int($ship_total)) ) { $ship_total = int($ship_total); $ship_total++; } } $an = 0; foreach $type (@method) { if ( $method_init_price[$an] =~ /(\D+)(.*)(\.)(\D+)/ ) { &db_shipping; } else { if ( $ship_total >= 1 ) { $price[$an] = $ship_total * $method_price[$an]; $price[$an] += ( $method_init_price[$an] - $method_price[$an] ); } if  ( $ship_total < 1 ) { $price[$an] = $ship_total * $method_init_price[$an]; } } $price[$an] = sprintf("$decimals", $price[$an]); if ( $ship_total == 0 ) { $price[$an] = 0; } $an++; } $an = 0; if ( $ship_total > 0 ) { foreach $type (@method) { if ( $ship_method eq $type ) { if ( $method_init_price[$an] =~ /(\D+)(.*)(\.)(\D+)/ ) { &db_shipping; $ship_total = $price[$an]; } else { if ( $ship_total >= 1 ) { $ship_total *= $method_price[$an]; $ship_total += ( $method_init_price[$an] - $method_price[$an] ); } elsif  ( $ship_total < 1 ) { $ship_total *= $method_init_price[$an]; } } } $an++; } } } if ($ship_allow == 2) { if ($shipping_calculated_on_subtotal_before_coupon_discounts) { $total_ship_temp = $total + $coupon_amount_shipping_calculation; } else { $total_ship_temp = $total; } $total_ship_temp -= $noshipping; if ( $total_ship_temp < .01 ) { $total_ship_temp = "0"; } $total_ship_temp = "$total_ship_temp"; $already_know_what_method_is = $ship_method; $an = 0; foreach (@shipping_locations) { $ship_method = ""; $ship_total = 0; @temp = split(/\,/,$shipping_via_amount[$an]); $highest = $temp[(@temp-2)]; while (@temp) { ($b) = pop(@temp); ($a) = pop(@temp); if ( ($total_ship_temp > 0) && $total_ship_temp < $a) { $ship_total = $b; $ship_method = "$shipping_locations[$an]"; } if ( ($total_ship_temp < $a) && ( $b =~ /(\%)$/ ) ) { chop($b); $ship_total = ( ($b * $total_ship_temp) / 100 ); $ship_total = sprintf("$decimals","$ship_total"); } } if (!$ship_method) { $ship_total = "0.00"; } $price[$an] = $ship_total; if ( $shipping_locations[$an] eq $already_know_what_method_is ) { $ship_method = "$shipping_locations[$an]";  $ship_method_chosen = "$ship_method"; $ship_grand_total = $ship_total; } $an++; } } if ( $already_know_what_method_is ) { $ship_method = "$ship_method_chosen"; $ship_total = $ship_grand_total; } else { } } sub db_shipping { $ship_db = "$vars"; $a = ""; until ($a eq "/" || $ship_db eq "") { $a = chop($ship_db); } $ship_db = "$ship_db/$method_init_price[$an]"; if (!-e"$ship_db") { $type = "Cannot find: $ship_db"; } else { open(FILE,"$ship_db"); @ship_db_lines=<FILE>; close(FILE); foreach $ship_db_line (@ship_db_lines) { while ($ship_db_line =~ /(\n|\r|\s)$/) { chop($ship_db_line); } ($db_pounds,$db_cost) = split(/\|/,$ship_db_line); if ( ($ship_db_line =~ /\|/) && ($ship_total >= $db_pounds) ) { $price[$an] = "$db_cost"; } } } } sub calculate_fulltotal { $total = 0; $nontaxable = 0; $noshipping = 0; $nodiscount = 0; $nodiscount_items = 0; $ship_total = 0; $summary_items = 0; $n = 0; chop($items[0]); ($a,$invoice,$state,$ship_method,$comments2,$coupon_amount,$coupon_number) = split(/$delimiter2/, $items[0]); foreach $item (@items) { if ( ( $n == 0 ) || ( $n == 1 ) ) { $n++; next; } @stuff = split(/$delimiter2/,$item); @customs = (@stuff); for($i=1;$i<=5;$i++) { shift(@customs); } $quantity = $stuff[4]; $price_calc = $stuff[1]; &price_calc; $summary_items += $stuff[4]; $item_total = $each * $stuff[4]; if ($item =~ /\#non.*taxable\#/i) { $nontaxable += $item_total; } if ($item =~ /\#noshipping\#/i) { $noshipping += $item_total; } if ($item =~ /\#nodiscount\#/i) { $nodiscount += $item_total; $nodiscount_items += $stuff[4]; } $total += $item_total; $ship_total += $stuff[2] * $stuff[4]; $n++; } $subtotal_original_for_minimum_order = $total; if ( $coupon_amount ) { &coupon_amount; } &webstore_discount; $total -= $discount_amount; if ( $nontaxable ) { $nontaxable -= $discount_amount; } $summary_subtotal = "$total"; $summary_subtotal = sprintf("$decimals","$summary_subtotal"); $summary_subtotal =~ s/ //g; if ( $ship_allow ) { &ship_calc; $ship_total = sprintf("$decimals","$ship_total"); } else { $ship_total = 0; } $taxes = 0; if ( $state ) { &get_sales_tax; $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; if ( $tax_allow == 1 || $tax_allow == 2 ) { $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; } if ( $tax_allow == 3 || $tax_allow == 4 ) { $taxes = ($total - $nontaxable + $ship_total) * $tax_rate; $taxes /= 100; } else { $taxes = ($total - $nontaxable) * $tax_rate; $taxes /= 100; } $taxes =~ /(.*)(\.)(\d)(\d)(\d)/; if ( $5 >= 5 ) { $taxes += .005; } } $total += $taxes if ( $state ); $total += $ship_total if ( $ship_allow ); $total = sprintf("$decimals","$total"); $total =~ s/ //g; } sub webstore_discount { if ($webstore_discount) { $disc_items_total = 0; $discount_amount = 0; ($disc_type,$disc_start,$disc_percent,@multi_disc) = split(/$delimiter2/,$webstore_discount); $disc_percent2 = $disc_percent / 100; if ($disc_type eq "items") { $dn = 0; foreach $disc_count (@items) { if ( $dn < 2 ) { $dn++; next; } ($trash,$trash,$trash,$trash,$disc_items,$first_custom) = split(/$delimiter2/,$disc_count); if ( ( $lang[107] ) && ( $first_custom ne "$lang[107]" ) ) { $disc_items_total += $disc_items; } $dn++; } unshift(@multi_disc,$disc_start,$disc_percent); while (@multi_disc) { ($a) = shift(@multi_disc); ($b) = shift(@multi_disc); if ( ($disc_items_total - $nodiscount_items) >= $a ) { $disc_percent = $b; $discount_amount = ($total - $nodiscount) * ($b/100); $discount_amount = sprintf("$decimals",$discount_amount); } } } if ($disc_type eq "subtotal") { unshift(@multi_disc,$disc_start,$disc_percent); while (@multi_disc) { ($a) = shift(@multi_disc); ($b) = shift(@multi_disc); if ( ($total - $nodiscount) >= $a ) { $disc_percent = $b; $discount_amount = ($total - $nodiscount) * ($b/100); $discount_amount = sprintf("$decimals",$discount_amount); } } } } } sub add_new_item_to_cart { if ( $FORM{'name'} =~ /^(multi-items)$/i ) { for($mi=1;$mi<=$customs;$mi++) { if ( ( $FORM{"multi-item$mi"} && $old_multi_item_form ) || ( $FORM{"multi-item$mi"} && !$old_multi_item_form && $FORM{"quantity$mi"} && $FORM{"quantity$mi"} > 0) ) { ($FORM{'name'},$FORM{'price'},$FORM{'sh'},$FORM{'img'},@multi_custom) = split(/$delimiter2/,$FORM{"multi-item$mi"}); $FORM{'quantity'} = $FORM{"quantity$mi"}; &fix_quantity; &limited_item_check; print CART "$FORM{'name'}$delimiter$FORM{'price'}$delimiter$FORM{'sh'}$delimiter$FORM{'img'}$delimiter$FORM{'quantity'}"; for($ci=0;$ci<$customs;$ci++) { print CART "$delimiter$multi_custom[$ci]"; } print CART "\n"; } } } else { &limited_item_check; if ( $FORM{'img2'} ) { $img_temp = "::$FORM{'img2'}"; } else { $img_temp = ""; } print CART "$FORM{'name'}$delimiter$FORM{'price'}$delimiter$FORM{'sh'}$delimiter$FORM{'img'}$img_temp$delimiter$FORM{'quantity'}"; for($ci=1;$ci<=$customs;$ci++) { print CART "$delimiter$FORM{\"custom$ci\"}"; } print CART "\n"; } } sub limited_item_check { $limited_dir = "$vars"; $a = ""; until ($a eq "/" || $limited_dir eq "") { $a = chop($limited_dir); } if (-e "$limited_dir/limited.dat") { open (LIMITED, "$limited_dir/limited.dat"); if ($flock) { flock(LIMITED, 2); } @limited = <LIMITED>; if ($flock) { flock(LIMITED, 8); } close (LIMITED); foreach $limited_item (@limited) { if ($limited_item =~ /\n$/) { chop($limited_item); } ($limit_name,$limit_quantity,$limit_one_of_a_kind_or_backorderable) = split(/$delimiter2/,$limited_item); if ( ($FORM{'name'} eq "$limit_name") && ($limit_quantity <= 0) ) { if ( !$limit_one_of_a_kind_or_backorderable || $limit_one_of_a_kind_or_backorderable == 0 ) { $FORM{'name'} = "$FORM{'name'}"; $FORM{'price'} = "0"; $FORM{'sh'} = ""; $FORM{'quantity'} = "1"; for($ci=1;$ci<=$customs;$ci++) { $FORM{"custom$ci"} = ""; $multi_custom[$ci] = ""; } $FORM{"custom1"} = "$lang[107]"; $multi_custom[1] = "$lang[107]"; last; } if ( $limit_one_of_a_kind_or_backorderable == 1 ) { $FORM{"custom1"} = "$lang[180]$delimiter" . $FORM{"custom1"}; $multi_custom[1] = "$lang[180]$delimiter" . $multi_custom[1]; last; } } elsif ( ($FORM{'name'} eq "$limit_name") && ($limit_quantity < $FORM{'quantity'}) ) { $FORM{'quantity'} = $limit_quantity if(!$limit_one_of_a_kind_or_backorderable); for($ci=1;$ci<=$customs;$ci++) { if (!$FORM{"custom$ci"}) { $FORM{"custom$ci"} = "$lang[173] $limit_quantity"; $multi_custom[$ci] = "$lang[173] $limit_quantity"; if ( $limit_one_of_a_kind_or_backorderable == 1 ) { $FORM{"custom$ci"} = "$lang[180]$delimiter" . $FORM{"custom$ci"}; $multi_custom[$ci] = "$lang[180]$delimiter" . $multi_custom[$ci]; } last; } } } } } } sub limited_item_deincrement { foreach $limited_item (@limited) { chomp($limited_item); ($limit_name,$limit_quantity,$limit_one_of_a_kind_or_backorderable) = split(/$delimiter2/,$limited_item); if ( $stuff[0] eq "$limit_name" ) { if ( $fix_int_quantity != "1" ) { if ( $stuff[4] < 1 ) { $stuff[4] = 1; } } $limit_quantity -= $stuff[4]; if ( $limit_quantity < 0 ) { $limit_quantity = "0"; } $limited_item = "$limit_name|$limit_quantity|$limit_one_of_a_kind_or_backorderable"; $deincrement = 1; last; } } } sub fix_quantity { while ( $FORM{'quantity'} =~ /[a-zA-Z]/ ) { chop($FORM{'quantity'}); } if ( !$FORM{'quantity'} ) { $FORM{'quantity'} = 1; } if ( $FORM{'quantity'} < 0 ) { $FORM{'quantity'} = 1; } if ( $fix_int_quantity != 1 ) { $FORM{'quantity'} = int($FORM{'quantity'}); } } sub fix_quantity2 { if ( $FORM{'quantity'} < 0 ) { $FORM{'quantity'} = 1; } if ( $FORM{'quantity'} && $FORM{'quantity'} !~ /\d/ ) { $FORM{'quantity'} = 1; } if ( $fix_int_quantity != 1 ) { $FORM{'quantity'} = int($FORM{'quantity'}); } } sub get_shoppers_items { if ( $virtual_browser_cookie ) { $shopper_id = "$virtual_browser_cookie"; } elsif ( $shopper_id ) { } elsif ( ($ip_or_cookie) && &GetCookies("$cookie_name2") && (-e "$path1/$Cookies{$cookie_name2}$ext") ) { $shopper_id = "$Cookies{$cookie_name2}"; unlink("$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext"); } elsif (-e "$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext") { $shopper_id = "$ENV{'REMOTE_HOST'}$browser_os_info"; open(CART,"$path1/$shopper_id$ext"); @items = <CART>; close (CART); (@temp) = split(/\|/,$items[0]); unlink("$path1/$temp[1]$ext"); } elsif ($adding_new_item_to_basket || $referrer_setup) { &increment_invoice; &SetCookieExpDate; &SetCookies($cookie_name2,$invoice) if ($ip_or_cookie); $shopper_id = $invoice; } open(CART,"$path1/$shopper_id$ext"); @items = <CART>; close (CART); if ( $items[0] =~ /^(.+?)($delimiter2)(.*)/ ) { $items[0] = "$date$2$3"; chomp($items[0]); $items[0] .= "\n"; } } sub increment_invoice { $max_size_invoice_file = 10; open(INVOICE,"$path2"); if ($flock) { flock(INVOICE, 2); } @invoice = <INVOICE>; @invoice = sort { $a <=> $b } @invoice; $invoice = $invoice[@invoice-1]; $invoice++; if ( @invoice > $max_size_invoice_file ) { until(@invoice < ($max_size_invoice_file / 2) ) { shift(@invoice); } $path2 = &untaint("$path2"); open(INVOICE,">$path2"); foreach (@invoice) { print INVOICE "$_"; } } else { $path2 = &untaint("$path2"); open(INVOICE,">>$path2"); if ( @invoice ) { if ( $invoice[@invoice-1] !~ /\n$/ ) { print INVOICE "\n"; } } } print INVOICE "$invoice\n"; if ($flock) { flock(INVOICE, 8); } close(INVOICE); open(INVOICE,"$path2"); if ($flock) { flock(INVOICE, 2); } @check_invoice = <INVOICE>; @check_invoice = sort { $a <=> $b } @check_invoice; $check_invoice = $check_invoice[@check_invoice-1]; if ($flock) { flock(INVOICE, 8); } close(INVOICE); chomp($check_invoice); if ($check_invoice ne $invoice) { $error_log="$vars"; $a=""; until ($a eq "/" || $error_log eq "") { $a=chop($error_log); } $error_log1 = "$error_log" . "/error_log.txt"; $error_log2 = "$error_log" . "/error_log.dat"; if (-e "$error_log2") { $error_log = "$error_log2"; } else { $error_log = "$error_log1"; } if (-e "$error_log" ) { open(LOG,">>$error_log"); print LOG "Date: $date\n"; print LOG "Trying to increment shopper ID from $check_invoice to $invoice.\n"; print LOG "The cart has tried to write to the shopperid.dat file at:\n$path2\nbut was unsuccessful. Check that write permissions are set.\n\n"; close(LOG); } } } sub cookie_failure { if ( (!-e "$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext") && ( $ip_or_cookie != 2 ) ) { $temp_path1 = &untaint("$path1/$FORM{'convert_cookie_to_ip'}$ext"); $temp_path2 = &untaint("$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext"); rename ("$temp_path1", "$temp_path2"); } } sub GetCookies { local(@ReturnCookies) = @_; local($cookie_flag) = 0; local($cookie,$value); if ($ENV{'HTTP_COOKIE'}) { if ($ReturnCookies[0] ne '') { foreach (split(/; /,$ENV{'HTTP_COOKIE'})) { ($cookie,$value) = split(/=/); foreach $char (@Cookie_Decode_Chars) { $cookie =~ s/$char/$Cookie_Decode_Chars{$char}/g; $value =~ s/$char/$Cookie_Decode_Chars{$char}/g; } foreach $ReturnCookie (@ReturnCookies)  { if ($ReturnCookie eq $cookie) { $Cookies{$cookie} = $value; $cookie_flag = "1"; } } } } else { foreach (split(/; /,$ENV{'HTTP_COOKIE'})) { ($cookie,$value) = split(/=/); foreach $char (@Cookie_Decode_Chars) { $cookie =~ s/$char/$Cookie_Decode_Chars{$char}/g; $value =~ s/$char/$Cookie_Decode_Chars{$char}/g; } $Cookies{$cookie} = $value; } $cookie_flag = 1; } } return $cookie_flag; } sub SetCookies { local(@cookies) = @_; local($cookie,$value,$char); while( ($cookie,$value) = @cookies ) { foreach $char (@Cookie_Encode_Chars) { $cookie =~ s/$char/$Cookie_Encode_Chars{$char}/g; $value =~ s/$char/$Cookie_Encode_Chars{$char}/g; } $cookieoutput = $cookie . '=' . $value . ';'; if ($Cookie_Exp_Date) { $cookieoutput .= ' expires=' . $Cookie_Exp_Date . ';'; } if ($Cookie_Path) { $cookieoutput .= ' path=' . $Cookie_Path . ';'; } if ($Cookie_Domain) { $cookieoutput .= ' domain=' . $Cookie_Domain . ';'; } if ($Secure_Cookie) { $cookieoutput .= ' secure'; } $cookieoutput .= "HttpOnly"; $cookieoutput .= "\n"; if ($mod_perl_no_headers) { print header(-cookie=>$cookieoutput); } else { print 'Set-Cookie: ' . $cookieoutput; } shift(@cookies); shift(@cookies); } } sub SetCookieExpDate { @date = localtime(time); foreach (@date) { if ( $_ < 10 ) { $_ = "0" . $_; } } $date[4] = (Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec)[$date[4]]; $date[6] = (Sun,Mon,Tue,Wed,Thu,Fri,Sat)[$date[6]]; if ( $date[5] < 100 ) { if ( $date[5] > 97 ) { $date[5] = "19" . $date[5]; } else { $date[5] = "20" . $date[5]; } } if ( $date[5] < 100 ) { $date[5] = "20" . "$date[5]"; } if ( ( $date[5] >= 100 ) && ( $date[5] < 2000 ) ) { $date[5] += 1900; } $date[5]++; $Cookie_Exp_Date = "$date[6] $date[4] $date[3] $date[2]:$date[1]:$date[0] $date[5] GMT"; } sub SetCookieExpDate2 { @date = localtime(time); foreach (@date) { if ( $_ < 10 ) { $_ = "0" . $_; } } $date[4] = (Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec)[$date[4]]; $date[6] = (Sun,Mon,Tue,Wed,Thu,Fri,Sat)[$date[6]]; if ( $date[5] < 100 ) { if ( $date[5] > 97 ) { $date[5] = "19" . $date[5]; } else { $date[5] = "20" . $date[5]; } } if ( $date[5] < 100 ) { $date[5] = "20" . "$date[5]"; } if ( ( $date[5] >= 100 ) && ( $date[5] < 2000 ) ) { $date[5] += 1900; } $Cookie_Exp_Date = "$date[6] $date[4] $date[3], $date[5] $date[2]:$date[1]:$date[0]"; if ( eval "require(\"timezone.lib\");" ) { $Cookie_Exp_Date = change_timezone($Cookie_Exp_Date); } $Cookie_Exp_Date =~ s/^(.+?)(, )(\d\d\d\d)(.+)(\s)(\w+)$/$1$4 $3/; } sub SetCompressedCookies { local($cookie_name,@cookies) = @_; local($cookie,$value,$cookie_value); while ( ($cookie,$value) = @cookies ) { foreach $char (@Cookie_Encode_Chars) { $cookie =~ s/$char/$Cookie_Encode_Chars{$char}/g; $value =~ s/$char/$Cookie_Encode_Chars{$char}/g; } if ($cookie_value) { $cookie_value .= '&' . $cookie . '::' . $value; } else { $cookie_value = $cookie . '::' . $value; } shift(@cookies); shift(@cookies); } &SetCookies("$cookie_name","$cookie_value"); } sub GetCompressedCookies { local($cookie_name,@ReturnCookies) = @_; local($cookie_flag) = 0; local($ReturnCookie,$cookie,$value); if (&GetCookies($cookie_name)) { if ($ReturnCookies[0] ne '') { foreach (split(/&/,$Cookies{$cookie_name})) { ($cookie,$value) = split(/::/); foreach $char (@Cookie_Decode_Chars) { $cookie =~ s/$char/$Cookie_Decode_Chars{$char}/g; $value =~ s/$char/$Cookie_Decode_Chars{$char}/g; } foreach $ReturnCookie (@ReturnCookies) { if ($ReturnCookie eq $cookie) { $Cookies{$cookie} = $value; $cookie_flag = 1; } } } } else { foreach (split(/&/,$Cookies{$cookie_name})) { ($cookie,$value) = split(/::/); foreach $char (@Cookie_Decode_Chars) { $cookie =~ s/$char/$Cookie_Decode_Chars{$char}/g; $value =~ s/$char/$Cookie_Decode_Chars{$char}/g; } $Cookies{$cookie} = $value; } $cookie_flag = 1; } delete($Cookies{$cookie_name}); } return $cookie_flag; } sub check_cookie { if ( $ip_or_cookie ) { &GetCookies("$cookie_name2"); $shopper_id = "$Cookies{$cookie_name2}"; if ( ( (!$shopper_id) || (!-e "$path1/$shopper_id$ext") ) && (!-e "$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext") ) { &cookie_failure; } } } sub footer { print "\n<H3>Questions, Comments, Suggestions:\n <A HREF=\"mailto:&#99;&#97;&#114;&#116;&#64;&#100;&#97;&#110;&#115;&#105;&#101;&#46;&#110;&#101;&#116;\">&#99;&#97;&#114;&#116;&#64;&#100;&#97;&#110;&#115;&#105;&#101;&#46;&#110;&#101;&#116;</A> <BR>  <A HREF=\"http://www.dansie.net\">http://www.dansie.net</A></H3> <SMALL> Use of the Dansie Shopping Cart software is subject to the terms of the license agreement. By using this software you signify that you have read the license agreement and accept its terms. Your purchase of a Dansie Shopping Cart software license entitles you to one (1) working copy of the script per license. You may NOT copy, reproduce, resell, or give away copies of the script in any way shape or form without first purchasing additional licenses. You may make one back up copy should something happen to the working copy on your host. You may not make any modifications to the Dansie Shopping Cart script except as instructed in the ReadMe. The small text link and credit to http://www.dansie.net must remain in the script and appear at the bottom of the various pages of shopping cart script. Violation of this license agreement may void your license without refund, your right to technical support and subject you to legal action.<BR> Dansie Shopping Cart $version<BR> Copyright &copy; Dec 10, 1997-2009<BR> </SMALL>"; exit; } sub untaint { if ( $_[0] ne "" ) { $_[0] =~ /^(.+)$/; $a = $1; } else { $a = ""; } return $a; } sub required_fields { if ( $reqired_field_prefs =~ /(email)/i && $FORM{'email'} !~ /^([\w|\-|\.|\_|\+]+)(\@)([\w|\-|\.|\_|\+]+)(\.)(\w+)$/ ) { $no_valid_email_address = 1; &log_invalid_email_address("$FORM{email}"); } if ( $reqired_field_prefs =~ /(confirm_email)/i && ($FORM{'email'} ne $FORM{'confirm_email'}) ) { $email_not_confirmed = 1; return 0; } if (  ( $reqired_field_prefs =~ /(name)/i && (!$FORM{'name'}) ) || ( $reqired_field_prefs =~ /(company)/i && !$FORM{'company'} && $use_company_name_field ) || ( $reqired_field_prefs =~ /(address)/i && (!$FORM{'address'}) ) || ( $reqired_field_prefs =~ /(city)/i && (!$FORM{'city'}) ) || ( $reqired_field_prefs =~ /(state)/i && (!$FORM{'state'}) && $use_state ) || ( $reqired_field_prefs =~ /(zip)/i && (!$FORM{'zip'}) && $use_zipcode_fields ) || ( $reqired_field_prefs =~ /(country)/i && (!$FORM{'country'}) ) || ( $reqired_field_prefs =~ /(email)/i && (!$FORM{'email'}) ) || ( $reqired_field_prefs =~ /(confirm_email)/i && (!$FORM{'confirm_email'}) ) || ( $reqired_field_prefs =~ /(phone)/i && (!$FORM{'phone'}) ) || ( $reqired_field_prefs =~ /(comments)/i && (!$FORM{'comments'}) ) ) { return 0; } else { return 1; } } sub required_fields2 { if ( $reqired_field_prefs =~ /(email)/i && $FORM{'email2'} !~ /^([\w|\-|\.|\_|\+]+)(\@)([\w|\-|\.|\_|\+]+)(\.)(\w+)$/ ) { $no_valid_email_address2 = 1; &log_invalid_email_address("$FORM{email2}"); } if ( $reqired_field_prefs =~ /(confirm_email)/i && ($FORM{'email2'} ne $FORM{'confirm_email2'}) ) { $email_not_confirmed = 1; return 0; } if (  ( $reqired_field_prefs =~ /(name)/i && (!$FORM{'name2'}) ) || ( $reqired_field_prefs =~ /(company)/i && !$FORM{'company2'} && $use_company_name_field ) || ( $reqired_field_prefs =~ /(address)/i && (!$FORM{'address2'}) ) || ( $reqired_field_prefs =~ /(city)/i && (!$FORM{'city2'}) ) || ( $reqired_field_prefs =~ /(state)/i && (!$FORM{'state2'}) && $use_state ) || ( $reqired_field_prefs =~ /(zip)/i && (!$FORM{'zip2'}) && $use_zipcode_fields ) || ( $reqired_field_prefs =~ /(country)/i && (!$FORM{'country2'}) ) || ( $reqired_field_prefs =~ /(email)/i && (!$FORM{'email2'}) ) || ( $reqired_field_prefs =~ /(confirm_email)/i && (!$FORM{'confirm_email2'}) ) || ( $reqired_field_prefs =~ /(phone)/i && (!$FORM{'phone2'}) ) ) { return 0; } else { return 1; } } sub log_invalid_email_address { if (-e "$email_log") { open(LOG,">>$email_log"); print LOG "Date: $date\n"; print LOG "A shopper has entered an invalid email address as follows:\n"; print LOG "$_[0]\n\n"; close(LOG); } } sub pass_standard_secure_variables { if ( $MerchantID =~ /$delimiter2/ ) { ($MerchantID,$cambist_exchange_rate) = split(/$delimiter2/,$MerchantID); $total *= $cambist_exchange_rate; while ( $total =~ /(\d*)(\.)(\d{3,})/ ) { chop($total); } } print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[1]\" VALUE=\"$total\">\n"; if ( $show_bizname || !$ssl_logo_url || $secure_field[2] eq "x_Description" ) { $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[2]\" VALUE=\"$biz_temp\">\n"; } print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[3]\" VALUE=\"$MerchantID\">\n<INPUT TYPE=HIDDEN NAME=\"$secure_field[4]\" VALUE=\"$email_cc_numbers\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[5]\" VALUE=\"$MerchantFont\">\n" if ($secure_field[5]); print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[6]\" VALUE=\"$MerchantFontColor\">\n" if ($secure_field[6]); print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[7]\" VALUE=\"$MerchantBgrdColor\">\n" if ($secure_field[7]); print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[8]\" VALUE=\"$MerchantApprovedURL\">\n<INPUT TYPE=HIDDEN NAME=\"$secure_field[9]\" VALUE=\"$MerchantUnApprovedURL\">\n<INPUT TYPE=HIDDEN NAME=\"$secure_field[10]\" VALUE=\"$invoice\">\n"; if ($secure_field[49]) { print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[49]\" VALUE=\"$ssl_logo_url\">\n"; } unless ( $FORM{'merchant'} && ($path5 =~ /(cambist\.com)/i) ) { print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[19]\" VALUE=\"$cambist_back\">\n" if ($secure_field[19]); } if ( $authorizenet_fingerprint ) { if ( !defined(&InsertFP) ) { print "<H2>You have SSV#9 set to use an AuthorizeNet transaction key, yet the required SimLib.pm and/or SimHMAC.pm Perl modules are corrupted. Contact AuthorizeNet technical support for assistance.</H2>\n"; exit; } print "\n"; &InsertFP($loginid, $txnkey, $x_amount); $servers_clock = time; print "\n<!-- For diagnosing if your server's clock is causing a problem making a fingerprint hash.\n"; print "Server's Clock: $servers_clock\n"; print "Server's date and time: $date\n"; print "-->\n\n"; } for($secure_field_array=20;$secure_field_array<$max_secure_field_array;$secure_field_array++) { if ( $secure_field[$secure_field_array] ) { $temp = $secure_field_array - 19; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[$secure_field_array]\" VALUE=\"$custom_processor_field[$temp]\">\n"; } } } sub pass_shipping_secure_variables { print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[11]\" VALUE=\"$FORM{'name2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[50]\" VALUE=\"$FORM{'company2'}\">\n" if ($secure_field[50]); print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[12]\" VALUE=\"$FORM{'address2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[13]\" VALUE=\"$FORM{'city2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[14]\" VALUE=\"$FORM{'state2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[15]\" VALUE=\"$FORM{'zip2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[16]\" VALUE=\"$FORM{'country2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[17]\" VALUE=\"$FORM{'phone2'}\">\n"; print "<INPUT TYPE=HIDDEN NAME=\"$secure_field[18]\" VALUE=\"$FORM{'email2'}\">\n"; } sub pass_ssl_variables { if ( $path5 =~ /ssl(.{0,3})\.pl/i || $path5 =~ /ssl(.{0,3})\.cgi/i || $path5 =~ /ssl(.{0,3})\.php/i ) { $meta_tag2 = "$meta_tag"; $meta_tag2 =~ s/"/\&quot;/g; print "<INPUT TYPE=HIDDEN NAME=ssl_url VALUE=\"$path5\">\n"; if ( $no_f_switch ) { print "<INPUT TYPE=HIDDEN NAME=mailprog VALUE=\"no_f_switch|$mailprog\">\n"; } else { print "<INPUT TYPE=HIDDEN NAME=mailprog VALUE=\"$mailprog$blat_server\">\n"; } print "<INPUT TYPE=HIDDEN NAME=date_command VALUE=\"$date_command\">\n"; print "<INPUT TYPE=HIDDEN NAME=append_datafile VALUE=\"$append_datafile\">\n"; print "<INPUT TYPE=HIDDEN NAME=target_name VALUE=\"$target_name\">\n"; print "<INPUT TYPE=HIDDEN NAME=use_state VALUE=\"$use_state\">\n"; print "<INPUT TYPE=HIDDEN NAME=card_types VALUE=\"$card_types\">\n"; print "<INPUT TYPE=HIDDEN NAME=blat_different_temp_directory VALUE=\"$path1/mail$shopper_id$ext\">\n"; print "<INPUT TYPE=HIDDEN NAME=check_draft_image VALUE=\"$check_draft_image\">\n"; print "<INPUT TYPE=HIDDEN NAME=check_wp VALUE=\"$check_wp\">\n"; print "<INPUT TYPE=HIDDEN NAME=meta_tag VALUE=\"$meta_tag2\">\n"; print "<INPUT TYPE=HIDDEN NAME=pgp VALUE='$pgp'>\n"; if ($ssl_tracking_dir) { print "<INPUT TYPE=HIDDEN NAME=ssl_tracking_dir VALUE=\"$ssl_tracking_dir\">\n"; } } } sub custom_processor { open(FILE,"$processor_path"); @processor_data=<FILE>; close FILE; $current_var = 0; @processor_data2 = (); foreach (@processor_data) { while ($_ =~ /(\n|\r|\s)$/) { chop($_); } if ( $_ =~ /(\s?)(\d+)(.*)(-->)(.*)/ ) { $processor_data2[$2] = "$5"; $current_var = $2; } else { $processor_data2[$current_var] .= " $_"; } } (@processor_data) = (@processor_data2); $path5 = "$processor_data[3]"; if ($processor_data[4]) { $MerchantID = "$processor_data[4]"; } for($secure_field_array=20;$secure_field_array<$max_secure_field_array;$secure_field_array++) { if ( $processor_data[$secure_field_array] ) { $temp = $secure_field_array - 19; ($processor_data[$secure_field_array],$custom_processor_field[$temp]) = split(/\|/,"$processor_data[$secure_field_array]"); if ( $custom_processor_field[$temp] eq "#split_name#" ) { $split_name_flag++; if ( $FORM{'name2'} =~ /\s/ ) { $FORM{'name2'} =~ /(.*)(\s)(.*)/; $first_name = "$1"; $last_name = "$3"; } else { $first_name = "$FORM{'name2'}"; $last_name = ""; } if ( $split_name_flag == 1 ) { $custom_processor_field[$temp] = "$first_name"; } else { $custom_processor_field[$temp] = "$last_name"; } } if ( $custom_processor_field[$temp] eq "#company_name#" ) { $custom_processor_field[$temp] = "$FORM{'company2'}"; } } } @secure_field = ("", "$processor_data[5]", "$processor_data[18]", "$processor_data[6]", "$processor_data[19]", "", "", "", "$processor_data[8]", "$processor_data[9]", "$processor_data[7]", "$processor_data[10]", "$processor_data[11]", "$processor_data[12]", "$processor_data[13]", "$processor_data[14]", "$processor_data[15]", "$processor_data[16]", "$processor_data[17]", ""); for($secure_field_array=20;$secure_field_array<$max_secure_field_array;$secure_field_array++) { if ( $processor_data[$secure_field_array] ) { $temp = $secure_field_array - 19; push(@secure_field,"$processor_data[$secure_field_array]"); } } if ($something eq "something") { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but the cart can't find your <B>lang.dat</B> file at system path: <B>\"$lang_path\"</B></H3></CENTER><BR>"; print "<UL><LI>Make sure <B>lang.dat</B> is uploaded into the same directory as vars.dat</UL><BR>"; &footer; } } sub add_and_redirect { if ( $add_and_redirect == 2 ) { $force_no_script = 1; } if ($FORM{'return'}) { $redirect = "$FORM{'return'}"; } else { $redirect = "$path4"; } &header; print "$doctype<HTML>\n"; if (!$force_no_script) { print "<NOSCRIPT>\n"; } print "<HEAD>\n"; print "<META HTTP-EQUIV=REFRESH CONTENT=0;URL=$redirect>\n$meta_tag\n"; print "</HEAD>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n\n"; } print "<BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\">"; if (!$force_no_script) { print "<SCRIPT LANGUAGE=\"JavaScript\">\n var ViewCart = 0;\n function Question()\n {\n if (confirm('$lang[100]\\n$lang[101]')) { ViewCart = 1; }\n else { history.go(-1) }\n }\n function AutoSubmit()\n {\n if ( ViewCart )\n {\n document.form1.submit()\n }\n }\n Question()\n </SCRIPT>\n"; } if (!$force_no_script) { print "<BODY BGCOLOR=\"$bgcolor\" Onload=\"AutoSubmit()\"; >\n"; } else { print "<BODY BGCOLOR=\"$bgcolor\" >\n"; } if (!$force_no_script) { print "\n<NOSCRIPT>\n"; } print "<CENTER> <FONT SIZE=\"$font_size1\" COLOR=\"$font1\" FACE=\"$font_face1\">$lang[100]</FONT> </CENTER>\n"; if (!$force_no_script) { print "</NOSCRIPT>\n\n"; } print "<FORM NAME=\"form1\" METHOD=POST ACTION=\"$path3\"> <INPUT TYPE=HIDDEN NAME=return VALUE=\"$redirect\"> <INPUT TYPE=HIDDEN NAME=merchant VALUE=\"$FORM{'merchant'}\"> <INPUT TYPE=HIDDEN NAME=\"check_cookie\" VALUE=\"yes\"> </FORM>\n"; print "</BODY></HTML>"; exit; } sub i_check { &calculate_fulltotal; $total =~ s/ //g; if ( $exchange_rate ) { $total /= $exchange_rate; } $n = 0; $memo = ""; $icheck_item = ""; foreach $item (@items) { if ( $n > 1 ) { ($a,$trash) = split(/$delimiter2/,$item); $icheck_item = "$icheck_item$a,"; } $n++; } chop($memo); $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; $invoice = "$lang[53]" . " $invoice"; $invoice =~ s/ /\+/g; $invoice =~ s/(\&)/and/g; $invoice =~ s/(\=)/is/g; $memo = "$invoice - $icheck_item"; $memo =~ s/\#//g; $memo =~ s/ /\+/g; $memo =~ s/(\&)/and/g; $memo =~ s/(\=)/is/g; if ( $option4 =~ /^(ValidCheck)/i  ) { $temp_url = "$ValidCheck?VID=$i_check_id\&TA=$total\&Memo=$memo"; } else { $temp_url = "$i_check?id=$i_check_id\&a=$total\&url=$i_checkApprovedURL\&memo=$memo&$icheck_currency&item=$icheck_item"; } $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD> <META HTTP-EQUIV=REFRESH CONTENT=0;URL=$temp_url> <TITLE>$biz_temp - $lang[71]</TITLE>\n$meta_tag\n</HEAD> <BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\"> </BODY></HTML>"; exit; } sub non_post_secure_server { $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; &header; print "$doctype<HTML><HEAD> <META HTTP-EQUIV=REFRESH CONTENT=0;URL=$path5> <TITLE>$biz_temp</TITLE>\n$meta_tag\n</HEAD> <BODY BGCOLOR=\"$bgcolor\" BACKGROUND=\"$wp\"> </BODY></HTML>"; exit; } sub check_duplicate_order { if ( $ip_or_cookie ) { &GetCookies("$cookie_name2"); if ( ( !-e "$path1/$Cookies{$cookie_name2}$ext" ) && (!-e "$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext") ) { &list_items; exit; } if ( -e "$path1/$Cookies{$cookie_name2}$ext" ) { $shopper_id = "$Cookies{$cookie_name2}"; } } else { $shopper_id = "$ENV{'REMOTE_HOST'}$browser_os_info"; if ( !-e "$path1/$shopper_id$ext" ) { &list_items; exit; } } } sub check_duplicate_order2 { if ( $ip_or_cookie ) { &GetCookies("$cookie_name2"); if ( ( !-e "$path1/$Cookies{$cookie_name2}$ext" ) && (!-e "$path1/$ENV{'REMOTE_HOST'}$browser_os_info$ext") ) { if ( $path5 =~ /(\?atsbank)/i ) { $temp_path = "$path3"."?"."$ENV{'QUERY_STRING'}"; print "Location: $temp_path\n\n"; exit; } elsif ( $path5 =~ /(merchantonline\.com)/i && $FORM{'passthru1'} ) { $virtual_browser_cookie = "$FORM{'passthru1'}"; } else { &list_items; exit; } } if ( -e "$path1/$Cookies{$cookie_name2}$ext" ) { $shopper_id = "$Cookies{$cookie_name2}"; } } else { $shopper_id = "$ENV{'REMOTE_HOST'}$browser_os_info"; if ( !-e "$path1/$shopper_id$ext" ) { if ( $path5 =~ /(\?atsbank)/i ) { $temp_path = "$path3"."?"."$ENV{'QUERY_STRING'}"; print "Location: $temp_path\n\n"; exit; } elsif ( $path5 =~ /(merchantonline\.com)/i ) { $shopper_id = "$FORM{'passthru1'}"; } else { &list_items; exit; } } } } sub order_tracking { if (!$tracking_file) { $tracking_file = "$vars"; $a = ""; until ($a eq "/" || $tracking_file eq "") { $a = chop($tracking_file); } $tracking_file = "$tracking_file/tracking.dat"; if (!-e "$tracking_file") { $tracking_file = ""; } } if ($tracking_file) { &get_shoppers_items; if ( $items[1] =~ /\n$/ ) { chop($items[1]); } ($tracking[9],$tracking[1],$trash,$tracking[7],$tracking[24],$coupon_amount,$coupon_number) = split(/$delimiter2/,$items[0]); $chr_temp = chr(20); $tracking[24] =~ s/$br_sub/$chr_temp/g; if ( $coupon_number =~ /\n$/ ) { chop($coupon_number); } if ($coupon_number) { $tracking[1] = "$tracking[1]-$coupon_number"; } (@items_temp) = split(/$delimiter2/,$items[1]); foreach $item_temp (@items_temp) { chomp($item_temp); $item_temp =~ s/(\n|\r)//g; } ($tracking[2],$company_temp,$tracking[11],$tracking[12],$tracking[13],$tracking[14],$tracking[15],$tracking[4],$tracking[3],$tracking[16],$company_temp2,$tracking[17],$tracking[18],$tracking[19],$tracking[20],$tracking[21],$tracking[22],$tracking[23]) = (@items_temp); if ($company_temp) { $tracking[2] .= " - $company_temp"; } if ($company_temp2) { $tracking[16] .= " - $company_temp2"; } &calculate_fulltotal; $tracking[5] = "$total"; $tracking[6] = "$ship_total"; $tracking[6] =~ s/ //g; $tracking[10] = "$taxes"; $tracking[10] = sprintf("$decimals","$tracking[10]"); $tracking[10] =~ s/ //g; $n = 0; $memo = ""; foreach $item (@items) { if ( $n > 1 ) { ($a,$trash,$trash,$trash,$temp_quantity) = split(/$delimiter2/,$item); (@temp) = split(/$delimiter2/,$item); $trash = shift(@temp); $item_price_temp = shift(@temp); $trash = shift(@temp); $trash = shift(@temp); $trash = shift(@temp); $temp_custom_options = join("$custom_description_delimiter", @temp); $temp_custom_options = "$item_price_temp" . "$custom_description_delimiter" . "$temp_custom_options"; while ( $temp_custom_options =~ /($custom_description_delimiter$custom_description_delimiter)/ ) { $temp_custom_options =~ s/($custom_description_delimiter$custom_description_delimiter)/$custom_description_delimiter/g; } while ( $temp_custom_options =~ /(:)$/ ) { chop($temp_custom_options); } if ( $temp_custom_options =~ /(\n)$/ ) { chop($temp_custom_options); } $temp_custom_options =~ s/$product_delimiter//g; if ($temp_custom_options) { $temp_custom_options = "$custom_description_delimiter$temp_custom_options"; } $temp_lang = "$lang[107]"; if ( ($lang[107]) && ($item !~ /$temp_lang/) ) { if (!$temp_quantity) { $temp_quantity = "0"; } $memo .= "$a(Quantity: $temp_quantity)$temp_custom_options$product_delimiter"; } else { } } $n++; } for($i=0;$i<length($product_delimiter);$i++) { chop($memo); } $tracking[8] = "$memo"; open(TRACKING,">>$tracking_file"); print TRACKING "$tracking[1]$delimiter$tracking[2]$delimiter$tracking[3]$delimiter$tracking[4]$delimiter$tracking[5]$delimiter$tracking[6]$delimiter$tracking[7]$delimiter$tracking[8]$delimiter$tracking[9]$delimiter$tracking[10]$delimiter$tracking[11]$delimiter$tracking[12]$delimiter$tracking[13]$delimiter$tracking[14]$delimiter$tracking[15]$delimiter$purchase_method2$delimiter$tracking[16]$delimiter$tracking[17]$delimiter$tracking[18]$delimiter$tracking[19]$delimiter$tracking[20]$delimiter$tracking[21]$delimiter$tracking[22]$delimiter$tracking[23]$delimiter$tracking[24]\n"; close(TRACKING); } } sub diagnostics { if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "env") ) { &header; print "<STRONG>\%ENV Environment variables:</STRONG><BR><BR>"; foreach $key (sort { $a cmp $b } keys %ENV ) { print "$key = $ENV{$key}<BR>\n"; } print "Perl Version: $]<BR>\n"; print "Sendmail?: $mailprog<BR>\n"; print "Dansie Shopping Cart version: $version<BR>\n"; exit; } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "path") ) { if ($ENV{'PATH_TRANSLATED'} || $ENV{'OS'}) { if ($ENV{'PATH_TRANSLATED'}) { $windows_path = $ENV{'PATH_TRANSLATED'}; $windows_path = $ENV{'PATH_TRANSLATED'}; } if ($ENV{'DOCUMENT_ROOT'}) { $temp = "$ENV{'DOCUMENT_ROOT'}"; while ($temp =~ /[\\|\/]$/) { chop($temp); } if (!-e "$temp$ENV{'SCRIPT_NAME'}") { $a = ""; until ($a eq "/" || $a eq "\\" || $temp eq "") { $a = chop($temp); } } $windows_path = "$temp$ENV{'SCRIPT_NAME'}"; $windows_path = "$temp$ENV{'SCRIPT_NAME'}"; } $windows_path =~ s/\\/\//g; $a = ""; until ( !$windows_path || $a eq "/" ) { $a = chop($windows_path); } if (!-e "$windows_path") { $windows_path = "I don't know the system path. Ask your host. =)"; } } if ($ENV{'DOCUMENT_ROOT'} && !$ENV{'OS'}) { $path = `pwd`; if (!-e "$path") { $path = "$ENV{'DOCUMENT_ROOT'}$ENV{'SCRIPT_NAME'}"; } if (!-e "$path") { $path = "$ENV{'SCRIPT_FILENAME'}"; } $a = ""; until ( !$path || $a eq "/" ) { $a = chop($path); } if (!-e "$path") { $path = "I don't know the system path. Ask your host. =)"; } } if (!$ENV{'DOCUMENT_ROOT'} && !$ENV{'OS'} ) { $windows_95_path = "$ENV{'PATH'}"; while ( $windows_95_path =~ /;/ ) { chop($windows_95_path); } $windows_95_path .= "$ENV{'SCRIPT_NAME'}"; $windows_95_path =~ s/\\/\//g; $a = ""; until ( !$windows_95_path || $a eq "/" ) { $a = chop($windows_95_path); } if (!-e "$windows_95_path") { $windows_95_path = "I don't know the system path. Ask your host. =)"; } } &header; print "$path<BR>"; print "$windows_path<BR>"; print "$windows_95_path<BR>"; if ($vars_variable_set) { print "You have set \$vars to:  \"$vars_variable_set\""; } exit; } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "vars") ) { if (!$find_vars_loop) { $find_vars_loop = 1; &cant_find_vars; open(VARS,"$vars"); if ($flock) { flock(VARS, 2); } @vars = <VARS>; if ($flock) { flock(VARS, 8); } close(VARS); &header; foreach $line (@vars) { chop($line); $line =~ s/\</\&lt;/g; print "$line<br>\n"; } exit; } } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "fix_vars") ) { if (!$find_vars_loop) { $find_vars_loop = 1; &cant_find_vars; open(VARS,"$vars"); if ($flock) { flock(VARS, 2); } @vars = <VARS>; if ($flock) { flock(VARS, 8); } close(VARS); &fix_vars; exit; } } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "count_vars") ) { if (!$find_vars_loop) { $find_vars_loop = 1; &cant_find_vars; open(VARS,"$vars"); if ($flock) { flock(VARS, 2); } @vars = <VARS>; if ($flock) { flock(VARS, 8); } close(VARS); &count_vars; exit; } } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "lang") ) { if (!$find_lang_loop) { $find_lang_loop = 1; &find_lang; open(LANG,"$lang_path"); @lang = <LANG>; close LANG; &header; foreach $line (@lang) { chop($line); $line =~ s/\</\&lt;/g; print "$line<br>\n"; } exit; } } if ( (!$vars_security) && ($ENV{'QUERY_STRING'} eq "processor") ) { if (!$find_vars_loop) { $find_vars_loop = 1; &cant_find_vars; $processor_path = "$vars"; $a = ""; until ($a eq "/" || $processor_path eq "") { $a = chop($processor_path); } $processor_path = "$processor_path/processor.dat"; if (-e "$processor_path") { open(PRO,"$processor_path"); if ($flock) { flock(PRO, 2); } @processor = <PRO>; if ($flock) { flock(PRO, 8); } close(PRO); &header; foreach $line (@processor) { chop($line); $line =~ s/\</\&lt;/g; print "$line<br>\n"; } } else { &header; print "No processor.dat file found at this location: $processor_path\n"; } exit; } } &sl; } sub parse_form_data { if ($ENV{'OS'}) { sysread(STDIN, $buffer, $ENV{'CONTENT_LENGTH'}); } else { read(STDIN, $buffer, $ENV{'CONTENT_LENGTH'}); } $ENV{'QUERY_STRING'} =~ s/\%7C/\|/g; @pairs = split(/&/, $buffer); foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $value =~ tr/+/ /; $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg; $value =~ s/~!/ ~!/g; $name =~ s/multiitem/multi-item/i; $value =~ s/multiitem/multi-item/i; $value =~ s/$delimiter2/ /g unless ( ($name =~ /^return$/i) || ($name =~ /^multi-item/i) || ($name =~ /($delimiter2)(merchant)($delimiter2)/i) ); if ($name eq "comments") { $value =~ s/\r//g; chop($value) while ( $value =~ /\n$/ ); $value =~ s/\n/$br_sub/g; } if ($name eq "return") { $value =~ s/\%3F/\?/g; $value =~ s/\%3D/\=/g; $value =~ s/\%26/\&/g; } if ($name eq "email" || $name eq "email2" || $name eq "confirm_email" || $name eq "confirm_email2") { $value =~ s/\s//g; } if ($name =~ /^(custom)/i) { $value =~ s/\r\n/$br_sub/g; $value =~ s/\n/$br_sub/g; $value =~ s/\r/$br_sub/g; } $value =~ s/&#8364;/ï¿½/g; $value =~ s/&pound;/ï¿½/g; $value =~ s/&#163;/ï¿½/g; $value =~ s/<BR>/c3b6H7m5C3nD9r4J7/gi; $value =~ s/(<|%3C)([^>]|\n)*?(>|%3E)//gi; $value =~ s/c3b6H7m5C3nD9r4J7/<BR>/gi; $FORM{$name} = $value; $FORM{$name} = &untaint($FORM{$name}); } if ( $ENV{'QUERY_STRING'} =~ /^(name=)/ || ($ENV{'QUERY_STRING'} =~ /^(db=)/i) ) { $ENV{'QUERY_STRING'} =~ s/(<|%3C)([^>]|\n)*?(>|%3E)//gi; $ENV{'REQUEST_METHOD'} = "POST"; if ( $ENV{'QUERY_STRING'} =~ /^(name=)/) { $FORM{'add'} = "1"; } $ENV{'QUERY_STRING'} =~ s/\%27/\'/g; $ENV{'QUERY_STRING'} =~ s/\%23/\#/g; $ENV{'QUERY_STRING'} =~ s/\%B5/\ï¿½/g; @pairs = split(/&/, $ENV{'QUERY_STRING'}); foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $name =~ s/\+/ /g; $value =~ s/\+/ /g; $value =~ s/~!/ ~!/g; $name =~ s/multiitem/multi-item/i; $value =~ s/multiitem/multi-item/i; $value =~ s/$delimiter2/ /g unless ( ($name =~ /^return$/i) || ($name =~ /^multi-item/i) || ($name =~ /($delimiter2)(merchant)($delimiter2)/i) ); if ( ($name eq "return" ) || ($ENV{'QUERY_STRING'} =~ /^(db=)/i)) { $value =~ s/\%3F/\?/g; $value =~ s/\%3D/\=/g; $value =~ s/\%26/\&/g; } if ( $name =~ /^(custom)/ ) { $value =~ s/\%2B/+/gi; } $FORM{$name} = $value; $FORM{$name} = &untaint($FORM{$name}); } } } sub paper_font_color { $font1 = "$paper_font_color"; $font2 = "$paper_font_color"; $wp = ""; $bgcolor = "#FFFFFF"; if ( $paper_wp =~ /^(http)/ ) { $wp = "$paper_wp"; } if ( $paper_wp =~ /^\#/ ) { $bgcolor = "$paper_wp"; } } sub symbol2 { if ( $symbol =~ /^d/i || $symbol =~ /^s/i || $symbol =~ /^w/i )  { $symbol2 = "$symbol"; } elsif ( $symbol eq "\\" ) { $symbol2 = "\\\\"; } else { $symbol2 = "$symbol"; $symbol2 =~ s/\$/\\\$/; } } sub home { if ( $home ) { if ( $home !~ /^(http)/ ) { $home = "$base_img_url/" . "$home"; } print "<A HREF=\"$path4\" TARGET=\"$target_name\" ><IMG SRC=\"$home\" BORDER=0 TITLE=\"$lang[80]\"></A>&nbsp;&nbsp;&nbsp; \n"; } else { print "<A HREF=\"$path4\" TARGET=\"$target_name\" ><FONT COLOR=\"$font2\" FACE=\"$font_face2\" SIZE=\"$font_size2\">$lang[80]</FONT></A>&nbsp;&nbsp;&nbsp; \n"; } } sub put_item_names_together { $n = 0; $extra_description = ""; foreach $item (@items) { if ( $n > 1 ) { ($a,$trash) = split(/$delimiter2/,$item); $extra_description = "$extra_description$a, "; } $n++; } chop($extra_description); chop($extra_description); $extra_description = ": $extra_description"; } sub put_item_names_together2 { ($is_currency,$internetsecure_language) = split(/\,/,"$card_types"); $n = 0; $extra_description = ""; $total = 0; foreach $item (@items) { if ( $n > 1 ) { $nn = $n-1; @stuff = split(/$delimiter2/,$item); @customs = (@stuff); for($i=1;$i<=5;$i++) { shift(@customs); } $quantity = $stuff[4]; $price_calc = $stuff[1]; &price_calc; $item_total = $each * $quantity; if ($item =~ /\#non.*taxable\#/i) { $nontaxable += $item_total; } if ($item =~ /\#nodiscount\#/i) { $nodiscount += $item_total; $nodiscount_items += $stuff[4]; } $total += $item_total; $extra_description .= "$each" . '::' . "$quantity" . '::' . "Prod$nn" . '::' . "$stuff[0]" . '::' . "$is_currency|"; } $n++; } $lang[116] =~ s/\://g; $lang[108] =~ s/\://g; if ( $coupon_amount ) { &coupon_amount; $nn++; $temp -= ($temp * 2); $extra_description .= "$temp" . '::' . "1" . '::' . "Prod$nn" . '::' . "$lang[116] ($coupon_amount)" . '::' . "$is_currency|"; } &webstore_discount; if ( $discount_amount ) { $total -= $discount_amount; if ( $nontaxable ) { $nontaxable -= $discount_amount; } $nn++; $discount_amount -= ($discount_amount * 2); $extra_description .= "$discount_amount" . '::' . "1" . '::' . "Prod$nn" . '::' . "$lang[108] ($disc_percent\%)" . '::' . "$is_currency|"; } $lang[44] =~ s/\://g; $lang[56] =~ s/\://g; $nn = $n-2; if ( $state ) { $nn++; $taxes = sprintf("$decimals","$taxes"); $taxes =~ s/ //g; $extra_description .= "$taxes" . '::' . "1" . '::' . "Prod$nn" . '::' . "$lang[44]" . '::' . "$is_currency|"; } if ( $ship_allow ) { $nn++; $extra_description .= "$ship_total" . '::' . "1" . '::' . "Prod$nn" . '::' . "$lang[56]" . '::' . "$is_currency|"; } chop($extra_description); $extra_description =~ s/<([^>]|\n)*>//g; } sub put_item_names_together3 { $n = 0; $extra_description = ""; foreach $item (@items) { if ( $n > 1 ) { ($a,$trash) = split(/$delimiter2/,$item); $extra_description = "$extra_description$a\n"; } $n++; } $extra_description = "\n$extra_description"; } sub cant_find_vars { if (!-e "$vars") { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but the cart can't find your <B>vars.dat</B> file at system path: <B>\"$vars\"</B></H3></CENTER><BR>"; print "<UL><LI>Make sure <B>vars.dat</B> is uploaded into the same directory as cart.pl<BR> </UL><BR>"; &footer; } } sub fix_vars { while(!$complete) { $n = 2; $still_searching = 1; while ( $still_searching ) { $still_searching = 0; foreach $line (@vars) { if ( ($line =~ /^(###)(.*?)(1\s)(.*?)(-->)/) && ($line eq "$vars[0]") ) { $line =~ s/^(###)(.*?)(1\s)(.*?)(-->)/$1$2\n$3$4$5/; $n = 2; } if ( $line =~ /(###)(.*?)(1\s.*)/ && $line !~ /^###/ ) { $line =~ s/(###)(.*?)(1\s.*)/\n$1$2\n$3/; $n = 2; } if ( $line =~ /(###)(.*?)$/ && $line !~ /^###/ && $line !~ /(.+)\n(.+)/ ) { $line =~ s/(###)(.*?)/\n$1$2/; $n = 2; } if ( $line =~ /^(###)/) { $n = 2; } $nn = $n-1; if ( $line =~ /^($nn\s)(.*?)(-->)(.*?)($n)(\s)/ ) { $line =~ s/^($nn\s)(.*?)(-->)(.*?)($n)(\s)/$1$2$3$4\n$5$6/; } if ( $line =~ /^($nn\s)/  ) { $n++; } if ( $n > 100 ) { $still_searching = 0; } } } @vars2 = (); foreach $line (@vars) { @temp = split(/\n/,$line); push(@vars2,@temp); } if ( @vars eq @vars2 ) { $complete = 1; } @vars = @vars2; } &header; print "<PRE>\n"; foreach $line (@vars) { if ($line =~ /\n/) { chop($line); } print "$line\n"; } } sub count_vars { &header; print "<PRE>\n"; $temp = ""; $n = 0; foreach $line (@vars) { $line =~ s/\</&lt;/g; if ( $line =~ /^###/ ) { $n = 0; while ($line =~ /\n/) { chop($line); } $temp .= "<FONT COLOR=blue>$n</FONT> - $line\n"; $n++; } elsif ($line =~ /-->/) { while ($line =~ /\n$/) { chop($line); } $temp .= "<FONT COLOR=blue>$n</FONT> - $line\n"; $n++; } elsif ($line !~ /^\n$/) { while ($temp =~ /\n$/) { chop($temp); } while ($line =~ /\n$/) { chop($line); } $temp .= " $line\n"; } } print "$temp\n"; } sub find_lang { if ( !$lang_path ) { $lang_path = "$vars"; $a = ""; until ($a eq "/" || $lang_path eq "") { $a = chop($lang_path); } $lang_path = "$lang_path/lang.dat"; } if (!-e "$lang_path") { $lang_path = "$script_root/lang.dat"; } if ($lang_path =~ /^http/i) { &diagnostics; &header; print "<H3>Dansie Shopping Cart configuration message:<BR>Please leave Host Variable #10 in your vars.dat file blank.</H3>"; &footer; } if (!-e "$lang_path") { &diagnostics; &header; print "<CENTER><H3>Congratulations! You've successfully uploaded the Dansie Shopping Cart and chmoded the permissions 755 or better, but the cart can't find your <B>lang.dat</B> file at system path: <B>\"$lang_path\"</B></H3></CENTER><BR>"; print "<UL><LI>Make sure <B>lang.dat</B> is uploaded into the same directory as vars.dat</UL><BR>"; &footer; } open(LANG,"$lang_path"); @lang = <LANG>; close LANG; $current_lang = 0; @lang2 = (); foreach (@lang) { while ($_ =~ /(\n|\r|\s)$/) { chop($_); } $_ =~ s/'/`/g; $_ =~ s/\\`/'/g; if ( $_ =~ /(\s?)(\d+)(.*?)(-->)(.*)/ ) { $lang2[$2] = "$5"; $current_lang = $2; } else { $lang2[$current_lang] .= " $_"; } } (@lang) = (@lang2); $lang[111] =~ s/(\<noscript)(.*)(\>)//gi; $lang[111] .= "</TABLE></TABLE></TABLE>"; } sub check_mailprog { if (!$mailprog) { print "<H5><FONT COLOR=RED>However your hosts sendmail program couldn't be automatically detected. This is likely if you are on a Windows NT host.  <UL> <LI>If your host is Unix, ask them what the system path to sendmail is and set that in Host Variable #6 in your vars.dat file. <LI>If your host is Windows NT, ask them what the system path is to either Windmail or Blat. The Dansie Shopping Cart works with Windmail or Blat on NT hosts. </UL> The correct system path needs to be set in Host Variable #6 in order for the Dansie Shopping Cart to be able to email the orders to you. See Host Variable #6 in the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=NEW>ReadMe</A> for complete details.</FONT></H5>"; } $mailprog_t = "$mailprog"; if ( ($mailprog) && (!-e "$mailprog") && ($mailprog ne "off") && ($mailprog ne "blat.exe") && ($mailprog ne "windmail.exe") && ($mailprog ne "windmail -t") && ($mailprog ne "sendmail") && ($mailprog !~ /(sendmail.exe -t)/) && ($mailprog !~ /(-f)/) && ($mailprog !~ /(-e)/) && ($mailprog !~ /(-t)/) && !$socket_smtp_server ) { print "<H5><FONT COLOR=RED>This is a warning message only. It appears that the system path to your hosts sendmail program is not set correctly in Host Variable #6 in your vars.dat file. The correct system path needs to be set in Host Variable #6 in order for the Dansie Shopping Cart to be able to email the orders to you. See Host Variable #6 in the <A HREF=\"http://www.dansie.net/cart_readme.html\" TARGET=NEW>ReadMe</A> for complete details.</FONT></H5>"; } if ($mailprog eq "off") { $mailprog = ""; } if ($socket_email_output && $socket_email_output ne "Mail Sent!" ) { print "<H5><FONT COLOR=RED>Email Server Socket Error Message: $socket_email_output</FONT></H5>"; } } sub coupon_amount { until ( $coupon_amount =~ /\d$/ || $coupon_amount =~ /\%$/ ) { chop($coupon_amount); } $coupon_amount = reverse($coupon_amount); until ( $coupon_amount =~ /\d$/ || $coupon_amount =~ /\%$/ ) { chop($coupon_amount); } $coupon_amount = reverse($coupon_amount); if ( $coupon_amount =~ /\%$/ ) { $temp = $coupon_amount; chop($temp); $temp = ( ($total - $nodiscount) * ($temp / 100) ); } else { $temp = $coupon_amount; $coupon_amount = "$symbol $coupon_amount"; if ( $temp > ($total - $nodiscount) ) { $temp = ($total - $nodiscount); } } $temp = sprintf("$decimals", $temp); $coupon_amount_shipping_calculation = "$temp"; $total -= $temp; if ( $nontaxable ) { $nontaxable -= $temp; } if ( $coupon_discount == 2 ) { $webstore_discount = ""; } } sub authorized_referrers { if ($authorized_referrers) { $http_referer = "$ENV{'HTTP_REFERER'}"; $http_referer =~ s/(http:\/\/)//i; $http_referer =~ s/(https:\/\/)//i; while ( $http_referer =~ /\// ) { chop($http_referer); } $pass_through = 0; foreach (@authorized_referrers) { if ( $http_referer =~ /($_)/i ) { $pass_through = 1; } } if (!$pass_through) { $authorized_referrers_message = 1; &list_items; exit; } } } sub currency_sep { if ($currency_sep) { $currency_sep_total = "$currency_sep_total"; $intnum = int($currency_sep_total); $dec_temp = $currency_sep_total - $intnum; $dec_temp *= (10**$decimals2); $decimals_temp = '%' . "$decimals2" . '.0f'; $dec_temp = sprintf("$decimals_temp",$dec_temp); $dec_temp =~ s/ //g; if ($dec_temp == 100) { $dec_temp = 0; $intnum ++; } while ( length($dec_temp) < $decimals2 ) { $dec_temp = "0" . "$dec_temp"; } for($i=1;$i<=length(int($currency_sep_total))/3;$i++) { if ($currency_sep_total >= (1000**$i) ) { $intlen = length($intnum); $temp1 = int($intnum/1000); $temp2 = substr($intnum,$intlen-(($i*4)-1),$intlen); $intnum = "$temp1" . "$currency_sep" . "$temp2"; } } if ($decimals2) { $currency_sep_total = "$intnum" . "." . "$dec_temp"; } else { $currency_sep_total = "$intnum"; } } } sub wrap { my $paragraph = "$_[0]"; my $wrap_length = "$_[1]"; my @lines = split(/\n/,$paragraph); my $line = ""; foreach $line (@lines) { if ( length($line) > $wrap_length ) { $line =~ s/(\S{$wrap_length})/$1\n/gi; $line =~ s/(.{0,$wrap_length})(\s|\n|$)/$1\n/gi; } while ($line =~ /\n\n$/) { chop($line); } if ($line !~ /\n$/) { $line .= "\n"; } } $paragraph = join(/\n/,@lines); return $paragraph; } sub foreign_character_replace { $_ = "$_[0]"; tr/ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½/SsYAAAAAACEEEEIIIINOOOOOUUUUYaaaaaaceeeeiiiionooooouuuuyy/; tr/ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½/ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½/; return $_; } sub redirect_mall_merchant { ($trash,$new_url) = split(/\s/,$vars[0]); if ( $ENV{'REQUEST_METHOD'} =~ /get/i ) { $redirect = "$new_url" . "?" . "$ENV{'QUERY_STRING'}"; print "Location: $redirect\n\n"; exit; } if ( $ENV{'REQUEST_METHOD'} =~ /post/i ) { read(STDIN, $buffer, $ENV{'CONTENT_LENGTH'}); @pairs = split(/&/, $buffer); foreach $pair (@pairs) { ($name, $value) = split(/=/, $pair); $value =~ tr/+/ /; $value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg; $value =~ s/~!/ ~!/g; $FORM{$name} = $value; } &header; print "$doctype<HTML>\n<BODY BGCOLOR=#FFFFFF onload=\"document.form1.submit()\"; >\n"; print "<FORM ACTION=$new_url METHOD=POST NAME=\"form1\" >\n\n"; foreach $key (sort { $a cmp $b } keys %FORM ) { print "<INPUT TYPE=HIDDEN NAME=\"$key\" VALUE=\"$FORM{$key}\">\n"; } print "\n<NOSCRIPT>\n<INPUT TYPE=SUBMIT VALUE=\"Click to Continue\">\n</NOSCRIPT>\n\n"; print "</FORM>\n"; print "</BODY>\n</HTML>\n"; exit; } } sub add_email_and_password_to_htpasswd_file { open(PW,"$htpasswd"); @old_passwords=<PW>; close(PW); $todays_ht_date = &year_month_day_date; open(PW,">$htpasswd"); $ht_line = -1; foreach $old_password (@old_passwords) { $ht_line++; if ($skip_line) { $skip_line = ""; next; } if ( $old_password =~ /^(\# )(\d{8})(\|)(\d{8})(\|)/ ) { if ( ( $todays_ht_date > $4 ) || ( $old_passwords[$ht_line+1] =~ /^($customer_email)(:)/i ) ) { $skip_line = 1; next; } } if ( $old_password =~ /^($customer_email)(:)/i ) { next; } if ( $old_password =~ /\n$/ ) { chop($old_password); } if ( $old_password ) { print PW "$old_password\n";  } } $htpasswd_date = &year_month_day_date; if ( $htpasswd_days ) { $htpasswd_exp_date = &htpasswd_exp_date($htpasswd_date,$htpasswd_days); } else { $htpasswd_exp_date = "no exp date"; } print PW "# $htpasswd_date|$htpasswd_exp_date|$customer_name|$stuff[0]\n"; print PW "$customer_email:$crypt_pw\n"; close(PW); } sub year_month_day_date { @date = localtime(time); foreach (@date) { if ( $_ < 10 ) { $_ = "0" . $_; } } $date[4]++; $date[5] += 1900; return "$date[5]$date[4]$date[3]"; } sub htpasswd_exp_date { my($date,$days) = @_; $date =~ /(\d\d\d\d)(\d\d)(\d\d)/; my($year,$month,$day) = ($1,$2,$3); $day += $days; while ( $day > 30 ) { $day -= 30; $month += 1; } while ( $month > 12 ) { $month -= 12; $year += 1; } if (length($day) < 2) { $day = "0" . "$day"; } if (length($month) < 2) { $month = "0" . "$month"; } return "$year$month$day"; } sub sl { $dd=&sl2("kte3cv"); $aa = "$0"; if (!-e "$aa") { $aa = `pwd`; chomp($aa); $temp = $ENV{SCRIPT_FILENAME}; $temp =~ /(.*)(\/)(.+)$/; $aa .= "/$3"; } if (!-e "$aa") { $aa = `pwd`; chomp($aa); $temp = $ENV{SCRIPT_FILENAME}; $temp =~ /(.*)(\/)(.+)$/; $aa .= "/$3"; } if (!-e "$aa") { $aa = $ENV{SCRIPT_FILENAME}; chomp($aa); } if (!-e "$aa") { $aa = "$ENV{DOCUMENT_ROOT}$ENV{REQUEST_URI}"; chomp($aa); } if (-e "$aa") { open(A,"$aa"); while (<A>) { $line = $_; while ( $line =~ /($dd)/gi ) { $sl++; } } close A; } @sl = ('3zidve83038vn3@5zn', 'kte3cv', 'mz5tm9z38', 'xl6@1@1@x', '5itca', '3v5jiv@38zinvi@j3'); @sl2 = (@sl); if ( (-e"$aa") && (!-d"$aa") ) { if ($sl<110) { exit; } } foreach $aa (@sl) { $aa = &sl2($aa); if ( $ENV{'HTTP_HOST'}   =~ /($aa)/i || $ENV{'SERVER_NAME'} =~ /($aa)/i || $ENV{'SERVER_ADDR'} =~ /($aa)/i || $ENV{'REMOTE_ADDR'} =~ /($aa)/i ) { $sl2 = 1; } } if ( ($ENV{'HTTP_HOST'} || $ENV{'SERVER_NAME'} || $ENV{'SERVER_ADDR'} || $ENV{'REMOTE_ADDR'})  && (!$sl2) ) { exit; } } sub sl2 { $_ = "$_[0]"; tr/a-z0-9/gvibn9wprud2lmx8z3fa4eq15oy06sjc7kth/; tr/_/-/; tr/\@/\./; return $_; } sub InsertFP { } sub get_submission { } sub merchant { } sub encode_email_address { my($address) = $_[0]; $address = reverse($address); my($new_address) = ""; my($character) = ""; while ($address) { $character = chop($address); $new_address .= "&#" . ord($character) . ";"; } return $new_address; } sub split_names { if ( $FORM{'name2'} =~ /\s/ ) { $FORM{'name2'} =~ /(.*)(\s)(.*)/; $first_name = "$1"; $last_name = "$3"; } else { $first_name = "$FORM{'name2'}"; $last_name = ""; } } sub socket_email { my $recipient = $_[0]; my $emailfrom = $_[1]; my $subject = $_[2]; my $message = $_[3]; my $smtp_server = $_[4]; my $email_content_type = $_[5]; my $email_encoding = $_[6]; ($x,$x,$x,$x, $here) = gethostbyname($null); ($x,$x,$x,$x, $there) = gethostbyname($smtp_server); my $thisserver = pack('S n a4 x8',2,0,$here); my $remoteserver = pack('S n a4 x8',2,25,$there); (!(socket(S,2,1,6))) && (return "Connect error! socket"); (!(bind(S,$thisserver))) && (return "Connect error! bind"); (!(connect(S,$remoteserver))) && (return "!! connection to $smtp_server has failed!"); select(S); $| = 1; select(STDOUT); $DATA_IN = <S>; if ($DATA_IN !~ /^220/) { return "data in Connect error - 220"; } print S "HELO localhost\r\n"; $DATA_IN = <S>; if ($DATA_IN !~ /^250/) { return "$DATA_IN - data in Connect error - 250"; } if (!$socket_return_path) { $socket_return_path = "$emailfrom"; } print S "MAIL FROM:<$socket_return_path>\r\n"; $DATA_IN = <S>; if ($DATA_IN !~ /^250/) { return "'From' address not valid"; } print S "RCPT TO:<$recipient>\r\n"; $DATA_IN = <S>; if ($DATA_IN !~ /^250/) { return "'Recipient' address not valid"; } print S "DATA\r\n"; $DATA_IN = <S>; if ($DATA_IN !~ /^354/) { return "Message send failed - 354"; } $message =~ s/\n/\r\n/g; if ($email_content_type) { print S "Content-Type: $email_content_type\r\n"; } if ($email_encoding) { print S "Content-Transfer-Encoding: $email_encoding\r\n"; } print S "From: $emailfrom\r\nTo: $recipient\r\nSubject: $subject\r\n\r\n$message\r\n.\r\n"; $DATA_IN = <S>; if ($DATA_IN !~ /^250/) { return "Message send failed - try again - 250"; } print S "QUIT\n"; return "Mail Sent!"; } sub restricted_items { foreach $restricted_item (@restrict) { chomp($restricted_item); if ( $restricted_item && $restricted_item !~ /^#/ ) { ($restricted_name,$restricted_property,$restricted_options) = split(/$delimiter2/,$restricted_item); if ( $stuff[0] eq "$restricted_name" ) { if ( $restricted_property eq "payment_options" ) { $option1 = "" unless ( $restricted_options =~ /1/ ); $option2 = "" unless ( $restricted_options =~ /2/ ); $option3 = "" unless ( $restricted_options =~ /3/ ); $option4 = "" unless ( $restricted_options =~ /4/ ); $option5 = "" unless ( $restricted_options =~ /5/ ); $option6 = "" unless ( $restricted_options =~ /6/ ); $aux_processor_payment_option = "" unless ( $restricted_options =~ /7/ ); $aux_processor2_payment_option = "" unless ( $restricted_options =~ /8/ ); } if ( $restricted_property eq "shipping_methods" ) { if ($ship_allow eq "1") { @restricted_options = split(/\,/,$restricted_options); $method_number = 0; foreach $method_temp (@method) { $method_keep = 0; foreach $option_temp (@restricted_options) { if ( ($option_temp - 1 ) == $method_number) { $method_keep = 1; } } if (!$method_keep) { $method[$method_number] = "#"; } $method_number++; } } elsif ($ship_allow eq "2") { @restricted_options = split(/\,/,$restricted_options); $method_number = 0; foreach $method_temp (@shipping_locations) { $method_keep = 0; foreach $option_temp (@restricted_options) { if ( ($option_temp - 1 ) == $method_number) { $method_keep = 1; } } if (!$method_keep) { $shipping_locations[$method_number] = "#"; } $method_number++; } } } } } } if ( ($n + 1) == @items) { if ($ship_allow eq "1") { @temp1 = (); @temp2 = (); @temp3 = (); $method_number = 0; foreach (@method) { if ($_ ne "#") { push(@temp1,$_); push(@temp2,$method_init_price[$method_number]); push(@temp3,$method_price[$method_number]); } $method_number++; } @method = @temp1; @method_init_price = @temp2; @method_price = @temp3; } elsif ($ship_allow eq "2") { @temp1 = (); @temp2 = (); $method_number = 0; foreach (@shipping_locations) { if ($_ ne "#") { push(@temp1,$_); push(@temp2,$shipping_via_amount[$method_number]); } $method_number++; } @shipping_locations = @temp1; @shipping_via_amount = @temp2; } } } sub header { if (!$mod_perl_no_headers) { print "Content-type: text/html\n\n"; } } sub prepare_and_send_pending_order_notice { if ( $pending_order ) { if ($bizname_backup) { $bizname = "$bizname_backup"; } $purchase_method = "$lang[152] - $purpose_temp"; &get_shoppers_items; $pending_order =~ s/ /\,/g; $pending_order =~ s/\,\,/\,/g; $pending_order =~ s/\,\,/\,/g; (@pending_order) = split(/\,/,"$pending_order"); foreach $myemail (@pending_order) { &send_email2('merchant'); } } } sub cambist_or_authorize_net_names { if ( $path5 =~ /(www\.authorize\.net)/i || $path5 =~ /(test\.authorize\.net)/i || $path5 =~ /(www\.quickcommerce\.net)/i ) { @secure_field = ("", "AMOUNT", "DESCRIPTION", "LOGIN", "", "INVOICE", "USER1", "DISABLERECEIPT", "x_Receipt_Link_URL", "TYPE", "CUSTID", "NAME", "ADDRESS", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "EMAIL"); &put_item_names_together; $bizname = "$bizname$extra_description"; $bizname =~ s/<([^>]|\n)*>//g; ($MerchantFontColor,$MerchantFont) = split(/\-/,$invoice); if ($invoice =~ /\-/) { ($trash,$invoice) = split(/\-/,$invoice); } $invoice =~ s/ //g; $MerchantFontColor =~ s/ //g; $MerchantBgrdColor = "TRUE"; if ( $card_types =~ /^(ao)$/i ) { $MerchantUnApprovedURL = "AO"; } else { $MerchantUnApprovedURL = ""; } $secure_field[20] = "x_Version"; $custom_processor_field[1] = "2.5"; } elsif ( $path5 =~ /(certification\.authorize\.net)/i || $path5 =~ /(secure\.authorize\.net)/i || $path5 =~ /(quickcommerce.net)/i || $path5 =~ /(quickcommerce.com)/i || $path5 =~ /(rtware\.net)/i || $path5 =~ /(verify.ishopsecure.com)/i || $path5 =~ /(secure.merchantcommerce.net)/i || $path5 =~ /(2checkout.com)/i || $path5 =~ /(planetpayment\.com)/i || $path5 =~ /(richsolutions\.com)/i || $path5 =~ /(merchantcommerce\.net)/i || $path5 =~ /(ezic\.com)/i || $path5 =~ /(ecx\.com)/i || $path5 =~ /(secure-fastcharge\.com)/i ) { @secure_field = ("", "x_Amount", "x_Description", "x_Login", "x_Merchant_Email", "x_Invoice_Num", "x_Show_Form", "x_Last_Name", "x_Receipt_Link_URL", "x_Receipt_Link_Text", "x_Cust_ID", "x_First_Name", "x_Address", "x_City", "x_State", "x_Zip", "x_Country", "x_Phone", "x_Email", "MerchantReturnURL"); $secure_field[49] = "x_Logo_URL"; $secure_field[50] = "x_company"; &put_item_names_together; $bizname_backup = "$bizname"; $bizname = "$bizname$extra_description"; $MerchantFont = "$invoice"; $MerchantFontColor = "PAYMENT_FORM"; $MerchantUnApprovedURL = "$lang[84]"; @temp = (); $MerchantBgrdColor = ""; if ( $FORM{'name2'} =~ /(.*)(\s)(.*)/ ) { $FORM{'name2'} = "$1"; $MerchantBgrdColor = "$3"; } $secure_field[20] = "DISABLERECEIPT"; $custom_processor_field[1] = "TRUE"; $secure_field[21] = "x_Version"; $custom_processor_field[2] = "3.1"; if ( $card_types =~ /(x_Type\=)(.+?)(,|\n|$)/i ) { $secure_field[24] = "x_Type"; $custom_processor_field[5] = "$2"; } else { $secure_field[24] = "x_Type"; $custom_processor_field[5] = "AUTH_CAPTURE"; } if ( $card_types =~ /^(ao)$/i ) { $secure_field[24] = "x_Type"; $custom_processor_field[5] = "AUTH_ONLY"; } if ( $card_types =~ /(demo\=)(.+?)(,|\n|$)/i ) { $secure_field[25] = "demo"; $custom_processor_field[6] = "Y"; } $secure_field[26] = "pay_method"; $custom_processor_field[7] = "CC"; if ( $card_types =~ /(txnkey\=)(.+?)(,|\n|$)/i ) { $txnkey = "$2"; $@ = ""; $pms_path = "$0"; $pms_path =~ /^(.+)(\\|\/)(.*)$/; $pms_path = "$1"; if ( (-e "$pms_path/SimLib.pm" && -e "$pms_path/SimHMAC.pm") || (-e "SimLib.pm" && -e "SimHMAC.pm") ) { eval("use SimLib;"); if ($@) { &header; print "<H2>You have SSV#9 set to use an AuthorizeNet transaction key, yet the required SimLib.pm and/or SimHMAC.pm Perl modules are corrupt. Contact AuthorizeNet technical support for assistance.<BR><BR>ERROR: $@</H2>\n"; exit; } } else { &header; print "<H2>You have SSV#9 set to use an AuthorizeNet transaction key, yet the required SimLib.pm and/or SimHMAC.pm Perl modules could not be found. Contact AuthorizeNet technical support for assistance.<BR><BR>\$0 path: $0</H2>\n\n"; exit; } $loginid = "$MerchantID"; $x_amount = $total; if (index($x_amount,'$') == 0) { $x_amount = substr($x_amount,1); } $x_description = $ENTRY{'x_description'}; $authorizenet_fingerprint = 1; } } elsif ( ( $path5 =~ /(secure\.authorize\.net)/i || $path5 =~ /(secure.quickcommerce.net)/i ) && $never == 100000 ) { @secure_field = ("", "x_Amount", "x_Description", "x_Login", "x_Merchant_Email", "x_Invoice_Num", "x_Show_Form", "x_Last_Name", "x_ADC_URL", "failureURL", "x_Cust_ID", "x_First_Name", "x_Address", "x_City", "x_State", "x_Zip", "x_Country", "x_Phone", "x_Email", "MerchantReturnURL"); &put_item_names_together; $bizname = "$bizname$extra_description"; $MerchantFont = "$invoice"; $MerchantFontColor = "PAYMENT_FORM"; $MerchantUnApprovedURL = "$lang[84]"; ($FORM{'name2'},$MerchantBgrdColor) = split(/ /,$FORM{'name2'}); if (!$MerchantBgrdColor) { $MerchantBgrdColor = "$FORM{'name2'}"; } $secure_field[20] = "x_Version"; $custom_processor_field[1] = "3.0"; $secure_field[21] = "x_ADC_Relay_Response"; $custom_processor_field[2] = "TRUE"; $secure_field[22] = "USER1"; $custom_processor_field[3] = "$invoice"; } elsif ( $path5 =~ /(www\.1internetave\.com)/i ) { @secure_field = ("", "sessionID", "MerchantName", "customerID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "ref_num", "name", "address", "city", "state", "zip", "BillCountry", "BillPhone", "BillEmail"); $total *= 10000; $total += 2561024512; } elsif ( $path5 =~ /(internetsecure\.com)/i ) { @secure_field = ("", "Products", "MerchantName", "MerchantNumber", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ReturnURL", "unapproved", "customerid", "xxxName", "xxxAddress", "xxxCity", "xxxProvince", "xxxPostal", "xxxCountry", "xxxPhone", "xxxEmail"); &put_item_names_together2; $total = "$extra_description"; $secure_field[50] = "xxxCompany"; $secure_field[20] = "language"; $custom_processor_field[1] = "$internetsecure_language"; $FORM{'state2'} =~ s/(.{2})(.*)/$1/; $FORM{'country2'} =~ s/(.{2})(.*)/$1/; } elsif ( $path5 =~ /(ctrldvcs\.com)/i || $path5 =~ /(eprocessingnetwork\.com)/i ) { @secure_field = ("", "fulltotal", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail"); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; } elsif ( $path5 =~ /(commercepay\.com)/i ) { @secure_field = ("", "amount", "MerchantName", "cpid", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "resulturl", "MerchantUnApprovedURL", "orderid", "name", "address", "city", "state", "zip", "country", "user1", "custemail"); $invoice =~ s/ //g; $invoice =~ s/-//g; } elsif ( $path5 =~ /(secure\.vanserv\.com)/i  ) { @secure_field = ("", "P", "N", "MID", "MerchantEmail", "T", "Q", "D", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail"); &put_item_names_together; $MerchantFont = "No"; $MerchantFontColor = "1"; ($bizname,$MerchantBgrdColor) = split(/\:/,$bizname); } elsif ( $path5 =~ /(www\.eft\.com)/i  ) { @secure_field = ("", "Submit_Amount", "Submit_Description", "Submit_MerchantID", "MerchantEmail", "Submit_Response_Action", "Submit_Text_Color", "Submit_Back_Color", "Submit_ReturnURL_Approved", "Submit_ReturnURL_Declined", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL"); &put_item_names_together; $MerchantFont = "POST"; } elsif ( $path5 =~ /(\.anacom\.com)/i ) { @secure_field = ("", "fulltotal", "MerchantName", "MerchantID", "NotifyEmail", "direct", "MerchantFontColor", "MerchantBgrdColor", "returnlink", "MerchantUnApprovedURL", "ordernumber", "ccname", "baddress", "bcity", "bstate", "bzip", "bcountry", "bphone", "email", "MerchantReturnURL"); $MerchantFont = "no"; $secure_field[20] = "autoredirect"; $custom_processor_field[1] = "yes"; } elsif ( $path5 =~ /(nobil\.com)/i ) { @secure_field = ("", "amt", "MerchantName", "merchID", "MerchantEmail", "NSUBMIT", "MerchantFontColor", "MerchantBgrdColor", "successurl", "failurl", "mtID", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL"); $MerchantFont = "Submit"; $total =~ s/ //g; } elsif ( $path5 =~ /(e-plastic\.com)/i ) { @secure_field = ("", "amount", "MerchantName", "merchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "orderID", "billName", "shipAddress", "shipCity", "shipState", "shipZip", "shipCountry", "BillPhone", "BillEmail", "MerchantReturnURL"); } elsif ( $path5 =~ /(secureweb\.outreach\.com)/i ) { @secure_field = ("", "chargetotal", "MerchantName", "storename", "MerchantEmail", "mode", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "oid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL"); $MerchantFont = "payonly"; } elsif ( $path5 =~ /(merchantonline\.com)/i ) { @secure_field = ("", "trans_amount", "ALIAS", "account", "MerchantEmail", "mode", "lastname", "MerchantBgrdColor", "next_url", "MerchantUnApprovedURL", "username", "firstname", "address1", "city", "state", "zip", "country", "home_phone", "email", "MerchantReturnURL"); $MerchantFont = "remote"; ($FORM{'name2'},$MerchantFontColor) = split(/ /,$FORM{'name2'}); if (!$MerchantFontColor) { $MerchantFontColor = "$FORM{'name2'}"; } $secure_field[20] = "user1"; $custom_processor_field[1] = "POST"; $secure_field[21] = "passthru1"; $custom_processor_field[2] = "$shopper_id"; } elsif ( $path5 =~ /(secureweb\.clearcommerce\.com)/i || $path5 =~ /(linkpt\.net)/i || $path5 =~ /(linkpointcentral\.com)/i ) { @secure_field = ("", "chargetotal", "", "storename", "MerchantEmail", "mode", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "oid", "bname", "baddr1", "bcity", "bstate", "bzip", "bcountry", "phone", "email", "referurl"); $MerchantFont = "payplus"; $MerchantFont = "payonly"; $secure_field[21] = "bcountry2"; $custom_processor_field[2] = "$FORM{'country2'}"; $secure_field[23] = "scountry2"; $custom_processor_field[4] = "$FORM{'country2'}"; $secure_field[24] = "txntype"; $custom_processor_field[5] = "sale"; if ( $card_types =~ /(txntype\=)(.+?)(,|\n|$)/i ) { $secure_field[24] = "txntype"; $custom_processor_field[5] = "$2"; } if ( $card_types =~ /(txnmode\=)(.+?)(,|\n|$)/i ) { $secure_field[25] = "txnmode"; $custom_processor_field[6] = "$2"; } if ( $card_types =~ /(^|,)(mode\=)(.+?)(,|\n|$)/i ) { $MerchantFont = "$3"; } $secure_field[50] = "bcompany"; } elsif ( $path5 =~ /(secure\.redi-check\.com)/i || $path5 =~ /(itransact\.com)/i || $path5 =~ /(paymentclearing\.com)/i ) { @secure_field = ("", "1-cost", "mername", "vendor_id", "1-qty", "acceptcards", "ret_mode", "last_name", "ret_addr", "MerchantUnApprovedURL", "1-desc", "first_name", "address", "city", "state", "zip", "country", "phone", "email", "home_page"); $MerchantFont = "1"; if ( $card_types =~ /(post)/i ) { $MerchantFontColor = "post"; } elsif ( $card_types =~ /(redirect)/i ) { $MerchantFontColor = "redirect"; } else { $secure_field[6] = ""; } if ( $card_types =~ /(acceptchecks)/i ) { $secure_field[20] = "acceptchecks"; $custom_processor_field[1] = "1"; } if ( $card_types =~ /(preauth)/i ) { $secure_field[21] = "preauth"; $custom_processor_field[2] = "1"; } $secure_field[22] = "showcvv"; $custom_processor_field[3] = "1"; $temp = "$FORM{'name2'}"; $temp = reverse($temp); while ($temp =~ /\s/) { chop($temp); } $temp = reverse($temp); $MerchantBgrdColor = "$temp"; $temp = "$FORM{'name2'}"; if ( $temp =~ /\s/ ) { until ( $a eq " " ) { $a = chop($temp); } $FORM{'name2'} = "$temp" ; } if (!$MerchantBgrdColor) { $MerchantBgrdColor = "$FORM{'name2'}"; } $invoice = "$lang[158] $invoice"; $email_cc_numbers = "1"; $total =~ s/ //g; if ($ssl_target_page) { $cambist_back = "$ssl_target_page"; } else { $cambist_back = "$path4"; } } elsif ( $path5 =~ /(ValidCheck\.com)/i ) { @secure_field = ("", "TA", "MerchantName", "VID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL"); $MerchantID = "$i_check_id"; } elsif ( $path5 =~ /(secure\.gorealtime\.com)/i ) { @secure_field = ("", "Amount", "MerchantName", "EPP_ID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ReturnURL", "ReturnURL_FALSE", "InvoiceNum", "buyerName", "buyerAdd1", "buyerCity", "buyerST", "buyerZIP", "BillCountry", "BillPhone", "buyerEmail", "MerchantReturnURL"); } elsif ( $path5 =~ /(secure\.bises\.org)/i ) { @secure_field = ("", "fee", "MerchantName", "client", "cliemail", "rn1", "MerchantFontColor", "MerchantBgrdColor", "url", "MerchantUnApprovedURL", "refno1", "name", "addr", "city", "state", "code", "country", "phone", "email", "MerchantReturnURL"); $MerchantFont = "d"; $FORM{'address2'} .= "\n$FORM{'city2'}\n$FORM{'state2'}\n$FORM{'zip2'}\n$FORM{'country2'}"; } elsif ( $path5 =~ /(secpay\.com)/i ) { @secure_field = ("", "amount", "mpi_merchant_name", "merchant", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "callback", "backcallback", "trans_id", "bill_name", "bill_addr_1", "bill_city", "bill_state", "bill_post_code", "bill_country", "bill_tel", "bill_email", "bill_url"); $secure_field[50] = "bill_company"; $secure_field[20] = "customer"; $custom_processor_field[1] = "$FORM{'name2'}"; &put_item_names_together; $secure_field[21] = "mpi_description"; $custom_processor_field[2] = "$invoice$extra_description"; $secure_field[22] = "mpi_merchant_url"; $custom_processor_field[3] = "$path4"; } elsif ( $path5 =~ /(paymentprocessor\.net)/i ) { @secure_field = ("", "AMOUNT", "DESCRIPTION", "LOGIN", "", "INVOICE", "USER1", "DISABLERECEIPT", "ApprovalURL", "DeclinedURL", "CUSTID", "NAME", "ADDRESS", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "EMAIL"); &put_item_names_together; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; $bizname = "$biz_temp$extra_description"; ($MerchantFontColor,$MerchantFont) = split(/\-/,$invoice); if ($invoice =~ /\-/) { ($trash,$invoice) = split(/\-/,$invoice); } $invoice =~ s/ //g; $MerchantFontColor =~ s/ //g; $MerchantBgrdColor = "TRUE"; } elsif ( $path5 =~ /(chargesolutions\.com)/i ) { @secure_field = ("", "trans_amount", "ALIAS", "merchant_account", "MerchantEmail", "BASEFONT", "user1", "mode", "next_url", "MerchantUnApprovedURL", "username", "firstname", "address1", "city", "state", "zip", "country", "home_phone", "email", "lastname"); $MerchantFontColor = "remote"; $MerchantBgrdColor = "remote"; ($FORM{'name2'},$cambist_back) = split(/ /,$FORM{'name2'}); if (!$cambist_back) { $cambist_back = "$FORM{'name2'}"; } } elsif ( $path5 =~ /(mydirectpay\.cgi)/i ) { @secure_field = ("", "price", "MerchantName", "STORE_NAME", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "fulfillment_url", "failure_url", "order_id", "card_name", "card_address", "card_city", "card_state", "card_zip", "card_country", "card_phone", "card_email", "MerchantReturnURL"); } elsif ( $path5 =~ /(gochargeit\.com)/i ) { @secure_field = ("", "AMOUNT", "F_DESC", "route", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "F_TICKET", "F_CCNAME", "F_CCADDR", "F_CCCITY", "F_CCSTATE", "F_CCZIP", "BillCountry", "BillPhone", "f_email", "MerchantReturnURL"); } elsif ( $path5 =~ /(creditnet\.com)/i ) { @secure_field = ("", "trans_amount", "ALIAS", "account", "MerchantEmail", "BASEFONT", "user1", "mode", "next_url", "MerchantUnApprovedURL", "username", "firstname", "address1", "city", "state", "zip", "country", "home_phone", "email", "lastname"); $MerchantFontColor = "remote"; $MerchantBgrdColor = "remote"; ($FORM{'name2'},$cambist_back) = split(/ /,$FORM{'name2'}); if (!$cambist_back) { $cambist_back = "$FORM{'name2'}"; } $secure_field[50] = "company"; } elsif ( $path5 =~ /(signio\.com)/i ) { @secure_field = ("", "AMOUNT", "ALIAS", "LOGIN", "MerchantEmail", "mode", "lastname", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "INVOICE", "NAME", "ADDRESS", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "EMAIL", "MerchantReturnURL"); $secure_field[20] = "MFCIsapiCommand"; $custom_processor_field[1] = "orders"; if ( $card_types =~ /^(A)$/i ) { $secure_field[23] = "TYPE"; $custom_processor_field[4] = "A"; } elsif ( $card_types =~ /(,D)/ || $card_types =~ /(D,)/ || $card_types =~ /^(D)$/ ) { $secure_field[23] = "TYPE"; $custom_processor_field[4] = "D"; } else { $secure_field[21] = "TYPE"; $custom_processor_field[2] = "AUTH_CAPTURE"; } $secure_field[22] = "METHOD"; $custom_processor_field[3] = "CC"; if ( $FORM{'purpose2'} eq "check_transfer" ) { $secure_field[22] = "METHOD"; $custom_processor_field[3] = "ECHECK"; } $secure_field[23] = "PARTNER"; $custom_processor_field[4] = "VeriSign"; } elsif ( $path5 =~ /(verisign\.com)/i || $path5 =~ /(payflowlink\.paypal\.com)/i ) { @secure_field = ("", "AMOUNT", "ALIAS", "LOGIN", "MerchantEmail", "mode", "lastname", "MerchantBgrdColor", "RETURNURL", "MerchantUnApprovedURL", "INVOICE", "NAME", "ADDRESS", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "EMAIL", "MerchantReturnURL"); $secure_field[20] = "MFCIsapiCommand"; $custom_processor_field[1] = "orders"; if ( $card_types =~ /(,A)/ || $card_types =~ /(A,)/ || $card_types =~ /^(A)$/ ) { $secure_field[23] = "TYPE"; $custom_processor_field[4] = "A"; } elsif ( $card_types =~ /(,D)/ || $card_types =~ /(D,)/ || $card_types =~ /^(D)$/ ) { $secure_field[23] = "TYPE"; $custom_processor_field[4] = "D"; } else { $secure_field[23] = "TYPE"; $custom_processor_field[4] = "S"; } if ( $FORM{'purpose2'} eq "check_transfer" ) { if ( $card_types =~ /(partner\=)(.+)/ ) { $secure_field[22] = "PARTNER"; $custom_processor_field[3] = "$2"; while ( $custom_processor_field[3] =~ /\,/ ) { chop($custom_processor_field[3]); } } else { $secure_field[22] = "PARTNER"; $custom_processor_field[3] = "telecheck"; } $secure_field[24] = "METHOD"; $custom_processor_field[5] = "K"; $secure_field[23] = "TYPE"; $custom_processor_field[4] = "S"; } else { if ( $card_types =~ /(partner\=)(.+)/ ) { $secure_field[22] = "PARTNER"; $custom_processor_field[3] = "$2"; while ( $custom_processor_field[3] =~ /\,/ ) { chop($custom_processor_field[3]); } } else { $secure_field[22] = "PARTNER"; $custom_processor_field[3] = "VeriSign"; } $secure_field[24] = "METHOD"; $custom_processor_field[5] = "CC"; } $secure_field[25] = "SHOWCONFIRM"; $custom_processor_field[6] = "FALSE"; $invoice = reverse($invoice); while ( length($invoice) > 20 ) { chop($invoice); } $invoice = reverse($invoice); } elsif ( $path5 =~ /(intermedia\.com\.pe)/i ) { @secure_field = ("", "precio", "descripcion", "cod", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "final", "retorno", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $secure_field[20] = "editable"; $custom_processor_field[1] = "no"; $secure_field[21] = "cantidad"; $custom_processor_field[2] = "1"; $secure_field[22] = "moneda"; $custom_processor_field[3] = "1"; $secure_field[23] = "especial"; $custom_processor_field[4] = "no"; $processor_post_method = "GET"; } elsif ( $path5 =~ /(cabag\.ch)/i ) { @secure_field = ("", "price", "MerchantName", "client_id", "MerchantEmail", "MerchantFont", "currency", "MerchantBgrdColor", "ok_site", "failt_site", "session_id", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $MerchantFontColor = "CHF"; $total *= 100; } elsif ( $path5 =~ /(secure\.hurstlinks\.net)/i ) { @secure_field = ("", "cubecarda", "MerchantName", "cubecardm", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "cubecardsuccess", "cubecardcancel", "cubecardo", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; } elsif ( $path5 =~ /(worldpay\.com\/payments\/select)/i ) { @secure_field = ("", "cost1", "custom1", "store", "custom2", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "returnref", "extern_u2", "custom3", "name", "adr1", "adr2", "adr3", "pcde", "adr4", "custom4", "mail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $secure_field[20] = "qty1"; $custom_processor_field[1] = "1"; $secure_field[21] = "desc1"; $custom_processor_field[2] = "$lang[57]"; if ( $card_types =~ /(testmode)/i ) { $secure_field[27] = "testMode"; $custom_processor_field[7] = "100"; $card_types =~ s/(testmode)//gi; $card_types =~ s/\,//g; $card_types =~ s/\s//g; } $temp_symbol = "$card_types"; $secure_field[22] = "cur1"; $custom_processor_field[3] = "$temp_symbol"; $secure_field[23] = "cname"; $custom_processor_field[4] = "$temp_symbol"; $secure_field[24] = "code1"; $custom_processor_field[5] = "example"; $secure_field[25] = "max"; $custom_processor_field[6] = "10"; } elsif ( $path5 =~ /(select\.worldpay\.com\/wcc\/purchase)/i || $path5 =~ /(rbsworldpay\.com\/wcc\/purchase)/i || $path5 =~ /(worldpay\.com)/i ) { @secure_field = ("", "cost", "custom1", "instId", "custom2", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "returnref", "extern_u2", "cartId", "name", "address", "adr2", "adr3", "postcode", "country", "tel", "email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $secure_field[20] = "qty1"; $custom_processor_field[1] = "1"; $secure_field[21] = "desc1"; $custom_processor_field[2] = "$lang[57]"; if ( $card_types =~ /(testmode\=)(.+?)(,|\n|$)/i ) { $secure_field[27] = "testMode"; $custom_processor_field[8] = "$2"; } elsif ( $card_types =~ /(testmode)/i ) { $secure_field[27] = "testMode"; $custom_processor_field[8] = "100"; } if ( $card_types =~ /(currency\=)(.+?)(,|\n|$)/i ) { $secure_field[22] = "currency"; $custom_processor_field[3] = "$2"; } elsif ( $card_types =~ /USD/ ) { $secure_field[22] = "currency"; $custom_processor_field[3] = "USD"; } elsif ( $card_types =~ /GBP/ ) { $secure_field[22] = "currency"; $custom_processor_field[3] = "GBP"; } elsif ( $card_types =~ /AUD/ ) { $secure_field[22] = "currency"; $custom_processor_field[3] = "AUD"; } if ( $card_types =~ /(authMode\=)(.+?)(,|\n|$)/i ) { $secure_field[27] = "authMode"; $custom_processor_field[8] = "$2"; } if ( $card_types =~ /(accId1\=)(.+?)(,|\n|$)/i ) { $secure_field[28] = "accId1"; $custom_processor_field[9] = "$2"; } $secure_field[23] = "cname"; $custom_processor_field[4] = "$temp_symbol"; $secure_field[24] = "code1"; $custom_processor_field[5] = "example"; $secure_field[25] = "max"; $custom_processor_field[6] = "10"; $secure_field[26] = "desc"; $custom_processor_field[7] = "$lang[158] $invoice"; $FORM{'address2'} .= "\n$FORM{'city2'}\n$FORM{'state2'}"; } elsif ( $path5 =~ /(bamart\.com)/i ) { @secure_field = ("", "ioc_order_total_amount", "MerchantName", "ioc_merchant_id", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "ioc_merchant_order_id", "", "ecom_billto_postal_street_line1", "ecom_billto_postal_city", "ecom_billto_postal_stateprov", "ecom_billto_postal_postalcode", "ecom_billto_postal_countrycode", "Ecom_BillTo_Telecom_Phone_Number", "ecom_billto_online_email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; &split_names; $custom_processor_field[1] = "$first_name"; $custom_processor_field[2] = "$last_name"; $secure_field[20] = "ecom_billto_postal_name_first"; $secure_field[21] = "ecom_billto_postal_name_last"; if ( $card_types =~ /(ioc_auto_settle_flag\=)(.+?)(,|\n|$)/i ) { $secure_field[22] = "ioc_auto_settle_flag"; $custom_processor_field[3] = "$2"; } } elsif ( $path5 =~ /(216\.184\.194\.135)/i ) { @secure_field = ("", "Price", "MerchantName", "ID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "URL", "MerchantUnApprovedURL", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; } elsif ( $path5 =~ /(eway\.com\.au)/i ) { @secure_field = ("", "ewayTotalAmount", "ewaySiteTitle", "ewayCustomerID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ewayURL", "MerchantUnApprovedURL", "ewayCustomerInvoiceRef", "BillName", "ewayCustomerAddress", "BillCity", "BillState", "ewayCustomerPostcode", "BillCountry", "BillPhone", "ewayCustomerEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; ($custom_processor_field[1],$custom_processor_field[2]) = split(/ /,$FORM{'name2'}); $secure_field[20] = "ewayCustomerFirstName"; $secure_field[21] = "ewayCustomerLastName"; $total *= 100; } elsif ( $path5 =~ /(totalpay\.net)/i ) { @secure_field = ("", "tran_total_amount", "MerchantName", "mer_umid", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "sys_return_url", "MerchantUnApprovedURL", "tran_invoice_num", "cust_bill_name", "cust_bill_address1", "cust_bill_city", "cust_bill_state", "cust_bill_zip", "cust_bill_country", "cust_phone_num", "cust_email_address", "MerchantReturnURL", "", "", "", "", ""); $secure_field[20] = "sys_secure_form"; $custom_processor_field[1] = "TRUE"; $secure_field[21] = "sys_process_output"; $custom_processor_field[2] = "1"; $secure_field[22] = "sys_payment_method"; $custom_processor_field[3] = "1"; $secure_field[50] = "company"; } elsif ( $path5 =~ /(paypal\.com)/ && $path5 !~ /(payflowlink\.paypal\.com)/i ) { @secure_field = ("", "amount", "MerchantName", "business", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "return", "cancel_return", "item_number", "first_name_bogus", "address1", "city", "state", "zip", "BillCountry", "phone", "email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "image_url"; $secure_field[50] = "company"; $secure_field[20] = "cmd"; $custom_processor_field[1] = "_ext-enter"; $temp_item_name = "$lang[158] $invoice"; $secure_field[21] = "item_name"; $custom_processor_field[2] = "$temp_item_name"; &split_names; $secure_field[22] = "first_name"; $custom_processor_field[3] = "$first_name"; $secure_field[23] = "last_name"; $custom_processor_field[4] = "$last_name"; $secure_field[24] = "night_phone_a"; $secure_field[25] = "night_phone_b"; $secure_field[26] = "night_phone_c"; $phone_paypal_orig = $FORM{'phone2'}; $FORM{'phone2'} =~ s/\D//g; if ( $FORM{'phone2'} =~ /(\d{3})(\d{3})(\d+)/ ) { ($custom_processor_field[5],$custom_processor_field[6],$custom_processor_field[7]) = ($1,$2,$3); } else { $custom_processor_field[5] = $phone_paypal_orig; } if ( $card_types =~ /(currency_code\=)(.+?)(,|\n|$)/i ) { $secure_field[27] = "currency_code"; $custom_processor_field[8] = "$2"; } else { $secure_field[27] = "currency_code"; $custom_processor_field[8] = "USD"; } $secure_field[28] = "redirect_cmd"; $custom_processor_field[9] = "_xclick"; if ( $card_types =~ /(lc\=)(.+?)(,|\n|$)/i ) { $secure_field[29] = "lc"; $custom_processor_field[10] = "$2"; } else { $secure_field[29] = "lc"; $custom_processor_field[10] = "US"; } if ( $card_types =~ /(no_shipping\=)(.+?)(,|\n|$)/i ) { $secure_field[30] = "no_shipping"; $custom_processor_field[11] = "$2"; } else { $secure_field[30] = "no_shipping"; $custom_processor_field[11] = "0"; } $secure_field[31] = "rm"; $custom_processor_field[12] = "2"; if ( $card_types =~ /(ah\=)(.+?)(,|\n|$)/i ) { $secure_field[32] = "ah"; $custom_processor_field[13] = "$2"; } if ( $card_types =~ /(cbt\=)(.+?)(,|\n|$)/i ) { $secure_field[33] = "cbt"; $custom_processor_field[14] = "$2"; } } elsif ( $path5 =~ /(internetcash\.com)/i ) { @secure_field = ("", "IC_amount", "MerchantName", "IC_merchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "IC_merchTransID", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $temp_item_name = "$lang[158] $invoice"; $secure_field[20] = "IC_currencyCode"; $custom_processor_field[1] = "USD"; $secure_field[21] = "IC_embeded"; $custom_processor_field[2] = "true"; $secure_field[22] = "sys_payment_method"; $custom_processor_field[3] = "1"; $secure_field[23] = "IC_description"; $custom_processor_field[4] = "$temp_item_name"; $secure_field[24] = "IC_location"; $custom_processor_field[5] = "$card_types"; } elsif ( $path5 =~ /(securepay\.com)/i ) { @secure_field = ("", "fulltotal", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $secure_field[20] = "FMETHOD"; $custom_processor_field[1] = "NO"; } elsif ( $path5 =~ /(payready\.net)/i ) { @secure_field = ("", "txtTotalAmount", "txtorderDescription", "txtPayReadyID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "txtConsumerLastName", "txtSuccessLinkURL", "txtFailureLinkURL", "txtConsumerID", "txtConsumerFirstName", "txtBillingStreet", "txtBillingCity", "txtBillingState", "txtBillingZip", "txtBillingCountry", "txtBillingPhone", "txtEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; ($FORM{'name2'},@temp) = split(/ /,$FORM{'name2'}); if (@temp) { $MerchantBgrdColor = "@temp"; } else { $MerchantBgrdColor = "$FORM{'name2'}"; } $secure_field[20] = "txtInvoiceNumber"; $custom_processor_field[1] = "$invoice"; } elsif ( $path5 =~ /(chexpedite)/i ) { @secure_field = ("", "TOTAL", "MerchantName", "MID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "SuccessURL", "FailureURL", "M1", "BILLNAME", "BILLADDRESS1", "BILLCITY", "BILLREGION", "BILLPOSTALCODE", "BILLCOUNTRY", "BILLDAYPHONE", "BILLEMAIL", "CancelOrderURL", "", "", "", "", ""); $secure_field[50] = "company"; $MerchantID = "$i_check_id"; } elsif ( $path5 =~ /(intellipay\.net)/i ) { @secure_field = ("", "AMOUNT", "MerchantName", "LOGIN", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "SILENTPOSTURL", "MerchantUnApprovedURL", "INVOICE", "NAME", "ADDRESS", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "EMAIL", "MerchantReturnURL", "", "", "", "", ""); $secure_field[20] = "PAYMENTPAGE"; $custom_processor_field[1] = "CreditCardPaymentPage"; $secure_field[21] = "RECEIPTFORMAT"; $custom_processor_field[2] = "LinkSmartReceiptPage"; $secure_field[22] = "CUSTID"; $custom_processor_field[3] = "$invoice"; $secure_field[23] = "PASSWORD"; $custom_processor_field[4] = "$card_types"; $secure_field[24] = "COMPANY"; $custom_processor_field[5] = "$FORM{'company2'}"; } elsif ( $path5 =~ /(arvic.com)/i ) { @secure_field = ("", "ASC_amnt", "MerchantName", "ASC_internalID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ASC_ResultURL", "MerchantUnApprovedURL", "ASC_ref", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; if ( $card_types =~ /(ASC_term\=)(.+?)(,|\n|$)/i ) { $secure_field[23] = "ASC_term"; $custom_processor_field[4] = "$2"; } if ( $card_types =~ /(ASC_Subject\=)(.+?)(,|\n|$)/i ) { $secure_field[24] = "ASC_Subject"; $custom_processor_field[5] = "$2"; } if ( $card_types =~ /(ASC_ttype\=)(.+?)(,|\n|$)/i ) { $secure_field[25] = "ASC_ttype"; $custom_processor_field[6] = "$2"; } else { $secure_field[25] = "ASC_ttype"; $custom_processor_field[6] = "Sale"; } } elsif ( $path5 =~ /(iongate\.com)/i ) { @secure_field = ("", "AMOUNT", "MerchantName", "LOGIN", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "receiptURL", "MerchantUnApprovedURL", "INVOICENO", "CARDNAME", "ADDRESS", "CITY", "STATE", "ZIP", "COUNTRY", "PHONE", "EMAIL", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $secure_field[20] = "DESCRIPTION"; $custom_processor_field[1] = "$lang[158] $invoice"; $secure_field[21] = "CUSTNO"; $custom_processor_field[2] = "n/a"; } elsif ( $path5 =~ /(netbanx\.com)/i ) { @secure_field = ("", "payment_amount", "merchant", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "cardholder_name", "BillStreet", "BillCity", "BillState", "postcode", "BillCountry", "BillPhone", "email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; if ( $card_types =~ /visa/i || $card_types =~ /switch/i || $card_types eq "" ) { $card_types = "GBP"; } $secure_field[20] = "currency_code"; $custom_processor_field[1] = "$card_types"; } elsif ( $path5 =~ /(203.23.29.29)/i ) { @secure_field = ("", "FinalPrice", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ReturnHTTP", "MerchantUnApprovedURL", "UID", "ReturnHTTP", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "Email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "CompanyName"; } elsif ( $path5 =~ /(PayByCheck\.com)/i ) { @secure_field = ("", "a", "MerchantName", "id", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "s", "f", "item", "name", "address1", "city", "state", "zip", "BillCountry", "phone", "email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; $memo = "$biz_temp - $memo"; $secure_field[20] = "memo"; $custom_processor_field[1] = "$memo"; $invoice = "$lang[53]" . " $invoice" } elsif ( $path5 =~ /(secure-server-hosting\.com)/i ) { @secure_field = ("", "transactionamount", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "cardholdersname", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "cardholdersemail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; $secure_field[20] = "secuitems"; $custom_processor_field[1] = "[1&#124;&#124;nul&#124;1&#124;1&#124;1]"; if ( $card_types =~ /(shreference\=)(.+?)(,|\n|$)/i ) { $secure_field[23] = "shreference"; $custom_processor_field[4] = "$2"; } if ( $card_types =~ /(checkcode\=)(.+?)(,|\n|$)/i ) { $secure_field[24] = "checkcode"; $custom_processor_field[5] = "$2"; } if ( $card_types =~ /(filename\=)(.+?)(,|\n|$)/i ) { $secure_field[25] = "filename"; $custom_processor_field[6] = "$2"; } } elsif ( $path5 =~ /(skipjackic\.com)/i ) { @secure_field = ("", "Transactionamount", "text_company_name", "Serialnumber", "MerchantEmail", "page_text_font", "page_text_color", "page_background_color", "Thankyou or URL", "Invalid or URL", "Ordernumber", "sjname", "Streetaddress", "City", "State", "Zipcode", "Country", "Shiptophone", "Email", "", "", "", "", "", ""); $secure_field[50] = "company"; } elsif ( $path5 =~ /(securetrading\.net)/i ) { @secure_field = ("", "inputamount", "merchantname", "merchant", "merchantemail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "merchantapprovedurl", "merchantunapprovedurl", "orderref", "name", "address", "town", "county", "postcode", "country", "telephone", "email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; $secure_field[20] = "settlementday"; $custom_processor_field[1] = "1"; $secure_field[21] = "customeremail"; $custom_processor_field[2] = "1"; if ( $card_types =~ /(currency\=)(.+?)(,|\n|$)/i ) { $secure_field[23] = "currency"; $custom_processor_field[4] = "$2"; } else { $secure_field[23] = "currency"; $custom_processor_field[4] = "gbp"; } } elsif ( $path5 =~ /(way2pay\.nl)/i ) { @secure_field = ("", "AMT", "merchantname", "MERID", "merchantemail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "SURL", "FURL", "TID", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; $secure_field[20] = "settlementday"; $custom_processor_field[1] = "1"; $secure_field[21] = "customeremail"; $custom_processor_field[2] = "1"; if ( $card_types =~ /(MNAME\=)(.+?)(,|\n|$)/i ) { $secure_field[23] = "MNAME"; $custom_processor_field[4] = "$2"; } if ( $card_types =~ /(ITEMNAME\=)(.+?)(,|\n|$)/i ) { $secure_field[24] = "ITEMNAME"; $custom_processor_field[5] = "$2"; } $total =~ s/ //g; $total =~ s/\./\,/g; } elsif ( $path5 =~ /(merchantamerica\.com)/i || $path5 =~ /(echo-inc\.com)/i ) { $a = '3tsvht0@ev8'; $a = &sl2($a); if ( $ENV{'HTTP_HOST'}   =~ /($a)/i || $ENV{'SERVER_NAME'} =~ /($a)/i || $ENV{'SERVER_ADDR'} =~ /($a)/i || $ENV{'REMOTE_ADDR'} =~ /($a)/i ) { $ua = 1; } if (!$ua) { @secure_field = ("", "grand_total", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customer_id", "BillName", "billing_address", "billing_city", "billing_state", "billing_zip", "billing_country", "billing_phone", "billing_email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "billing_company"; $total =~ s/ //g; &split_names; $secure_field[20] = "billing_first_name"; $custom_processor_field[1] = "$first_name"; $secure_field[21] = "billing_last_name"; $custom_processor_field[2] = "$last_name"; } } elsif ( $path5 =~ /(PriceNet.com.au)/i ) { @secure_field = ("", "total_amount", "merchant", "merchant_name", "email", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "return_url", "MerchantUnApprovedURL", "order_id", "customer_name", "customer_street", "customer_city", "customer_state", "customer_zip", "customer_country", "customer_phone", "customer_email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; $total =~ s/ //g; $MerchantApprovedURL = "$path3"; $secure_field[20] = "order_details"; $custom_processor_field[1] = "$lang[158] $invoice"; } elsif ( $path5 =~ /(luottokunta\.fi)/i ) { @secure_field = ("", "amount", "MerchantName", "merchant_rn", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "success_url", "failure_url", "order_rn", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; $total =~ s/ //g; $total *= 100; $secure_field[20] = "version"; $custom_processor_field[1] = "1.2"; $secure_field[21] = "amount_exp"; $custom_processor_field[2] = "-2"; $secure_field[22] = "currency"; $custom_processor_field[3] = "978"; $secure_field[23] = "trans_method"; $custom_processor_field[4] = "0"; &put_item_names_together3; $biz_temp = "$bizname"; $biz_temp =~ s/<([^>]|\n)*>//g; $extra_description = "$biz_temp$extra_description"; $secure_field[24] = "order_description"; $custom_processor_field[5] = "$extra_description"; if ( $card_types =~ /(language\=)(.+?)(,|\n|$)/i ) { $secure_field[25] = "language"; $custom_processor_field[6] = "$2"; } if ( $card_types =~ /(success_url\=)(.+?)(,|\n|$)/i ) { $secure_field[26] = "success_url"; $custom_processor_field[7] = "$2"; $secure_field[8] = ""; } if ( $card_types =~ /(failure_url\=)(.+?)(,|\n|$)/i ) { $secure_field[27] = "failure_url"; $custom_processor_field[8] = "$2"; $secure_field[9] = ""; } } elsif ( $path5 =~ /(beanstream\.com)/i ) { @secure_field = ("", "trnAmount", "MerchantName", "merchant_Id", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "approvedPage", "declinedPage", "trnOrderNumber", "ordName", "ordAddress1", "ordCity", "ordProvince", "ordPostalCode", "ordCountry", "ordPhoneNumber", "ordEmailAddress", "approvedPage", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; $total =~ s/ //g; $secure_field[20] = "trnCardOwner"; $custom_processor_field[1] = "$FORM{'name2'}"; } elsif ( $path5 =~ /(psigate99999999999\.com)/i ) { @secure_field = ("", "fulltotal", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ThanksURL", "NoThanksURL", "Userid", "Bname", "Baddr1", "Bcity", "Bstate", "Bzip", "Bcountry", "Phone", "Email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[50] = "company"; } elsif ( $path5 =~ /(psigate\.com)/i ) { @secure_field = ("", "SubTotal", "MerchantName", "StoreKey", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "ThanksURL", "NoThanksURL", "OrderID", "Bname", "Baddress1", "Bcity", "Bprovince", "Bpostalcode", "Bcountry", "Phone", "Email", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "Bcompany"; $total =~ s/ //g; } elsif ( $path5 =~ /(cambist\.com)/i || $path5 =~ /ssl(.{0,3})\.pl/i || $path5 =~ /ssl(.{0,3})\.cgi/i || $path5 =~ /ssl(.{0,3})\.php/i  || $path5 =~ /(cart\.pl)/i || $path5 =~ /(cart\.cgi)/i) { @secure_field = ("", "fulltotal", "MerchantName", "MerchantID", "MerchantEmail", "MerchantFont", "MerchantFontColor", "MerchantBgrdColor", "MerchantApprovedURL", "MerchantUnApprovedURL", "customerid", "BillName", "BillStreet", "BillCity", "BillState", "BillZip", "BillCountry", "BillPhone", "BillEmail", "MerchantReturnURL", "", "", "", "", ""); $secure_field[49] = "ssl_logo_url"; $secure_field[50] = "company"; $total =~ s/ //g; if ( $card_types =~ /(Language\=)(.+?)(,|\n|$)/i ) { $secure_field[20] = "Language"; $custom_processor_field[1] = "$2"; } if ( $card_types =~ /(AVSVerify)/i ) { $secure_field[21] = "AVSVerify"; $custom_processor_field[2] = "Y"; } if ( $card_types =~ /(book)/i ) { $secure_field[22] = "TransactionType"; $custom_processor_field[3] = "book"; } if ( $card_types =~ /(UseCVV2\=)(.+?)(,|\n|$)/i ) { $secure_field[23] = "UseCVV2"; $custom_processor_field[4] = "$2"; } $secure_field[24] = "CardTypesAccepted"; $custom_processor_field[5] = ""; if ( $card_types =~ /(Visa)/i ) { $custom_processor_field[5] .= "Visa,"; } if ( $card_types =~ /(MasterCard)/i ) { $custom_processor_field[5] .= "MasterCard,"; } if ( $card_types =~ /(Amex)/i ) { $custom_processor_field[5] .= "Amex,"; } if ( $card_types =~ /(Discover)/i ) { $custom_processor_field[5] .= "Discover,"; } } else { print "Location: http://www.dansie.net/new_processor.html\n\n"; exit; } } sub log_it { open(LOGIT,">>$logit_path"); print LOGIT "$_[0]\n"; close (LOGIT); } sub log_ip { my ($ip_log,@lines,$ip,$deny,$date,$maximum_allow); ($ip_log,$maximum_allow,$date) = @_; open(FILE,"$ip_log"); @lines=<FILE>; close(FILE); $deny = 0; if (!$ENV{'REMOTE_HOST'}) { $ENV{'REMOTE_HOST'} = "$ENV{'REMOTE_ADDR'}"; } foreach $ip (@lines) { chomp($ip); if ( $ENV{'REMOTE_HOST'} eq $ip ) { $deny++; } } chomp($lines[0]); if ( $lines[0] ne "$date" ) { open(FILE,">$ip_log"); print FILE "$date\n"; close(FILE); } if ( $deny >= $maximum_allow ) { &diagnostics; &header; print "<CENTER><H3>You have tripped a security feature of the shopping cart that is designed to thwart bot attacks.</H3></CENTER><BR>"; print "<UL><LI>Merchants, see Personal Variable #88 and 89 in the <A HREF=\"http://www.dansie.net/cart_readme.html\">ReadMe</A> for details.<BR> <LI>If you are shopping, please contact the merchant and let them know of this error.<BR> </UL><BR>"; &footer; exit; } open(FILE,">>$ip_log"); print FILE "$ENV{'REMOTE_HOST'}\n"; close(FILE); } sub denial_of_access_log { $deny_access_log_path = "$vars"; $a = ""; until ($a eq "/" || $deny_access_log_path eq "") { $a = chop($deny_access_log_path); } $deny_access_log_path = "$deny_access_log_path/deny_access_log.dat"; $ip_log_date = localtime(time); $ip_log_date =~ s/(.+?)(\s)(\d\d:\d\d:\d\d)(.*)$/$1/; if ($max_hits_deny_access) { &log_ip($deny_access_log_path,$max_hits_deny_access,$ip_log_date); } } sub check_on_limited_quantity_inv_summary { if ( ( -M "$limited_dir/limited.dat" < 1 ) && ( ( -M "$limited_quantity_inv_summary_last_emailed" > 1 ) || ( !-e "$limited_quantity_inv_summary_last_emailed") ) ) { open(FLAGFILE,">$limited_quantity_inv_summary_last_emailed"); close(FLAGFILE); &email_limited_quantity_inv_summary; } } sub email_limited_quantity_inv_summary { foreach $limited_item (@limited) { ($limited_item_name,$limited_remaining_in_stock) = split(/\|/,$limited_item); $limited{"$limited_item_name"} = $limited_remaining_in_stock; } $myemail = $myemail[0]; while($myemail =~ / /) { chop($myemail); } if ($myemail !~ /^(.+)(\@)(.+)(\.)(.+)$/) { $myemail = ""; } if ( $mailprog eq "windmail -t" ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $mailprog =~ /(cgimail)$/ ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $mailprog =~ /(-t)/ ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } elsif ( $no_f_switch ) { open (MAIL, "|$mailprog"); $sendmail_command = "open (MAIL, \"|$mailprog\");"; } else { open (MAIL, "|$mailprog $myemail"); $sendmail_command = "open (MAIL, \"|$mailprog $myemail\");"; } print MAIL "To: $myemail\n"; print MAIL "From: $myemail\n"; print MAIL "Subject: Limited Quantity Inventory Summary\n\n"; print MAIL "Limited Quantity Inventory Summary from the limited.dat file of the Dansie Shopping Cart\n\n"; foreach $limited (sort { $limited{$a} <=> $limited{$b} } keys %limited) { print MAIL "$limited - $limited{$limited}\n"; } print MAIL "\n\n"; close(MAIL); }
